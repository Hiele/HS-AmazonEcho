# -*- coding: iso8859-1 -*-
## -----------------------------------------------------
## Amazon Echo (13626)   ### V0.2
##
## erstellt am: 2016-12-12 08:42
## -----------------------------------------------------
## Copyright © 2016, Werner Lindbüchl, All rights reserved.
##
## This program is free software; you can redistribute it and/or modify it under the terms
## of the GNU General Public License as published by the Free Software Foundation; either
## version 3 of the License, or (at your option) any later version.
##
## This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
## without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
## See the GNU General Public License for more details.
##
## You should have received a copy of the GNU General Public License along with this program;
## if not, see <http://www.gnu.de/documents/gpl-3.0.de.html>.

## -- 
## --  

#5000|"Text"|Remanent(1/0)|Anz.Eingänge|.n.|Anzahl Ausgänge|.n.|.n.
5000|"Weitere Bausteine\Amazon Echo (13626)_V0.2"|1|5|"E1 Https-Server Start/Stop"|"E2 Https-Server Port"|"E3 Access Token"|"E4 Loglevel 0=Off, 1=Error, 2=Warn, 3=Info, 4=Debug"|"E5 Clear Log"|1|"A1 Unauthorized Access Counter"|"V0.2"

#5001|Anzahl Eingänge|Ausgänge|Offset|Speicher|Berechnung bei Start
5001|5|1|1|2|1

# Eingaenge
#5002|Index Eingang|Default Wert|0=numerisch 1=alphanummerisch
5002|1|1|0	#* E1 Https-Server Start/Stop 
5002|2|0|0	#* E2 Https-Server Port 
5002|3|0|1	#* E3 Access Token 
5002|4|2|0	#* E4 LogLevel 
5002|5|0|0	#* E5 Clear Log 

# Speicher
#5003|Speicher|Initwert|Remanent
5003|1||0		  #* 
5003|2||1		  #* 

# Ausgaenge
#5004|ausgang|Initwert|runden binär (0/1)|typ (1-send/2-sbc)|0=numerisch 1=alphanummerisch
5004|1|0|0|1|0 #* A1 Unauthorized Access Counter

#################################################

5012|0|"EI"|"eval(compile(__import__('base64').decodestring('CmlmIEVJPT0xOgogIGdsb2JhbCBhc0RpY3QKICBkZWYgYXNEaWN0KG8pOgogICAgICByZXR1cm4gby5fX2RpY3RfXwogIGdsb2JhbCBIVFRQU2VydmVyCiAgZ2xvYmFsIEJhc2VIVFRQUmVxdWVzdEhhbmRsZXIKICBmcm9tIEJhc2VIVFRQU2VydmVyIGltcG9ydCBIVFRQU2VydmVyLEJhc2VIVFRQUmVxdWVzdEhhbmRsZXIKICBnbG9iYWwgVGhyZWFkaW5nTWl4SW4KICBmcm9tIFNvY2tldFNlcnZlciBpbXBvcnQgVGhyZWFkaW5nTWl4SW4KICBnbG9iYWwganNvbgogIGltcG9ydCBqc29uCiAgZ2xvYmFsIEFtYXpvbkVjaG8KICBjbGFzcyBBbWF6b25FY2hvKFRocmVhZGluZ01peEluLCBIVFRQU2VydmVyKToKICAgIEhTID0gVHJ1ZQogICAgREVMQVkgPSAyMAogICAgTUlOX0ZJUk1XQVJFX1ZFUlNJT04gPSA0LjIKICAgIGlmIEhTOgogICAgICBQQVRIX0JBU0UgPSAiL3RtcC8iCiAgICBlbHNlOgogICAgICBQQVRIX0JBU0UgPSAiIgogICAgRklMRU5BTUVfQ0VSVCA9ICJhbWF6b25FY2hvU1NMLmNlcnQiCiAgICBGSUxFUEFUSF9DRVJUID0gUEFUSF9CQVNFICsgRklMRU5BTUVfQ0VSVAogICAgRklMRU5BTUVfTE9HID0gIjEzNjI2LmxvZyIKICAgIEZJTEVQQVRIX0xPRyA9IFBBVEhfQkFTRSArIEZJTEVOQU1FX0xPRwogICAgVVJMX0JBU0UgPSAiYW1hem9uRWNoby8iCiAgICBVUkxfU0hPV19TU0wgPSBVUkxfQkFTRSArICJzc2xDZXJ0Lmh0bSIKICAgIFVSTF9TSE9XX0xPRyA9IFVSTF9CQVNFICsgImxvZy5odG0iCiAgICBhbGxvd19yZXVzZV9hZGRyZXNzID0gVHJ1ZQogICAgZGVmIF9faW5pdF9fKHNlbGYsIGxvY2Fscyk6CiAgICAgIHNlbGYubG9jYWxzID0gbG9jYWxzOwogICAgICBzZWxmLmxvZ2lrID0gbG9jYWxzWydwSXRlbSddCiAgICAgIHNlbGYuTUMgPSBzZWxmLmxvZ2lrLk1DCiAgICAgIHNlbGYuaHNJcCA9IHNlbGYuTUMuRXRoZXJuZXQuSVBBZHIKICAgICAgc2VsZi5oc1BvcnQgPSBzZWxmLk1DLkV0aGVybmV0LklQUG9ydAogICAgICBFTiA9IGxvY2Fsc1snRU4nXQogICAgICBzZWxmLlNUQVJUID0gRU5bMV0KICAgICAgc2VsZi5wb3J0ID0gaW50KEVOWzJdKQogICAgICBzZWxmLmFjY2Vzc1Rva2VuID0gRU5bM10uZGVjb2RlKCdpc284ODU5LTEnKQogICAgICBzZWxmLmxvZ0xldmVsID0gRU5bNF0KICAgICAgc2VsZi5pbml0aWFsaXplZCA9IEZhbHNlCiAgICAgIHNlbGYuY2VydFRleHQgPSAiIgogICAgICBzZWxmLnNlcnZlclRocmVhZCA9IE5vbmUKICAgICAgc2VsZi51bmF1dGhvcml6ZWRDb3VudGVyID0gMAogICAgICBzZWxmLnZlcnNpb24gPSB1J0FtYXpvbiBFY2hvIFNlcnZpY2UgVjAuMiB2b20gMTIuMTIuMjAxNiAwODo0MiAgLSAgKFB5dGhvbiBWZXJzaW9uOiAnICsgc2VsZi5fZ2V0UHl0aG9uVmVyc2lvbigpICsgJyBEZWZhdWx0IEVuY29kaW5nOicgKyBzZWxmLl9nZXREZWZhdWx0RW5jb2RpbmcoKSArICcpJwogICAgICB0cnk6CiAgICAgICAgaW1wb3J0IGNvZGVjcwogICAgICAgIHNlbGYubG9nRmlsZSA9IGNvZGVjcy5vcGVuKHNlbGYuRklMRVBBVEhfTE9HLCAidysiLCAiSVNPLTg4NTktMSIpCiAgICAgICAgc2VsZi5sb2coc2VsZi52ZXJzaW9uKQogICAgICAgIHNlbGYuZmlybXdhcmVWZXJzaW9uID0gc2VsZi5fZ2V0RmlybXdhcmVWZXJzaW9uKCkKICAgICAgICBzZWxmLmZpcm13YXJlT2sgPSBzZWxmLmZpcm13YXJlVmVyc2lvbiA+PSBzZWxmLk1JTl9GSVJNV0FSRV9WRVJTSU9OCiAgICAgICAgaWYgbm90IHNlbGYuZmlybXdhcmVPazoKICAgICAgICAgIHNlbGYubG9nKCJTb3JyeSwgeW91ciBHaXJhLUhvbWVzZXJ2ZXIgRmlybXdhcmUgaXMgbm90IHN1cHBvcnRlZCAtIGZvdW5kID0gJ3swfScgbmVlZGVkID49ICd7MX0nLiIsIHNlbGYuZmlybXdhcmVWZXJzaW9uLCBzZWxmLk1JTl9GSVJNV0FSRV9WRVJTSU9OKQogICAgICAgICAgcmV0dXJuCiAgICAgICAgc2VsZi5sb2coIkluaXRpYXRlIHswfSBzZWNvbmRzIGRlbGF5IGZvciBIUyB0byBiZSBmdWxseSB1cCBhbmQgcnVubmluZyAuLi4iLCBBbWF6b25FY2hvLkRFTEFZKQogICAgICAgIEFtYXpvbkVjaG9XZWJDYWxsYmFjayhzZWxmLmxvZ2lrLCBzZWxmLCBzZWxmLndlYkNhbGxiYWNrU1NMQ2VydCwgc2VsZi5VUkxfU0hPV19TU0wpCiAgICAgICAgQW1hem9uRWNob1dlYkNhbGxiYWNrKHNlbGYubG9naWssIHNlbGYsIHNlbGYud2ViQ2FsbGJhY2tMb2csIHNlbGYuVVJMX1NIT1dfTE9HKQogICAgICBleGNlcHQ6CiAgICAgICAgc2VsZi5NQy5EZWJ1Zy5zZXRFcnIoc3lzLmV4Y19pbmZvKCksIkFtYXpvbkVjaG86IF9faW5pdF9fKCkgZmFpbGVkLiIpCiAgICBkZWYgX2dldFB5dGhvblZlcnNpb24oc2VsZik6CiAgICAgIGltcG9ydCBzeXMKICAgICAgcmV0dXJuIHN0cihzeXMudmVyc2lvbl9pbmZvKQogICAgZGVmIF9nZXREZWZhdWx0RW5jb2Rpbmcoc2VsZik6CiAgICAgIGltcG9ydCBzeXMKICAgICAgcmV0dXJuIHN0cihzeXMuZ2V0ZGVmYXVsdGVuY29kaW5nKCkpCiAgICBkZWYgX2dldEZpcm13YXJlVmVyc2lvbihzZWxmKToKICAgICAgaW1wb3J0IHJlCiAgICAgIF9maXJtd2FyZSA9IHJlLmZpbmRhbGwoIl4oXGQrXC5cZCspIiwgc2VsZi5NQy5EZWJ1Zy5WZXJzaW9uKQogICAgICBpZiBub3QgX2Zpcm13YXJlOgogICAgICAgIF9maXJtd2FyZSA9IFsiMC4wIl0KICAgICAgcmV0dXJuIGZsb2F0KF9maXJtd2FyZVswXSkKICAgIGRlZiBpbml0KHNlbGYpOgogICAgICBpZiBub3Qgc2VsZi5maXJtd2FyZU9rOgogICAgICAgIHJldHVybgogICAgICB0cnk6CiAgICAgICAgc2VsZi5sb2coIkluaXRpYWxpemUgQW1hem9uIEVjaG8gU2VydmljZS4iKQogICAgICAgIHNlbGYuY2VydFRleHQgPSBzZWxmLmdldFNTTENlcnQoc2VsZi5oc0lwLCBzZWxmLmhzUG9ydCwgc2VsZi5GSUxFTkFNRV9DRVJUKQogICAgICAgIGlmIHNlbGYuY2VydFRleHQgIT0gIiI6CiAgICAgICAgICB0cnk6CiAgICAgICAgICAgIHNlbGYuY2VydFRleHQuaW5kZXgoIlByb2MtVHlwZTogNCxFTkNSWVBURUQiKQogICAgICAgICAgICBzZWxmLmxvZygiU1NMIGNlcnRpZmljYXRlcyB3aGljaCBuZWVkcyBhIHBhc3NwaHJhc2UgYXJlIG5vdCBzdXBwb3J0ZWQuIFBsZWFzZSByZW1vdmUgcGFzc3BocmFzZSBhbmQgdXBsb2FkIGFnYWluLiIpCiAgICAgICAgICAgIHNlbGYuY2VydFRleHQgPSAiIgogICAgICAgICAgZXhjZXB0IFZhbHVlRXJyb3I6CiAgICAgICAgICAgIHNlbGYubG9nKCJTU0wgY2VydGlmaWNhdGUgbG9hZGVkIHN1Y2Nlc3NmdWxseSAtIHdyaXRpbmcgaXQgdG8gZmlsZSAnezB9Jy4iLCBzZWxmLkZJTEVQQVRIX0NFUlQpCiAgICAgICAgICAgIHdpdGggb3BlbihzZWxmLkZJTEVQQVRIX0NFUlQsICJ3YiIpIGFzIG91dHB1dDoKICAgICAgICAgICAgICBvdXRwdXQud3JpdGUoc2VsZi5jZXJ0VGV4dCkKICAgICAgICBzZWxmLmluaXRfZGVidWdfZW50cnkoKTsKICAgICAgICBzZWxmLnJlYWRBcHBsaWFuY2VzQ29uZigpCiAgICAgICAgc2VsZi5pbml0aWFsaXplZCA9IFRydWUKICAgICAgICBpZiBzZWxmLlNUQVJUOgogICAgICAgICAgc2VsZi5zdGFydCgpCiAgICAgIGV4Y2VwdDoKICAgICAgICBzZWxmLk1DLkRlYnVnLnNldEVycihzeXMuZXhjX2luZm8oKSwiQW1hem9uRWNobzogaW5pdCgpIGZhaWxlZC4iKQogICAgZGVmIHN0YXJ0KHNlbGYpOgogICAgICBpZiBub3Qgc2VsZi5maXJtd2FyZU9rOgogICAgICAgIHJldHVybgogICAgICB0cnk6CiAgICAgICAgaWYgbm90IHNlbGYuaW5pdGlhbGl6ZWQ6CiAgICAgICAgICBzZWxmLlNUQVJUID0gVHJ1ZQogICAgICAgICAgcmV0dXJuCiAgICAgICAgaWYgc2VsZi5zZXJ2ZXJUaHJlYWQgaXMgTm9uZToKICAgICAgICAgIHNlbGYubG9nKCJTdGFydGluZyBBbWF6b24gRWNobyBTZXJ2aWNlLiIpCiAgICAgICAgICBzZWxmLnVuYXV0aG9yaXplZENvdW50ZXIgPSAwIAogICAgICAgICAgSFRUUFNlcnZlci5fX2luaXRfXyhzZWxmLCAoc2VsZi5oc0lwLCBzZWxmLnBvcnQpLCBzZWxmLkhUVFBSZXF1ZXN0SGFuZGxlcikKICAgICAgICAgIGlmIHNlbGYuY2VydFRleHQgIT0gIiI6CiAgICAgICAgICAgIGltcG9ydCBzc2wKICAgICAgICAgICAgc2VsZi5zb2NrZXQgPSBzc2wud3JhcF9zb2NrZXQoc2VsZi5zb2NrZXQsIGNlcnRmaWxlPXNlbGYuRklMRVBBVEhfQ0VSVCwgc2VydmVyX3NpZGU9VHJ1ZSkKICAgICAgICAgIGZyb20gaHNfcXVldWUgaW1wb3J0IGhzX3RocmVhZGluZyBhcyB0aHJlYWRpbmcKICAgICAgICAgIHNlbGYuc2VydmVyVGhyZWFkID0gdGhyZWFkaW5nLlRocmVhZCh0YXJnZXQ9c2VsZi5zZXJ2ZV9mb3JldmVyLCBuYW1lPSdhbWF6b25fZWNob19zZXJ2ZXInKQogICAgICAgICAgc2VsZi5zZXJ2ZXJUaHJlYWQuZGFlbW9uID0gVHJ1ZQogICAgICAgICAgc2VsZi5zZXJ2ZXJUaHJlYWQuc3RhcnQoKQogICAgICAgIGVsc2U6CiAgICAgICAgICBzZWxmLmxvZygiQW1hem9uIEVjaG8gU2VydmljZSBhbHJlYWR5IHN0YXJ0ZWQuIikKICAgICAgZXhjZXB0OgogICAgICAgIHNlbGYuTUMuRGVidWcuc2V0RXJyKHN5cy5leGNfaW5mbygpLCJBbWF6b25FY2hvOiBzdGFydCgpIGZhaWxlZC4iKQogICAgZGVmIHN0b3Aoc2VsZik6CiAgICAgIGlmIG5vdCBzZWxmLmZpcm13YXJlT2s6CiAgICAgICAgcmV0dXJuCiAgICAgIHRyeToKICAgICAgICBpZiBub3Qgc2VsZi5pbml0aWFsaXplZDoKICAgICAgICAgIHNlbGYuU1RBUlQgPSBmYWxzZQogICAgICAgICAgcmV0dXJuCiAgICAgICAgaWYgc2VsZi5zZXJ2ZXJUaHJlYWQgaXMgbm90IE5vbmU6CiAgICAgICAgICBIVFRQU2VydmVyLnNodXRkb3duKHNlbGYpCiAgICAgICAgICBzZWxmLnNvY2tldC5jbG9zZSgpCiAgICAgICAgICBzZWxmLnNlcnZlclRocmVhZCA9IE5vbmUKICAgICAgICBzZWxmLmxvZygiQW1hem9uIEVjaG8gU2VydmljZSBzdG9wcGVkLiIpCiAgICAgIGV4Y2VwdDoKICAgICAgICBzZWxmLk1DLkRlYnVnLnNldEVycihzeXMuZXhjX2luZm8oKSwiQW1hem9uRWNobzogc3RvcCgpIGZhaWxlZC4iKQogICAgZGVmIHJlYWRBcHBsaWFuY2VzQ29uZihzZWxmKToKICAgICAgc2VsZi5kZWJ1ZygicmVhZEFwcGxpYW5jZXNDb25mKCkiKQogICAgICB0cnk6CiAgICAgICAgc2VsZi5hcHBsaWFuY2VzID0gTm9uZQogICAgICAgIGFwcGxpYW5jZXNUZXh0ID0gc2VsZi5sb2NhbHNbJ1NOJ11bMl0KICAgICAgICBpZiBhcHBsaWFuY2VzVGV4dCBpcyBub3QgTm9uZSBhbmQgYXBwbGlhbmNlc1RleHQuc3RyaXAoKSAhPSAiIjoKICAgICAgICAgIHRyeToKICAgICAgICAgICAgc2VsZi5hcHBsaWFuY2VzID0ganNvbi5sb2FkcyhhcHBsaWFuY2VzVGV4dCwgZW5jb2Rpbmc9InV0Zi04IikKICAgICAgICAgIGV4Y2VwdCBVbmljb2RlRGVjb2RlRXJyb3I6CiAgICAgICAgICAgIHNlbGYuaW5mbygiVHJ5aW5nIHRvIGNvbnZlcnQgYXBwbGlhbmNlcyBjb25maWd1cmF0aW9uIGZvcm0gJ2lzbzg4NTktMScgdG8gJ3V0Zi04Jy4iKQogICAgICAgICAgICBhcHBsaWFuY2VzVGV4dCA9IGFwcGxpYW5jZXNUZXh0LmRlY29kZSgnaXNvODg1OS0xJykuZW5jb2RlKCd1dGYtOCcpCiAgICAgICAgICAgIHNlbGYuYXBwbGlhbmNlcyA9IGpzb24ubG9hZHMoYXBwbGlhbmNlc1RleHQsIGVuY29kaW5nPSJ1dGYtOCIpCiAgICAgICAgICAgIHNlbGYuaW5mbygiQXBwbGlhbmNlcyBjb25maWd1cmF0aW9uIHN1Y2Nlc3NmdWxseSBjb252ZXJ0ZWQuIikKICAgICAgICAgICAgc2VsZi5zYXZlQXBwbGlhbmNlc0NvbmYoYXBwbGlhbmNlc1RleHQpCiAgICAgICAgICBzZWxmLmluZm8oIkFwcGxpYW5jZXMgY29uZmlndXJhdGlvbiBzdWNjZXNzZnVsbHkgbG9hZGVkLiIpCiAgICAgICAgZWxzZToKICAgICAgICAgIHNlbGYud2FybigiQXBwbGlhbmNlcyBjb25maWd1cmF0aW9uIGlzIGVtcHR5LiIpCiAgICAgIGV4Y2VwdDoKICAgICAgICBzZWxmLmV4YygiSnNvbiBleGNlcHRpb24gd2hpbGUgcGFyc2luZyBhcHBsaWFuY2VzIGNvbmZpZ3VhcnRpb246IikKICAgIGRlZiBzYXZlQXBwbGlhbmNlc0NvbmYoc2VsZiwgYXBwbGlhbmNlc1RleHQpOgogICAgICBzZWxmLmluZm8oIlRyeWluZyB0byBzYXZlIGFwcGxpYW5jZXMgY29uZmlndWFydGlvbi4iKQogICAgICBtc2cgPSAiIgogICAgICB0cnk6CiAgICAgICAgaWYgYXBwbGlhbmNlc1RleHQgIT0gIiI6CiAgICAgICAgICBzZWxmLmFwcGxpYW5jZXMgPSBqc29uLmxvYWRzKGFwcGxpYW5jZXNUZXh0LCBlbmNvZGluZz0idXRmLTgiKQogICAgICAgICAgc2VsZi5pbmZvKCJBcHBsaWFuY2VzIGNvbmZpZ3VyYXRpb24gc3VjY2Vzc2Z1bGx5IHNhdmVkLiIpCiAgICAgICAgZWxzZToKICAgICAgICAgIHNlbGYuYXBwbGlhbmNlcyA9IE5vbmUKICAgICAgICAgIHNlbGYud2FybigiQXBwbGlhbmNlcyBjb25maWd1cmF0aW9uIHdhcyBlbXB0eS4iKQogICAgICAgIHNlbGYubG9naWsuU3BlaWNoZXJXZXJ0WzFdID0gYXBwbGlhbmNlc1RleHQKICAgICAgICBzZWxmLk1DLlNpY2hRdWV1ZS5wdXQoWzEwMCwgc2VsZi5sb2dpaywgc2VsZi5sb2dpay5TcGVpY2hlcldlcnRdKQogICAgICBleGNlcHQgVmFsdWVFcnJvcjoKICAgICAgICBzZWxmLmV4YygiSnNvbiBleGNlcHRpb24gd2hpbGUgcGFyc2luZyBhcHBsaWFuY2VzIGNvbmZpZ3VhcnRpb246IikKICAgICAgICBtc2cgPSAiRmFpbGVkIHRvIHBhcnNlIGFwcGxpYW5jZXMgY29uZmlndXJhdGlvbi4iCiAgICAgIHJldHVybiBtc2cKICAgIGRlZiBkaXNjb3Zlcnkoc2VsZiwgbWVzc2FnZUlkKToKICAgICAgcmVzcG9uc2VPYmplY3QgPSBBbWF6b25FY2hvLkRpc2NvdmVyeVJlc3BvbnNlKG1lc3NhZ2VJZCkKICAgICAgaWYgc2VsZi5hcHBsaWFuY2VzIGlzIG5vdCBOb25lOgogICAgICAgIGlkID0gMAogICAgICAgIGZvciBkZXZpY2UgaW4gc2VsZi5hcHBsaWFuY2VzOgogICAgICAgICAgcm9vbSA9IGRldmljZS5nZXQoJ3Jvb20nKQogICAgICAgICAgaWQgKz0gMQogICAgICAgICAgaWRTdHIgPSBkZXZpY2UuZ2V0KCdpZCcpCiAgICAgICAgICBpZiBpZFN0ciBpcyBOb25lOgogICAgICAgICAgICBpZFN0ciA9IHN0cihpZCkKICAgICAgICAgIGpkID0gMAogICAgICAgICAgZm9yIGFwcGxpYW5jZSBpbiBkZXZpY2UuZ2V0KCdhcHBsaWFuY2VzJyk6CiAgICAgICAgICAgIGpkICs9IDEKICAgICAgICAgICAgdHlwZSA9ICdTd2l0Y2hhYmxlJwogICAgICAgICAgICBwZXJjZW50ID0gYXBwbGlhbmNlLmdldCgncGVyY2VudCcpOwogICAgICAgICAgICBpZiBwZXJjZW50IGlzIG5vdCBOb25lOgogICAgICAgICAgICAgIHR5cGUgPSAnTGlnaHRpbmcnCiAgICAgICAgICAgIGlmIHJvb20gaXMgbm90IE5vbmUgYW5kIHJvb20gIT0gIiI6CiAgICAgICAgICAgICAgaWYgamQgPT0gMToKICAgICAgICAgICAgICAgIHRhcmdldFRlbXBlcmF0dXJlID0gZGV2aWNlLmdldCgndGFyZ2V0VGVtcGVyYXR1cmUnKQogICAgICAgICAgICAgICAgaWYgdGFyZ2V0VGVtcGVyYXR1cmUgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICAgIGRpc2NvdmVyeUFwcGxpYW5jZSA9IEFtYXpvbkVjaG8uRGlzY292ZXJ5QXBwbGlhbmNlKGlkU3RyLCByb29tLCAiVGhlcm1vc3RhdCIpCiAgICAgICAgICAgICAgICAgIHJlc3BvbnNlT2JqZWN0LmFkZEFwcGxpYW5jZShkaXNjb3ZlcnlBcHBsaWFuY2UpCiAgICAgICAgICAgICAgbmFtZSA9IGFwcGxpYW5jZS5nZXQoJ25hbWUnKQogICAgICAgICAgICAgIGlmIG5hbWUgaXMgTm9uZToKICAgICAgICAgICAgICAgIG5hbWUgPSByb29tCiAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIG5hbWUgPSByb29tICsgIiAiICsgbmFtZQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgIG5hbWUgPSBhcHBsaWFuY2UuZ2V0KCduYW1lJykKICAgICAgICAgICAgICBpZiBuYW1lIGlzIE5vbmU6CiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICBqZFN0ciA9IGFwcGxpYW5jZS5nZXQoJ2lkJykKICAgICAgICAgICAgaWYgamRTdHIgaXMgTm9uZToKICAgICAgICAgICAgICBqZFN0ciA9IHN0cihqZCkKICAgICAgICAgICAgZGlzY292ZXJ5QXBwbGlhbmNlID0gQW1hem9uRWNoby5EaXNjb3ZlcnlBcHBsaWFuY2UoaWRTdHIgKyAiXyIgKyBqZFN0ciwgbmFtZSwgdHlwZSkKICAgICAgICAgICAgcmVzcG9uc2VPYmplY3QuYWRkQXBwbGlhbmNlKGRpc2NvdmVyeUFwcGxpYW5jZSkKICAgICAgICAgICAgYWxpYXNlcyA9IGFwcGxpYW5jZS5nZXQoJ2FsaWFzZXMnKTsKICAgICAgICAgICAgaWYgYWxpYXNlcyBpcyBub3QgTm9uZToKICAgICAgICAgICAgICBrZCA9IDAKICAgICAgICAgICAgICBmb3IgYWxpYXMgaW4gYWxpYXNlczoKICAgICAgICAgICAgICAgIGtkICs9IDEKICAgICAgICAgICAgICAgIGRpc2NvdmVyeUFwcGxpYW5jZSA9IEFtYXpvbkVjaG8uRGlzY292ZXJ5QXBwbGlhbmNlKGlkU3RyICsgIl8iICsgamRTdHIgKyAiXyIgKyBzdHIoa2QpLCBhbGlhcywgdHlwZSkKICAgICAgICAgICAgICAgIHJlc3BvbnNlT2JqZWN0LmFkZEFwcGxpYW5jZShkaXNjb3ZlcnlBcHBsaWFuY2UpCiAgICAgIHNlbGYuaW5mbygiRGlzY292ZXJ5IGZvdW5kIHswfSBhcHBsaWFuY2VzLiAobWVzc2FnZUlkPSd7MX0nKS4iLCByZXNwb25zZU9iamVjdC5nZXROck9mQXBwbGlhbmNlcygpLCBtZXNzYWdlSWQpCiAgICAgIHJldHVybiByZXNwb25zZU9iamVjdAogICAgZGVmIGNvbnRyb2woc2VsZiwgbWVzc2FnZUlkLCBhcHBsaWFuY2VJZCwgcmVxdWVzdCwgdmFsdWUpOgogICAgICByZXNwb25zZU9iamVjdCA9IEFtYXpvbkVjaG8uQ29udHJvbFJlc3BvbnNlKG1lc3NhZ2VJZCkKICAgICAgYXBwbGlhbmNlID0gc2VsZi5maW5kQXBwbGlhbmNlKGFwcGxpYW5jZUlkKQogICAgICBpZiBhcHBsaWFuY2UgaXMgbm90IE5vbmU6CiAgICAgICAgb25WYWx1ZSA9IDEuMAogICAgICAgIG9mZlZhbHVlID0gMC4wCiAgICAgICAgb25PZmYgPSBhcHBsaWFuY2UuZ2V0KCdvbk9mZicpCiAgICAgICAgcGVyY2VudCA9IGFwcGxpYW5jZS5nZXQoJ3BlcmNlbnQnKQogICAgICAgIHRhcmdldFRlbXBlcmF0dXJlID0gYXBwbGlhbmNlLmdldCgndGFyZ2V0VGVtcGVyYXR1cmUnKQogICAgICAgIGlmIG9uT2ZmIGlzIE5vbmUgYW5kIHBlcmNlbnQgaXMgTm9uZSBhbmQgdGFyZ2V0VGVtcGVyYXR1cmUgaXMgTm9uZToKICAgICAgICAgIHNlbGYuZXJyb3IodSJDb250cm9sOiBhcHBsaWFuY2Ugd2l0aCBpZD0nezB9JyBoYXMgbmVpdGhlciAnb25PZmYnIG5vciAncGVyY2VudCcgbm9yICd0YXJnZXRUZW1wZXJhdHVyZScgYXR0cmlidXRlLiAobWVzc2FnZUlkPSd7MX0nKSIsIGFwcGxpYW5jZUlkLCBtZXNzYWdlSWQpCiAgICAgICAgICByZXNwb25zZU9iamVjdC5zZXROYW1lKCJOb1N1Y2hUYXJnZXRFcnJvciIpCiAgICAgICAgICByZXR1cm4gcmVzcG9uc2VPYmplY3QKICAgICAgICBvbk9mZktvID0gTm9uZQogICAgICAgIHBlcmNlbnRLbyA9IE5vbmUKICAgICAgICB0YXJnZXRUZW1wZXJhdHVyZUtvID0gTm9uZQogICAgICAgIGFwcGxpYW5jZVR5cGUgPSBOb25lCiAgICAgICAgaWYgb25PZmYgaXMgbm90IE5vbmU6CiAgICAgICAgICBhcHBsaWFuY2VUeXBlID0gIlN3aXRjaGFibGUiCiAgICAgICAgICBvbk9mZktvID0gc2VsZi5maW5kS28ob25PZmYpCiAgICAgICAgICBpZiBvbk9mZktvIGlzIE5vbmU6CiAgICAgICAgICAgIHNlbGYuZXJyb3IoIkNvbnRyb2w6IEtPLW9iamVjdCBmb3IgZ3JvdXAgYWRkcmVzcyBvbk9mZj0nezB9JyBjb3VsZCBub3QgYmUgZm91bmQuIChtZXNzYWdlSWQ9J3sxfScpIiwgb25PZmYsIG1lc3NhZ2VJZCkKICAgICAgICAgICAgcmVzcG9uc2VPYmplY3Quc2V0TmFtZSgiTm9TdWNoVGFyZ2V0RXJyb3IiKQogICAgICAgICAgICByZXR1cm4gcmVzcG9uc2VPYmplY3QKICAgICAgICAgIG9uT2ZmTmFtZSA9IG9uT2ZmS28uUlBDVGV4dC5kZWNvZGUoJ2lzbzg4NTktMScpCiAgICAgICAgaWYgcGVyY2VudCBpcyBub3QgTm9uZToKICAgICAgICAgIGFwcGxpYW5jZVR5cGUgPSAiTGlnaHRpbmciCiAgICAgICAgICBwZXJjZW50S28gPSBzZWxmLmZpbmRLbyhwZXJjZW50KQogICAgICAgICAgaWYgcGVyY2VudEtvIGlzIE5vbmU6CiAgICAgICAgICAgIHNlbGYuZXJyb3IoIkNvbnRyb2w6IEtPLW9iamVjdCBmb3IgZ3JvdXAgYWRkcmVzcyBwZXJjZW50PSd7MH0nIGNvdWxkIG5vdCBiZSBmb3VuZC4gKG1lc3NhZ2VJZD0nezF9JykiLCBwZXJjZW50LCBtZXNzYWdlSWQpCiAgICAgICAgICAgIHJlc3BvbnNlT2JqZWN0LnNldE5hbWUoIk5vU3VjaFRhcmdldEVycm9yIikKICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlT2JqZWN0CiAgICAgICAgICBwZXJjZW50TmFtZSA9IHBlcmNlbnRLby5SUENUZXh0LmRlY29kZSgnaXNvODg1OS0xJykKICAgICAgICBlbGlmIHRhcmdldFRlbXBlcmF0dXJlIGlzIG5vdCBOb25lOgogICAgICAgICAgYXBwbGlhbmNlVHlwZSA9ICJUaGVybW9zdGF0IgogICAgICAgICAgdGFyZ2V0VGVtcGVyYXR1cmVLbyA9IHNlbGYuZmluZEtvKHRhcmdldFRlbXBlcmF0dXJlKQogICAgICAgICAgaWYgdGFyZ2V0VGVtcGVyYXR1cmVLbyBpcyBOb25lOgogICAgICAgICAgICBzZWxmLmVycm9yKCJDb250cm9sOiBLTy1vYmplY3QgZm9yIGdyb3VwIGFkZHJlc3MgdGFyZ2V0VGVtcGVyYXR1cmU9J3swfScgY291bGQgbm90IGJlIGZvdW5kLiAobWVzc2FnZUlkPSd7MX0nKSIsIHRhcmdldFRlbXBlcmF0dXJlLCBtZXNzYWdlSWQpCiAgICAgICAgICAgIHJlc3BvbnNlT2JqZWN0LnNldE5hbWUoIk5vU3VjaFRhcmdldEVycm9yIikKICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlT2JqZWN0CiAgICAgICAgICB0YXJnZXRUZW1wZXJhdHVyZU5hbWUgPSB0YXJnZXRUZW1wZXJhdHVyZUtvLlJQQ1RleHQuZGVjb2RlKCdpc284ODU5LTEnKQogICAgICAgIGFwcGxpYW5jZVZhbHVlID0gYXBwbGlhbmNlLmdldCgnb25WYWx1ZScpCiAgICAgICAgaWYgYXBwbGlhbmNlVmFsdWUgaXMgbm90IE5vbmU6CiAgICAgICAgICB0cnk6CiAgICAgICAgICAgIG9uVmFsdWUgPSBmbG9hdChhcHBsaWFuY2VWYWx1ZSkKICAgICAgICAgIGV4Y2VwdCBWYWx1ZUVycm9yOgogICAgICAgICAgICBzZWxmLmVycm9yKHUiQ29udHJvbDogaWxsZWdhbCBkZWZhdWx0IHZhbHVlPSd7MH0nIChub3QgcGFyc2VhYmxlIGFzIGZsb2F0KSBmb3IgYXBwbGlhbmNlIHdpdGggaWQ9J3sxfScuIChtZXNzYWdlSWQ9J3syfScpIiwgYXBwbGlhbmNlVmFsdWUsIGFwcGxpYW5jZUlkLCBtZXNzYWdlSWQpCiAgICAgICAgICAgIHJlc3BvbnNlT2JqZWN0LnNldE5hbWUoIlVuc3VwcG9ydGVkVGFyZ2V0U2V0dGluZ0Vycm9yIikKICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlT2JqZWN0CiAgICAgICAgaWYgYXBwbGlhbmNlVHlwZSA9PSAiTGlnaHRpbmciOgogICAgICAgICAgaWYgcmVxdWVzdCA9PSAnVHVybk9uUmVxdWVzdCcgb3IgcmVxdWVzdCA9PSAnVHVybk9mZlJlcXVlc3QnOgogICAgICAgICAgICBzZWxmLmluZm8odSJDb250cm9sIGFwcGxpYW5jZSB3aXRoIGlkPSd7MH0nLCBuYW1lPSd7MX0nLCB0eXBlPSd7Mn0nLCByZXF1ZXN0PSd7M30nLCBtZXNzYWdlSWQ9J3s0fScuIiwgYXBwbGlhbmNlSWQsIG9uT2ZmTmFtZSwgYXBwbGlhbmNlVHlwZSwgcmVxdWVzdCwgbWVzc2FnZUlkKQogICAgICAgICAgICBpZiByZXF1ZXN0ID09ICdUdXJuT25SZXF1ZXN0JzoKICAgICAgICAgICAgICBzZWxmLl9LTlhTZXRWYWx1ZShvbk9mZktvLCBvblZhbHVlLCAiVHVybk9uQ29uZmlybWF0aW9uIiwgcmVzcG9uc2VPYmplY3QpCiAgICAgICAgICAgIGVsaWYgcmVxdWVzdCA9PSAnVHVybk9mZlJlcXVlc3QnOgogICAgICAgICAgICAgIHNlbGYuX0tOWFNldFZhbHVlKG9uT2ZmS28sIG9mZlZhbHVlLCAiVHVybk9mZkNvbmZpcm1hdGlvbiIsIHJlc3BvbnNlT2JqZWN0KQogICAgICAgICAgZWxzZToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgIHNlbGYuaW5mbyh1IkNvbnRyb2wgYXBwbGlhbmNlIHdpdGggaWQ9J3swfScsIG5hbWU9J3sxfScsIHR5cGU9J3syfScsIHJlcXVlc3Q9J3szfScsIG1lc3NhZ2VJZD0nezR9Jy4iLCBhcHBsaWFuY2VJZCwgcGVyY2VudE5hbWUsIGFwcGxpYW5jZVR5cGUsIHJlcXVlc3QsIG1lc3NhZ2VJZCkKICAgICAgICAgICAgICBpZiByZXF1ZXN0ID09ICdTZXRQZXJjZW50YWdlUmVxdWVzdCc6CiAgICAgICAgICAgICAgICBzZWxmLl9LTlhTZXRQZXJjZW50KHBlcmNlbnRLbywgZmxvYXQodmFsdWUpLCAiU2V0UGVyY2VudGFnZUNvbmZpcm1hdGlvbiIsIHJlc3BvbnNlT2JqZWN0KQogICAgICAgICAgICAgIGVsaWYgcmVxdWVzdCA9PSAnSW5jcmVtZW50UGVyY2VudGFnZVJlcXVlc3QnOgogICAgICAgICAgICAgICAgc2VsZi5fS05YQWRkUGVyY2VudChwZXJjZW50S28sIGZsb2F0KHZhbHVlKSwgMSwgIkluY3JlbWVudFBlcmNlbnRhZ2VDb25maXJtYXRpb24iLCByZXNwb25zZU9iamVjdCkKICAgICAgICAgICAgICBlbGlmIHJlcXVlc3QgPT0gJ0RlY3JlbWVudFBlcmNlbnRhZ2VSZXF1ZXN0JzoKICAgICAgICAgICAgICAgIHNlbGYuX0tOWEFkZFBlcmNlbnQocGVyY2VudEtvLCBmbG9hdCh2YWx1ZSksIC0xLCAiRGVjcmVtZW50UGVyY2VudGFnZUNvbmZpcm1hdGlvbiIsIHJlc3BvbnNlT2JqZWN0KQogICAgICAgICAgICBleGNlcHQgVmFsdWVFcnJvcjoKICAgICAgICAgICAgICBzZWxmLmVycm9yKHUiSWxsZWdhbCByZXF1ZXN0IHZhbHVlPSd7MH0nIChub3QgcGFyc2VhYmxlIGFzIGZsb2F0KSBmb3IgYXBwbGlhbmNlIHdpdGggaWQ9J3sxfScuIiwgdmFsdWUsIGFwcGxpYW5jZUlkKQogICAgICAgICAgICAgIHJlc3BvbnNlT2JqZWN0LnNldE5hbWUoIlVuc3VwcG9ydGVkVGFyZ2V0U2V0dGluZ0Vycm9yIikKICAgICAgICBlbGlmIGFwcGxpYW5jZVR5cGUgPT0gIlN3aXRjaGFibGUiOgogICAgICAgICAgc2VsZi5pbmZvKHUiQ29udHJvbCBhcHBsaWFuY2Ugd2l0aCBpZD0nezB9JywgbmFtZT0nezF9JywgdHlwZT0nezJ9JyByZXF1ZXN0PSd7M30nLCBtZXNzYWdlSWQ9J3s0fScuIiwgYXBwbGlhbmNlSWQsIG9uT2ZmTmFtZSwgYXBwbGlhbmNlVHlwZSwgcmVxdWVzdCwgbWVzc2FnZUlkKQogICAgICAgICAgaWYgcmVxdWVzdCA9PSAnVHVybk9uUmVxdWVzdCc6CiAgICAgICAgICAgIHNlbGYuX0tOWFNldFZhbHVlKG9uT2ZmS28sIG9uVmFsdWUsICJUdXJuT25Db25maXJtYXRpb24iLCByZXNwb25zZU9iamVjdCkKICAgICAgICAgIGVsaWYgcmVxdWVzdCA9PSAnVHVybk9mZlJlcXVlc3QnOgogICAgICAgICAgICBzZWxmLl9LTlhTZXRWYWx1ZShvbk9mZktvLCBvZmZWYWx1ZSwgIlR1cm5PZmZDb25maXJtYXRpb24iLCByZXNwb25zZU9iamVjdCkKICAgICAgICBlbGlmIGFwcGxpYW5jZVR5cGUgPT0gIlRoZXJtb3N0YXQiOgogICAgICAgICAgdHJ5OgogICAgICAgICAgICBzZWxmLmluZm8odSJDb250cm9sIGFwcGxpYW5jZSB3aXRoIGlkPSd7MH0nLCBuYW1lPSd7MX0nLCB0eXBlPSd7Mn0nIHJlcXVlc3Q9J3szfScsIG1lc3NhZ2VJZD0nezR9Jy4iLCBhcHBsaWFuY2VJZCwgdGFyZ2V0VGVtcGVyYXR1cmVOYW1lLCBhcHBsaWFuY2VUeXBlLCByZXF1ZXN0LCBtZXNzYWdlSWQpCiAgICAgICAgICAgIGlmIHJlcXVlc3QgPT0gJ1NldFRhcmdldFRlbXBlcmF0dXJlUmVxdWVzdCc6CiAgICAgICAgICAgICAgc2VsZi5fS05YU2V0VGVtcGVyYXR1cmUodGFyZ2V0VGVtcGVyYXR1cmVLbywgZmxvYXQodmFsdWUpLCAiU2V0VGFyZ2V0VGVtcGVyYXR1cmVDb25maXJtYXRpb24iLCByZXNwb25zZU9iamVjdCkKICAgICAgICAgICAgZWxpZiByZXF1ZXN0ID09ICdJbmNyZW1lbnRUYXJnZXRUZW1wZXJhdHVyZVJlcXVlc3QnOgogICAgICAgICAgICAgIHNlbGYuX0tOWEFkZFRlbXBlcmF0dXJlKHRhcmdldFRlbXBlcmF0dXJlS28sIGZsb2F0KHZhbHVlKSwgMSwgIkluY3JlbWVudFRhcmdldFRlbXBlcmF0dXJlQ29uZmlybWF0aW9uIiwgcmVzcG9uc2VPYmplY3QpCiAgICAgICAgICAgIGVsaWYgcmVxdWVzdCA9PSAnRGVjcmVtZW50VGFyZ2V0VGVtcGVyYXR1cmVSZXF1ZXN0JzoKICAgICAgICAgICAgICBzZWxmLl9LTlhBZGRUZW1wZXJhdHVyZSh0YXJnZXRUZW1wZXJhdHVyZUtvLCBmbG9hdCh2YWx1ZSksIC0xLCAiRGVjcmVtZW50VGFyZ2V0VGVtcGVyYXR1cmVDb25maXJtYXRpb24iLCByZXNwb25zZU9iamVjdCkKICAgICAgICAgIGV4Y2VwdCBWYWx1ZUVycm9yOgogICAgICAgICAgICBzZWxmLmVycm9yKHUiSWxsZWdhbCByZXF1ZXN0IHZhbHVlPSd7MH0nIChub3QgcGFyc2VhYmxlIGFzIGZsb2F0KSBmb3IgYXBwbGlhbmNlIHdpdGggaWQ9J3sxfScuIiwgdmFsdWUsIGFwcGxpYW5jZUlkKQogICAgICAgICAgICByZXNwb25zZU9iamVjdC5zZXROYW1lKCJVbnN1cHBvcnRlZFRhcmdldFNldHRpbmdFcnJvciIpCiAgICAgICAgZWxzZToKICAgICAgICAgIHNlbGYuZXJyb3IodSJDb250cm9sOiBjb3VsZCBub3QgZGV0ZWN0IGFwcGxpYW5jZSB0eXBlIGZvciBhcHBsaWFuY2Ugd2l0aCBpZD0nezB9Jy4gKG1lc3NhZ2VJZD0nezF9JykiLCBhcHBsaWFuY2VJZCwgbWVzc2FnZUlkKQogICAgICAgICAgcmVzcG9uc2VPYmplY3Quc2V0TmFtZSgiVW5leHBlY3RlZEluZm9ybWF0aW9uUmVjZWl2ZWRFcnJvciIpCiAgICAgIGVsc2U6CiAgICAgICAgc2VsZi5lcnJvcih1IkNvbnRyb2w6IGFwcGxpYW5jZSB3aXRoIGlkPSd7MH0nIG5vdCBmb3VuZC4gKG1lc3NhZ2VJZD0nezF9JykiLCBhcHBsaWFuY2VJZCwgbWVzc2FnZUlkKQogICAgICAgIHJlc3BvbnNlT2JqZWN0LnNldE5hbWUoIk5vU3VjaFRhcmdldEVycm9yIikKICAgICAgaWYgcmVzcG9uc2VPYmplY3QuZ2V0TmFtZSgpIGlzIE5vbmU6CiAgICAgICAgc2VsZi5lcnJvcih1IkNvbnRyb2w6IHVuc3VwcG9ydGVkIG9wZXJhdGlvbiAnezB9JyBmb3IgYXBwbGlhbmNlIHdpdGggaWQ9J3sxfScsIHR5cGU9J3syfScuIChtZXNzYWdlSWQ9J3szfScpIiwgcmVxdWVzdCwgYXBwbGlhbmNlSWQsIGFwcGxpYW5jZVR5cGUsIG1lc3NhZ2VJZCkKICAgICAgICByZXNwb25zZU9iamVjdC5zZXROYW1lKCJVbnN1cHBvcnRlZE9wZXJhdGlvbkVycm9yIikKICAgICAgcmV0dXJuIHJlc3BvbnNlT2JqZWN0CiAgICBkZWYgX0tOWEFkZFRlbXBlcmF0dXJlKHNlbGYsIGtvLCB2YWx1ZSwgc2lnbiwgbmFtZSwgcmVzcG9uc2VPYmplY3QpOgogICAgICBzZWxmLmRlYnVnKHUiX0tOWEFkZFRlbXBlcmF0dXJlKGtvPSd7MH0nLCB2YWx1ZT0nezF9Jywgc2lnbj0nezJ9JywgbmFtZT0nezN9KScuIiwga28uR3JwQWRyU3RyLCB2YWx1ZSwgc2lnbiwgbmFtZSkKICAgICAgb2xkVmFsdWUgPSByb3VuZChrby5nZXRXZXJ0KCksIDIpCiAgICAgIG5ld1ZhbHVlID0gb2xkVmFsdWUgKyAoc2lnbiAqIHZhbHVlKQogICAgICBpZiBvbGRWYWx1ZSA+IGtvLk1pbiBhbmQgb2xkVmFsdWUgPCBrby5NYXg6CiAgICAgICAgaWYgbmV3VmFsdWUgPCBrby5NaW46CiAgICAgICAgICBuZXdWYWx1ZSA9IGtvLk1pbgogICAgICAgIGVsaWYgbmV3VmFsdWUgPiBrby5NYXg6CiAgICAgICAgICBuZXdWYWx1ZSA9IGtvLk1heAogICAgICAgIHNlbGYuX0tOWFNlbmQoa28sIG5ld1ZhbHVlKQogICAgICAgIHJlc3BvbnNlT2JqZWN0LnNldE5hbWUobmFtZSkKICAgICAgICByZXNwb25zZU9iamVjdC5zZXRUZW1wZXJhdHVyZVBheWxvYWQobmV3VmFsdWUsIG9sZFZhbHVlKQogICAgICBlbHNlOgogICAgICAgIHNlbGYud2Fybih1IlZhbHVlIG91dCBvZiByYW5nZToga289J3swfScgbmV3VmFsdWU9J3sxfScgbWluPSd7Mn0nIG1heD0nezN9JyIsIGtvLkdycEFkclN0ciwgbmV3VmFsdWUsIGtvLk1pbiwga28uTWF4KQogICAgICAgIHJlc3BvbnNlT2JqZWN0LnNldE5hbWUoIlZhbHVlT3V0T2ZSYW5nZUVycm9yIikKICAgIGRlZiBfS05YU2V0VGVtcGVyYXR1cmUoc2VsZiwga28sIHZhbHVlLCBuYW1lLCByZXNwb25zZU9iamVjdCk6CiAgICAgIHNlbGYuZGVidWcodSJfS05YU2V0VGVtcGVyYXR1cmUoa289J3swfScsIHZhbHVlPSd7MX0nLCBuYW1lPSd7Mn0nKS4iLCBrby5HcnBBZHJTdHIsIHZhbHVlLCBuYW1lKQogICAgICBvbGRWYWx1ZSA9IHJvdW5kKGtvLmdldFdlcnQoKSwgMikKICAgICAgc2VsZi5kZWJ1Zyh1Il9LTlhTZXRUZW1wZXJhdHVyZTogb2xkVmFsdWU9J3swfScgbWluPSd7MX0nIG1heD0nezJ9JyIsIG9sZFZhbHVlLCBrby5NaW4sIGtvLk1heCkKICAgICAgaWYgdmFsdWUgPj0ga28uTWluIGFuZCB2YWx1ZSA8PSBrby5NYXg6CiAgICAgICAgc2VsZi5fS05YU2VuZChrbywgdmFsdWUpCiAgICAgICAgcmVzcG9uc2VPYmplY3Quc2V0TmFtZShuYW1lKQogICAgICAgIHJlc3BvbnNlT2JqZWN0LnNldFRlbXBlcmF0dXJlUGF5bG9hZCh2YWx1ZSwgb2xkVmFsdWUpCiAgICAgIGVsc2U6CiAgICAgICAgc2VsZi53YXJuKHUiVmFsdWUgb3V0IG9mIHJhbmdlOiBrbz0nezB9JyB2YWx1ZT0nezF9JyBtaW49J3syfScgbWF4PSd7M30nIiwga28uR3JwQWRyU3RyLCB2YWx1ZSwga28uTWluLCBrby5NYXgpCiAgICAgICAgcmVzcG9uc2VPYmplY3Quc2V0TmFtZSgiVmFsdWVPdXRPZlJhbmdlRXJyb3IiKQogICAgZGVmIF9LTlhBZGRQZXJjZW50KHNlbGYsIGtvLCB2YWx1ZSwgc2lnbiwgbmFtZSwgcmVzcG9uc2VPYmplY3QpOgogICAgICBzZWxmLmRlYnVnKHUiX0tOWEFkZFBlcmNlbnQoa289J3swfScsIHZhbHVlPSd7MX0nLCBzaWduPSd7Mn0nLCBuYW1lPSd7M30nKSIsIGtvLkdycEFkclN0ciwgdmFsdWUsIHNpZ24sIG5hbWUpCiAgICAgIG9sZFZhbHVlID0ga28uZ2V0V2VydCgpCiAgICAgIG5ld1ZhbHVlID0gb2xkVmFsdWUgKyAoc2lnbiAqIHZhbHVlKQogICAgICBpZiBvbGRWYWx1ZSA+IGtvLk1pbiBhbmQgb2xkVmFsdWUgPCBrby5NYXg6CiAgICAgICAgaWYgbmV3VmFsdWUgPCBrby5NaW46CiAgICAgICAgICBuZXdWYWx1ZSA9IGtvLk1pbgogICAgICAgIGVsaWYgbmV3VmFsdWUgPiBrby5NYXg6CiAgICAgICAgICBuZXdWYWx1ZSA9IGtvLk1heAogICAgICAgIHNlbGYuX0tOWFNlbmQoa28sIG5ld1ZhbHVlKQogICAgICAgIHJlc3BvbnNlT2JqZWN0LnNldE5hbWUobmFtZSkKICAgICAgZWxzZToKICAgICAgICBzZWxmLndhcm4odSJWYWx1ZSBvdXQgb2YgcmFuZ2U6IGtvPSd7MH0nIG5ld1ZhbHVlPSd7MX0nIG1pbj0nezJ9JyBtYXg9J3szfSciLCBrby5HcnBBZHJTdHIsIG5ld1ZhbHVlLCBrby5NaW4sIGtvLk1heCkKICAgICAgICByZXNwb25zZU9iamVjdC5zZXROYW1lKCJWYWx1ZU91dE9mUmFuZ2VFcnJvciIpCiAgICBkZWYgX0tOWFNldFBlcmNlbnQoc2VsZiwga28sIHZhbHVlLCBuYW1lLCByZXNwb25zZU9iamVjdCk6CiAgICAgIHNlbGYuZGVidWcodSJfS05YU2V0UGVyY2VudChrbz0nezB9JywgdmFsdWU9J3sxfScsIG5hbWU9J3syfScpIiwga28uR3JwQWRyU3RyLCB2YWx1ZSwgbmFtZSkKICAgICAgaWYgdmFsdWUgPj0ga28uTWluIGFuZCB2YWx1ZSA8PSBrby5NYXg6CiAgICAgICAgc2VsZi5fS05YU2VuZChrbywgdmFsdWUpCiAgICAgICAgcmVzcG9uc2VPYmplY3Quc2V0TmFtZShuYW1lKQogICAgICBlbHNlOgogICAgICAgIHNlbGYud2Fybih1IlZhbHVlIG91dCBvZiByYW5nZToga289J3swfScgdmFsdWU9J3sxfScgbWluPSd7Mn0nIG1heD0nezN9JyIsIGtvLkdycEFkclN0ciwgdmFsdWUsIGtvLk1pbiwga28uTWF4KQogICAgICAgIHJlc3BvbnNlT2JqZWN0LnNldE5hbWUoIlZhbHVlT3V0T2ZSYW5nZUVycm9yIikKICAgIGRlZiBfS05YU2V0VmFsdWUoc2VsZiwga28sIHZhbHVlLCBuYW1lLCByZXNwb25zZU9iamVjdCk6CiAgICAgIHNlbGYuZGVidWcodSJfS05YU2V0VmFsdWUoa289J3swfScsIHZhbHVlPSd7MX0nLCBuYW1lPSd7Mn0nKS4iLCBrby5HcnBBZHJTdHIsIHZhbHVlLCBuYW1lKQogICAgICBzZWxmLl9LTlhTZW5kKGtvLCB2YWx1ZSkKICAgICAgcmVzcG9uc2VPYmplY3Quc2V0TmFtZShuYW1lKQogICAgZGVmIF9LTlhTZW5kKHNlbGYsIGtvLCB2YWx1ZSk6CiAgICAgIHNlbGYuZGVidWcodSJfS05YU2VuZChrbz0nezB9JywgdmFsdWU9J3sxfScpOiIsIGtvLkdycEFkclN0ciwgdmFsdWUpCiAgICAgIHNlbGYubG9naWsuTUMuVGFnTGlzdC5zZXRXZXJ0KEZMQUdfRUlCX0xPR0lLLCBrbywgdmFsdWUpCiAgICBkZWYgZmluZEFwcGxpYW5jZShzZWxmLCBhcHBsaWFuY2VJZCk6CiAgICAgIHNlbGYuZGVidWcodSJmaW5kQXBwbGlhbmNlKGFwcGxpYW5jZUlkPSd7MH0nKSIsIGFwcGxpYW5jZUlkKQogICAgICBpZiBzZWxmLmFwcGxpYW5jZXMgaXMgbm90IE5vbmU6CiAgICAgICAgaWQgPSAwCiAgICAgICAgZm9yIGRldmljZSBpbiBzZWxmLmFwcGxpYW5jZXM6CiAgICAgICAgICByb29tID0gZGV2aWNlLmdldCgncm9vbScpCiAgICAgICAgICBpZCArPSAxCiAgICAgICAgICBpZFN0ciA9IGRldmljZS5nZXQoJ2lkJykKICAgICAgICAgIGlmIGlkU3RyIGlzIE5vbmU6CiAgICAgICAgICAgIGlkU3RyID0gc3RyKGlkKQogICAgICAgICAgaWYgYXBwbGlhbmNlSWQgPT0gaWRTdHI6CiAgICAgICAgICAgIHNlbGYuZGVidWcodSJGb3VuZCByb29tPSd7MH0nLiIsIHJvb20pCiAgICAgICAgICAgIHJldHVybiBkZXZpY2UKICAgICAgICAgIGpkID0gMAogICAgICAgICAgZm9yIGFwcGxpYW5jZSBpbiBkZXZpY2VbJ2FwcGxpYW5jZXMnXToKICAgICAgICAgICAgbmFtZSA9IGFwcGxpYW5jZS5nZXQoJ25hbWUnKQogICAgICAgICAgICBqZCArPSAxCiAgICAgICAgICAgIGpkU3RyID0gYXBwbGlhbmNlLmdldCgnaWQnKQogICAgICAgICAgICBpZiBqZFN0ciBpcyBOb25lOgogICAgICAgICAgICAgIGpkU3RyID0gc3RyKGpkKQogICAgICAgICAgICBpZiBhcHBsaWFuY2VJZCA9PSBpZFN0ciArICJfIiArIGpkU3RyOgogICAgICAgICAgICAgIHNlbGYuZGVidWcodSJGb3VuZCBhcHBsaWFuY2Ugd2l0aCBuYW1lPSd7MH0nLiIsIG5hbWUpCiAgICAgICAgICAgICAgcmV0dXJuIGFwcGxpYW5jZQogICAgICAgICAgICBhbGlhc2VzID0gYXBwbGlhbmNlLmdldCgnYWxpYXNlcycpOwogICAgICAgICAgICBpZiBhbGlhc2VzIGlzIG5vdCBOb25lOgogICAgICAgICAgICAgIGtkID0gMAogICAgICAgICAgICAgIGZvciBhbGlhcyBpbiBhbGlhc2VzOgogICAgICAgICAgICAgICAga2QgKz0gMQogICAgICAgICAgICAgICAgaWYgYXBwbGlhbmNlSWQgPT0gaWRTdHIgKyAiXyIgKyBqZFN0ciArICJfIiArIHN0cihrZCk6CiAgICAgICAgICAgICAgICAgIHNlbGYuZGVidWcodSJGb3VuZCBhcHBsaWFuY2Ugd2l0aCBhbGlhcz0nezB9Jy4iLCBhbGlhcykKICAgICAgICAgICAgICAgICAgcmV0dXJuIGFwcGxpYW5jZQogICAgICByZXR1cm4gTm9uZQogICAgZGVmIGZpbmRLbyhzZWxmLCBncnBBZHJTdHIpOgogICAgICBzZWxmLmRlYnVnKHUiZmluZEtvKCd7MH0nKSIsIGdycEFkclN0cikKICAgICAgZm9yIGlrbyBpbiBzZWxmLk1DLlRhZ0xpc3QuVGFnTGlzdDogCiAgICAgICAga28gPSBzZWxmLk1DLlRhZ0xpc3QuVGFnTGlzdFtpa29dCiAgICAgICAgaWYga28uR3JwQWRyU3RyID09IGdycEFkclN0cjoKICAgICAgICAgIHJldHVybiBrbwogICAgICByZXR1cm4gTm9uZTsKICAgIGRlZiBlbmNvZGUoc2VsZiwga2V5LCBkZWMpOgogICAgICBpbXBvcnQgYmFzZTY0CiAgICAgIGVuYyA9IFtdCiAgICAgIGZvciBpIGluIHJhbmdlKGxlbihkZWMpKToKICAgICAgICBrZXlfYyA9IGtleVtpICUgbGVuKGtleSldCiAgICAgICAgZW5jX2MgPSBjaHIoKG9yZChkZWNbaV0pICsgb3JkKGtleV9jKSkgJSAyNTYpCiAgICAgICAgZW5jLmFwcGVuZChlbmNfYykKICAgICAgcmV0dXJuIGJhc2U2NC51cmxzYWZlX2I2NGVuY29kZSgiIi5qb2luKGVuYykpCiAgICBkZWYgZGVjb2RlKHNlbGYsIGtleSwgZW5jKToKICAgICAgaW1wb3J0IGJhc2U2NAogICAgICBkZWMgPSBbXQogICAgICBlbmMgPSBiYXNlNjQudXJsc2FmZV9iNjRkZWNvZGUoZW5jKQogICAgICBmb3IgaSBpbiByYW5nZShsZW4oZW5jKSk6CiAgICAgICAga2V5X2MgPSBrZXlbaSAlIGxlbihrZXkpXQogICAgICAgIGRlY19jID0gY2hyKCgyNTYgKyBvcmQoZW5jW2ldKSAtIG9yZChrZXlfYykpICUgMjU2KQogICAgICAgIGRlYy5hcHBlbmQoZGVjX2MpCiAgICAgIHJldHVybiAiIi5qb2luKGRlYykKICAgIGNsYXNzIEhlYWRlcigpOgogICAgICBkZWYgX19pbml0X18oc2VsZiwgbWVzc2FnZUlkLCBuYW1lLCBuYW1lc3BhY2UsIHBheWxvYWRWZXJzaW9uKToKICAgICAgICBzZWxmLm1lc3NhZ2VJZCA9IG1lc3NhZ2VJZAogICAgICAgIHNlbGYubmFtZSA9IG5hbWUKICAgICAgICBzZWxmLm5hbWVzcGFjZSA9IG5hbWVzcGFjZQogICAgICAgIHNlbGYucGF5bG9hZFZlcnNpb24gPSBwYXlsb2FkVmVyc2lvbgogICAgY2xhc3MgQ29udHJvbFJlc3BvbnNlKCk6CiAgICAgIGRlZiBfX2luaXRfXyhzZWxmLCBtZXNzYWdlSWQpOgogICAgICAgIHNlbGYuaGVhZGVyID0gQW1hem9uRWNoby5IZWFkZXIobWVzc2FnZUlkLCBOb25lLCAiQWxleGEuQ29ubmVjdGVkSG9tZS5Db250cm9sIiwgIjIiKQogICAgICAgIHNlbGYucGF5bG9hZCA9IHt9CiAgICAgIGRlZiBzZXROYW1lKHNlbGYsIG5hbWUpOgogICAgICAgIHNlbGYuaGVhZGVyLm5hbWUgPSBuYW1lCiAgICAgIGRlZiBnZXROYW1lKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmhlYWRlci5uYW1lCiAgICAgIGRlZiBzZXRUZW1wZXJhdHVyZVBheWxvYWQoc2VsZiwgbmV3VmFsdWUsIG9sZFZhbHVlKToKICAgICAgICBzZWxmLnBheWxvYWQgPSB7CiAgICAgICAgICAidGFyZ2V0VGVtcGVyYXR1cmUiOnsidmFsdWUiOm5ld1ZhbHVlfSwKICAgICAgICAgICJ0ZW1wZXJhdHVyZU1vZGUiOnsidmFsdWUiOiJBVVRPIn0sCiAgICAgICAgICAicHJldmlvdXNTdGF0ZSI6ewogICAgICAgICAgICAidGFyZ2V0VGVtcGVyYXR1cmUiOnsidmFsdWUiOm9sZFZhbHVlfSwKICAgICAgICAgICAgIm1vZGUiOnsidmFsdWUiOiJBVVRPIn0KICAgICAgICAgIH0KICAgICAgICB9CiAgICBjbGFzcyBEaXNjb3ZlcnlSZXNwb25zZSgpOgogICAgICBkZWYgX19pbml0X18oc2VsZiwgbWVzc2FnZUlkKToKICAgICAgICBzZWxmLmhlYWRlciA9IEFtYXpvbkVjaG8uSGVhZGVyKG1lc3NhZ2VJZCwgIkRpc2NvdmVyQXBwbGlhbmNlc1Jlc3BvbnNlIiwgIkFsZXhhLkNvbm5lY3RlZEhvbWUuRGlzY292ZXJ5IiwgIjIiKQogICAgICAgIHNlbGYucGF5bG9hZCA9IEFtYXpvbkVjaG8uRGlzY292ZXJ5UGF5bG9hZCgpCiAgICAgIGRlZiBzZXROYW1lKHNlbGYsIG5hbWUpOgogICAgICAgIHNlbGYuaGVhZGVyLm5hbWUgPSBuYW1lCiAgICAgIGRlZiBhZGRBcHBsaWFuY2Uoc2VsZiwgYXBwbGlhbmNlKToKICAgICAgICBzZWxmLnBheWxvYWQuZGlzY292ZXJlZEFwcGxpYW5jZXMuYXBwZW5kKGFwcGxpYW5jZSkKICAgICAgZGVmIGdldE5yT2ZBcHBsaWFuY2VzKHNlbGYpOgogICAgICAgIHJldHVybiBsZW4oc2VsZi5wYXlsb2FkLmRpc2NvdmVyZWRBcHBsaWFuY2VzKQogICAgY2xhc3MgRGlzY292ZXJ5UGF5bG9hZCgpOgogICAgICBkZWYgX19pbml0X18oc2VsZik6CiAgICAgICAgc2VsZi5kaXNjb3ZlcmVkQXBwbGlhbmNlcyA9IFtdCiAgICBjbGFzcyBEaXNjb3ZlcnlBcHBsaWFuY2UoKToKICAgICAgZGVmIF9faW5pdF9fKHNlbGYsIGFwcGxpYW5jZUlkLCBmcmllbmRseU5hbWUsIGFwcGxpYW5jZVR5cGUpOgogICAgICAgIHNlbGYuYXBwbGlhbmNlSWQgPSBhcHBsaWFuY2VJZAogICAgICAgIHNlbGYuZnJpZW5kbHlEZXNjcmlwdGlvbiA9IGZyaWVuZGx5TmFtZQogICAgICAgIHNlbGYuZnJpZW5kbHlOYW1lID0gZnJpZW5kbHlOYW1lCiAgICAgICAgc2VsZi5pc1JlYWNoYWJsZSA9IFRydWUKICAgICAgICBzZWxmLm1hbnVmYWN0dXJlck5hbWUgPSAibi5hLiIKICAgICAgICBzZWxmLm1vZGVsTmFtZSA9ICJuLmEuIgogICAgICAgIHNlbGYudmVyc2lvbiA9ICIxLjAiCiAgICAgICAgaWYgYXBwbGlhbmNlVHlwZSA9PSAiU3dpdGNoYWJsZSI6CiAgICAgICAgICBzZWxmLmFjdGlvbnMgPSBbInR1cm5PbiIsICJ0dXJuT2ZmIl0KICAgICAgICBlbGlmIGFwcGxpYW5jZVR5cGUgPT0gIkxpZ2h0aW5nIjoKICAgICAgICAgIHNlbGYuYWN0aW9ucyA9IFsidHVybk9uIiwgInR1cm5PZmYiLCAiaW5jcmVtZW50UGVyY2VudGFnZSIsICJkZWNyZW1lbnRQZXJjZW50YWdlIiwgInNldFBlcmNlbnRhZ2UiXQogICAgICAgIGVsaWYgYXBwbGlhbmNlVHlwZSA9PSAiVGhlcm1vc3RhdCI6CiAgICAgICAgICBzZWxmLmFjdGlvbnMgPSBbImluY3JlbWVudFRhcmdldFRlbXBlcmF0dXJlIiwgImRlY3JlbWVudFRhcmdldFRlbXBlcmF0dXJlIiwgInNldFRhcmdldFRlbXBlcmF0dXJlIl0KICAgIGNsYXNzIEhUVFBSZXF1ZXN0SGFuZGxlcihCYXNlSFRUUFJlcXVlc3RIYW5kbGVyKToKICAgICAgZGVmIGFkZHJlc3Nfc3RyaW5nKHNlbGYpOgogICAgICAgICAgaG9zdCwgcG9ydCA9IHNlbGYuY2xpZW50X2FkZHJlc3NbOjJdCiAgICAgICAgICByZXR1cm4gaG9zdAogICAgICBkZWYgbG9nX3JlcXVlc3Qoc2VsZiwgY29kZT1Ob25lLCBzaXplPU5vbmUpOgogICAgICAgIHBhc3MKICAgICAgZGVmIGxvZ19tZXNzYWdlKHNlbGYsIGZvcm1hdCwgKmFyZ3MpOgogICAgICAgIHBhc3MKICAgICAgZGVmIGRvX1BPU1Qoc2VsZik6CiAgICAgICAgc2VsZi5wb3N0dmFycyA9IHNlbGYucGFyc2VfUE9TVCgpCiAgICAgICAgc2VsZi5kb19SRVEoKQogICAgICBkZWYgcGFyc2VfUE9TVChzZWxmKToKICAgICAgICBmcm9tIGNnaSBpbXBvcnQgcGFyc2VfaGVhZGVyLCBwYXJzZV9tdWx0aXBhcnQKICAgICAgICBmcm9tIHVybHBhcnNlIGltcG9ydCBwYXJzZV9xcwogICAgICAgIGN0eXBlLCBwZGljdCA9IHBhcnNlX2hlYWRlcihzZWxmLmhlYWRlcnNbJ2NvbnRlbnQtdHlwZSddKQogICAgICAgIGlmIGN0eXBlID09ICdtdWx0aXBhcnQvZm9ybS1kYXRhJzoKICAgICAgICAgICAgcG9zdHZhcnMgPSBwYXJzZV9tdWx0aXBhcnQoc2VsZi5yZmlsZSwgcGRpY3QpCiAgICAgICAgZWxpZiBjdHlwZSA9PSAnYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkJzoKICAgICAgICAgICAgbGVuZ3RoID0gaW50KHNlbGYuaGVhZGVyc1snY29udGVudC1sZW5ndGgnXSkKICAgICAgICAgICAgcG9zdHZhcnMgPSBwYXJzZV9xcygKICAgICAgICAgICAgICAgICAgICBzZWxmLnJmaWxlLnJlYWQobGVuZ3RoKSwgCiAgICAgICAgICAgICAgICAgICAga2VlcF9ibGFua192YWx1ZXM9MSkKICAgICAgICBlbHNlOgogICAgICAgICAgICBwb3N0dmFycyA9IHt9CiAgICAgICAgcmV0dXJuIHBvc3R2YXJzCiAgICAgIGRlZiBkb19HRVQoc2VsZik6CiAgICAgICAgc2VsZi5wb3N0dmFycyA9IE5vbmUKICAgICAgICBzZWxmLmRvX1JFUSgpCiAgICAgIGRlZiBkb19SRVEoc2VsZik6CiAgICAgICAgYWNjZXNzVG9rZW4gPSBOb25lCiAgICAgICAgbWVzc2FnZUlkID0gTm9uZQogICAgICAgIHRyeToKICAgICAgICAgIGlkeCA9IHNlbGYucGF0aC5pbmRleCgiPyIpCiAgICAgICAgICBzZWxmLmNvbW1hbmQgPSBzZWxmLnBhdGhbMTppZHhdCiAgICAgICAgICByZXFQYXJhbXMgPSBzZWxmLl9idWlsZFJlcVBhcmFtTWFwKHNlbGYucGF0aFtpZHgrMTpdKQogICAgICAgICAgYWNjZXNzVG9rZW4gPSByZXFQYXJhbXMuZ2V0KCdhY2Nlc3NUb2tlbicpCiAgICAgICAgICBtZXNzYWdlSWQgPSByZXFQYXJhbXMuZ2V0KCdtZXNzYWdlSWQnKQogICAgICAgIGV4Y2VwdCBWYWx1ZUVycm9yOgogICAgICAgICAgc2VsZi5jb21tYW5kID0gc2VsZi5wYXRoWzE6XQogICAgICAgIGlmIGFjY2Vzc1Rva2VuIGlzIE5vbmU6CiAgICAgICAgICBzZWxmLnNlcnZlci5zZWN1cigiQXR0ZW1wdCB0byBhY2Nlc3Mgc2VydmljZSB3aXRoIG5vIGFjY2VzcyB0b2tlbi4iKQogICAgICAgICAgc2VsZi5zZW5kX2Vycm9yKDQwMSwgJ1VuYXV0aG9yaXplZCcpCiAgICAgICAgICByZXR1cm4KICAgICAgICBpZiBzZWxmLmNvbW1hbmQgPT0gJ2NvbmZpZyc6CiAgICAgICAgICBpZiBhY2Nlc3NUb2tlbiAhPSBzZWxmLnNlcnZlci5hY2Nlc3NUb2tlbjoKICAgICAgICAgICAgc2VsZi5zZXJ2ZXIuc2VjdXIodSJBdHRlbXB0IHRvIGFjY2VzcyBzZXJ2aWNlIHdpdGggd3JvbmcgYWNjZXNzIHRva2VuLiAnezB9JyE9J3sxfSciLCBzZWxmLnNlcnZlci5hY2Nlc3NUb2tlbiwgYWNjZXNzVG9rZW4pCiAgICAgICAgICAgIHNlbGYuc2VuZF9lcnJvcig0MDEsICdVbmF1dGhvcml6ZWQnKQogICAgICAgICAgICByZXR1cm4KICAgICAgICAgIHRyeToKICAgICAgICAgICAgc2VsZi5fY29uZmlnKCkKICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgc2VsZi5zZXJ2ZXIuTUMuRGVidWcuc2V0RXJyKHN5cy5leGNfaW5mbygpLCJJbnRlcm5hbCBFcnJvciIpCiAgICAgICAgICAgIHNlbGYuc2VuZF9lcnJvcig1MDAsICdJbnRlcm5hbCBFcnJvcicpCiAgICAgICAgICByZXR1cm4KICAgICAgICBpZiBhY2Nlc3NUb2tlbiAhPSBzZWxmLnNlcnZlci5hY2Nlc3NUb2tlbjoKICAgICAgICAgIHNlbGYuc2VydmVyLnNlY3VyKHUiQXR0ZW1wdCB0byBhY2Nlc3Mgc2VydmljZSB3aXRoIHdyb25nIGFjY2VzcyB0b2tlbi4gJ3swfSchPSd7MX0nIiwgc2VsZi5zZXJ2ZXIuYWNjZXNzVG9rZW4sIGFjY2Vzc1Rva2VuKQogICAgICAgICAgc2VsZi5fc2VuZEpzb25FcnJvclJlc3BvbnNlKG1lc3NhZ2VJZCwgIlVuZXhwZWN0ZWRJbmZvcm1hdGlvblJlY2VpdmVkRXJyb3IiKQogICAgICAgICAgcmV0dXJuCiAgICAgICAgaWYgbWVzc2FnZUlkIGlzIE5vbmU6CiAgICAgICAgICBzZWxmLl9zZW5kSnNvbkVycm9yUmVzcG9uc2UoIiIsICJVbmV4cGVjdGVkSW5mb3JtYXRpb25SZWNlaXZlZEVycm9yIikKICAgICAgICAgIHJldHVybgogICAgICAgIHRyeToKICAgICAgICAgIGlmIHNlbGYuY29tbWFuZCA9PSAnY29udHJvbCc6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICByZXF1ZXN0ID0gcmVxUGFyYW1zWydyZXF1ZXN0J10KICAgICAgICAgICAgICBhcHBsaWFuY2VJZCA9IHJlcVBhcmFtc1snYXBwbGlhbmNlSWQnXQogICAgICAgICAgICAgIHZhbHVlID0gcmVxUGFyYW1zLmdldCgndmFsdWUnLCBOb25lKQogICAgICAgICAgICBleGNlcHQgKEtleUVycm9yKToKICAgICAgICAgICAgICBzZWxmLl9zZW5kSnNvbkVycm9yUmVzcG9uc2UobWVzc2FnZUlkLCAiVW5leHBlY3RlZEluZm9ybWF0aW9uUmVjZWl2ZWRFcnJvciIpCiAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgIHJlc3BvbnNlT2JqZWN0ID0gc2VsZi5zZXJ2ZXIuY29udHJvbChtZXNzYWdlSWQsIGFwcGxpYW5jZUlkLCByZXF1ZXN0LCB2YWx1ZSkKICAgICAgICAgICAgc2VsZi5fc2VuZEpzb25SZXNwb25zZShyZXNwb25zZU9iamVjdCkKICAgICAgICAgIGVsaWYgc2VsZi5jb21tYW5kID09ICdkaXNjb3ZlcnknOgogICAgICAgICAgICByZXNwb25zZU9iamVjdCA9IHNlbGYuc2VydmVyLmRpc2NvdmVyeShtZXNzYWdlSWQpCiAgICAgICAgICAgIHNlbGYuX3NlbmRKc29uUmVzcG9uc2UocmVzcG9uc2VPYmplY3QpCiAgICAgICAgICBlbHNlOgogICAgICAgICAgICBzZWxmLl9zZW5kSnNvbkVycm9yUmVzcG9uc2UobWVzc2FnZUlkLCAiVW5leHBlY3RlZEluZm9ybWF0aW9uUmVjZWl2ZWRFcnJvciIpCiAgICAgICAgZXhjZXB0OgogICAgICAgICAgc2VsZi5zZXJ2ZXIuZXhjKCJVbmhhbmRsZWQgZXhjZXB0aW9uIG9jY3VyZWQ6IikKICAgICAgICAgIHNlbGYuX3NlbmRKc29uRXJyb3JSZXNwb25zZShtZXNzYWdlSWQsICJEcml2ZXJJbnRlcm5hbEVycm9yIikKICAgICAgZGVmIF9jb25maWcoc2VsZik6CiAgICAgICAgZW5jRXJyb3IgPSBGYWxzZQogICAgICAgIG1zZyA9ICIiCiAgICAgICAgaWYgc2VsZi5wb3N0dmFycyBpcyBub3QgTm9uZToKICAgICAgICAgIGNvbmZMaXN0ID0gc2VsZi5wb3N0dmFycy5nZXQoJ2NvbmYnLCBOb25lKQogICAgICAgICAgaWYgY29uZkxpc3QgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIG1zZyA9IHNlbGYuc2VydmVyLnNhdmVBcHBsaWFuY2VzQ29uZihjb25mTGlzdFswXS5zdHJpcCgpKQogICAgICAgIHNlbGYuc2VuZF9yZXNwb25zZSgyMDApCiAgICAgICAgc2VsZi5zZW5kX2hlYWRlcignQ29udGVudC1UeXBlJywgJ3RleHQvaHRtbDsgY2hhcnNldD11dGYtOCcpCiAgICAgICAgc2VsZi5lbmRfaGVhZGVycygpCiAgICAgICAgc2VsZi53ZmlsZS53cml0ZSgnPGh0bWw+PGhlYWQ+PG1ldGEgY2hhcnNldD0idXRmLTgiPjwvaGVhZD48Ym9keT4nKQogICAgICAgIHNlbGYud2ZpbGUud3JpdGUoJzxmb3JtIG1ldGhvZD0icG9zdCIgZW5jdHlwZT0iYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkIiBhY2NlcHQtY2hhcnNldD0idXRmLTgiPicpCiAgICAgICAgc2VsZi53ZmlsZS53cml0ZSgnPHRhYmxlIHN0eWxlPSJ3aWR0aDoxMDAlO2hlaWdodDoxMDAlIj4nKQogICAgICAgIHNlbGYud2ZpbGUud3JpdGUoJzx0cj48dGQ+PGgxPkFtYXpvbiBFY2hvIC0gQXBwbGlhbmNlczwvaDE+PC90ZD48L3RyPicpCiAgICAgICAgc2VsZi53ZmlsZS53cml0ZSgnPHRyIHN0eWxlPSJoZWlnaHQ6OTAlIj48dGQ+PHRleHRhcmVhIG5hbWU9ImNvbmYiIHN0eWxlPSJ3aWR0aDoxMDAlO2hlaWdodDoxMDAlIj4nKQogICAgICAgIGlmIG1zZyA9PSAiIjoKICAgICAgICAgIGlmIHNlbGYuc2VydmVyLmFwcGxpYW5jZXMgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJlc3AgPSBqc29uLmR1bXBzKHNlbGYuc2VydmVyLmFwcGxpYW5jZXMsIGRlZmF1bHQ9YXNEaWN0LCBlbnN1cmVfYXNjaWk9RmFsc2UsIGVuY29kaW5nPSJ1dGYtOCIpCiAgICAgICAgICBlbHNlOgogICAgICAgICAgICByZXNwID0gIiIKICAgICAgICBlbHNlOgogICAgICAgICAgcmVzcCA9IGNvbmZMaXN0WzBdLnN0cmlwKCkuZGVjb2RlKCd1dGYtOCcpCiAgICAgICAgdHJ5OgogICAgICAgICAgc2VsZi53ZmlsZS53cml0ZShyZXNwLmVuY29kZSgndXRmLTgnKSkKICAgICAgICBleGNlcHQ6CiAgICAgICAgICBlbmNFcnJvciA9IFRydWUKICAgICAgICAgIHNlbGYuc2VydmVyLmV4YygiRW5jb2RpbmcgZXJyb3I6IikKICAgICAgICAgIG1zZyA9ICJFbmNvZGluZyBFcnJvciIKICAgICAgICBzZWxmLndmaWxlLndyaXRlKCc8L3RleHRhcmVhPjwvdGQ+PC90cj4nKQogICAgICAgIHNlbGYud2ZpbGUud3JpdGUoJzx0cj48dGQ+PGlucHV0IHR5cGU9InN1Ym1pdCIvPjwvdGQ+PC90cj4nKQogICAgICAgIHNlbGYud2ZpbGUud3JpdGUoJzx0cj48dGQ+PGhyLz5FeGFtcGxlOjxwcmU+PGNvZGU+JykKICAgICAgICBzZWxmLndmaWxlLndyaXRlKCdbXG4nKQogICAgICAgIHNlbGYud2ZpbGUud3JpdGUoJyAgeyJyb29tIjoiS/xjaGUiLCAiYXBwbGlhbmNlcyI6W3sibmFtZSI6IkRlY2tlbmxldWNodGUiLCAib25PZmYiOiIxLzIvMyJ9XX0sXG4nLmRlY29kZSgnaXNvODg1OS0xJykuZW5jb2RlKCd1dGYtOCcpKQogICAgICAgIHNlbGYud2ZpbGUud3JpdGUoJyAgeyJyb29tIjoiV29obnppbW1lciIsICJ0YXJnZXRUZW1wZXJhdHVyZSI6IjIvMi80IiwgImFwcGxpYW5jZXMiOltcbicpCiAgICAgICAgc2VsZi53ZmlsZS53cml0ZSgnICAgIHsibmFtZSI6IkRlY2tlbmxldWNodGUiLCAib25PZmYiOiIxLzIvNCIsICJwZXJjZW50IjoiMS8yLzUifSxcbicpCiAgICAgICAgc2VsZi53ZmlsZS53cml0ZSgnICAgIHsibmFtZSI6IlN0ZWhsZXVjaHRlIiwgIm9uT2ZmIjoiMS8yLzYiLCAicGVyY2VudCI6IjEvMi83IiwgImFsaWFzZXMiOlsiU3RlaGxhbXBlIFdvaG56aW1tZXIiXX1cbicpCiAgICAgICAgc2VsZi53ZmlsZS53cml0ZSgnICBdfSxcbicpCiAgICAgICAgc2VsZi53ZmlsZS53cml0ZSgnICB7ImFwcGxpYW5jZXMiOltcbicpCiAgICAgICAgc2VsZi53ZmlsZS53cml0ZSgnICAgIHsibmFtZSI6IkxpY2h0c3plbmUgRXNzZW4iLCAib25PZmYiOiIxLzMvMSIsICJ2YWx1ZSI6IjAifSxcbicpCiAgICAgICAgc2VsZi53ZmlsZS53cml0ZSgnICAgIHsibmFtZSI6IkxpY2h0c3plbmUgRGVrbyIsICJvbk9mZiI6IjEvMy8xIiwgInZhbHVlIjoiMSJ9XG4nKQogICAgICAgIHNlbGYud2ZpbGUud3JpdGUoJyAgXX1cbicpCiAgICAgICAgc2VsZi53ZmlsZS53cml0ZSgnXScpCiAgICAgICAgc2VsZi53ZmlsZS53cml0ZSgnPC9jb2RlPjwvcHJlPjwvdGQ+PC90cj4nKQogICAgICAgIGlmIG1zZyAhPSAiIjoKICAgICAgICAgIHNlbGYud2ZpbGUud3JpdGUoJzx0cj48dGQ+JykKICAgICAgICAgIHNlbGYud2ZpbGUud3JpdGUoJzxiIHN0eWxlPSJjb2xvcjpyZWQiPicpCiAgICAgICAgICBzZWxmLndmaWxlLndyaXRlKG1zZykKICAgICAgICAgIHNlbGYud2ZpbGUud3JpdGUoJzwvYj4nKQogICAgICAgICAgaWYgbm90IGVuY0Vycm9yOgogICAgICAgICAgICBzZWxmLndmaWxlLndyaXRlKCcgKEFkdmljZTogQ29weSZwYXN0ZSB5b3VyIEpTT04gY29uZmlndXJhdGlvbiBvbiA8YSB0YXJnZXQ9Im5ldyIgaHJlZj0iaHR0cDovL2pzb25saW50LmNvbS8iPkpTT05MaW50PC9hPiB0byB2YWxpZGF0ZS4pJykKICAgICAgICAgIHNlbGYud2ZpbGUud3JpdGUoJzwvdGQ+PC90cj4nKQogICAgICAgIHNlbGYud2ZpbGUud3JpdGUoJzwvZm9ybT48L2JvZHk+PC9odG1sPicpCiAgICAgIGRlZiBfc2VuZEpzb25FcnJvclJlc3BvbnNlKHNlbGYsIG1lc3NhZ2VJZCwgZXJyb3JNZXNzYWdlKToKICAgICAgICByZXNwb25zZU9iamVjdCA9IE5vbmUKICAgICAgICBpZiBzZWxmLmNvbW1hbmQgPT0gJ2NvbnRyb2wnOgogICAgICAgICAgcmVzcG9uc2VPYmplY3QgPSBBbWF6b25FY2hvLkNvbnRyb2xSZXNwb25zZShtZXNzYWdlSWQpCiAgICAgICAgZWxpZiBzZWxmLmNvbW1hbmQgPT0gJ2Rpc2NvdmVyeSc6CiAgICAgICAgICByZXNwb25zZU9iamVjdCA9IEFtYXpvbkVjaG8uRGlzY292ZXJ5UmVzcG9uc2UobWVzc2FnZUlkKQogICAgICAgIGVsc2U6CiAgICAgICAgICBzZWxmLnNlbmRfZXJyb3IoNDA0LCAnTm90IEZvdW5kJykKICAgICAgICAgIHJldHVybgogICAgICAgIHJlc3BvbnNlT2JqZWN0LnNldE5hbWUoZXJyb3JNZXNzYWdlKQogICAgICAgIHNlbGYuX3NlbmRKc29uUmVzcG9uc2UocmVzcG9uc2VPYmplY3QpCiAgICAgIGRlZiBfc2VuZEpzb25SZXNwb25zZShzZWxmLCByZXNwb25zZU9iamVjdCk6CiAgICAgICAgcmVzcCA9IGpzb24uZHVtcHMocmVzcG9uc2VPYmplY3QsIGRlZmF1bHQ9YXNEaWN0LCBlbmNvZGluZz0idXRmLTgiKQogICAgICAgIHNlbGYuc2VuZF9yZXNwb25zZSgyMDApCiAgICAgICAgc2VsZi5zZW5kX2hlYWRlcignQ29udGVudC1UeXBlJywgJ2FwcGxpY2F0aW9uL2pzb247IGNoYXJzZXQ9dXRmLTgnKQogICAgICAgIHNlbGYuZW5kX2hlYWRlcnMoKQogICAgICAgIHNlbGYud2ZpbGUud3JpdGUocmVzcCkKICAgICAgZGVmIF9idWlsZFJlcVBhcmFtTWFwKHNlbGYsIHF1ZXJ5KToKICAgICAgICBpbXBvcnQgdXJsbGliCiAgICAgICAgcmVxX3BhcmFtcyA9IHt9CiAgICAgICAgcGFyYW1zID0gcXVlcnkuc3BsaXQoJyYnKQogICAgICAgIGZvciBwYXJhbSBpbiBwYXJhbXM6CiAgICAgICAgICBpZHggPSBwYXJhbS5maW5kKCc9JykKICAgICAgICAgIHJlcV9wYXJhbXNbcGFyYW1bMDppZHhdXSA9IHVybGxpYi51bnF1b3RlX3BsdXMocGFyYW1baWR4ICsgMTpdKS5kZWNvZGUoJ3V0Zi04JykKICAgICAgICByZXR1cm4gcmVxX3BhcmFtcwogICAgZGVmIGdldFNTTENlcnQoc2VsZiwgaXAsIHBvcnQsIGNlcnRGaWxlbmFtZSk6CiAgICAgIHNlbGYuZGVidWcoImdldFNTTENlcnQoezB9LCB7MX0sIHsyfSkiLCBpcCwgcG9ydCwgY2VydEZpbGVuYW1lKQogICAgICBpZiBzZWxmLkhTOgogICAgICAgIHRyeToKICAgICAgICAgIGltcG9ydCB1cmxsaWIyCiAgICAgICAgICB1cmwgPSAiaHR0cDovL3swfTp7MX0vb3B0L3syfSIuZm9ybWF0KGlwLCBwb3J0LCBjZXJ0RmlsZW5hbWUpCiAgICAgICAgICByZXEgPSB1cmxsaWIyLlJlcXVlc3QodXJsKQogICAgICAgICAgcmVzID0gdXJsbGliMi51cmxvcGVuKHJlcSkKICAgICAgICAgIGlmIHJlcy5nZXRjb2RlKCkgPT0gMjAwOgogICAgICAgICAgICByZXR1cm4gcmVzLmZwLnJlYWQoKQogICAgICAgIGV4Y2VwdDoKICAgICAgICAgIHNlbGYud2FybigiR0VUIFNTTC1DZXJ0aWZpY2F0ZSBmcm9tIFVSTD0nezB9JyBmYWlsZWQuIFdpbGwgdXNpbmcgaHR0cCBpbnN0ZWFkIG9mIGh0dHBzLiIsIHVybCkKICAgICAgZWxzZToKICAgICAgICB3aXRoIG9wZW4oJ2FtYXpvbkVjaG9TU0wuY2VydCcsICdyJykgYXMgbXlmaWxlOgogICAgICAgICAgY2VydFRleHQ9bXlmaWxlLnJlYWQoKQogICAgICAgIHJldHVybiBjZXJ0VGV4dAogICAgICByZXR1cm4gIiIKICAgIGRlZiB3ZWJDYWxsYmFja1NTTENlcnQoc2VsZiwgc3RyZWFtPUZhbHNlKToKICAgICAgaHRtbCA9ICI8aHRtbD48aGVhZD4iCiAgICAgIGh0bWwgKz0gIjxtZXRhIGNoYXJzZXQ9J0lTTy04ODU5LTEnLz4iCiAgICAgIGh0bWwgKz0gIjxtZXRhIGh0dHAtZXF1aXY9J2NhY2hlLWNvbnRyb2wnIGNvbnRlbnQ9J21heC1hZ2U9MCcvPiIKICAgICAgaHRtbCArPSAiPG1ldGEgaHR0cC1lcXVpdj0nY2FjaGUtY29udHJvbCcgY29udGVudD0nbm8tY2FjaGUnLz4iCiAgICAgIGh0bWwgKz0gIjxtZXRhIGh0dHAtZXF1aXY9J2V4cGlyZXMnIGNvbnRlbnQ9JzAnLz4iCiAgICAgIGh0bWwgKz0gIjxtZXRhIGh0dHAtZXF1aXY9J2V4cGlyZXMnIGNvbnRlbnQ9J1R1ZSwgMDEgSmFuIDE5ODAgMTowMDowMCBHTVQnLz4iCiAgICAgIGh0bWwgKz0gIjxtZXRhIGh0dHAtZXF1aXY9J3ByYWdtYScgY29udGVudD0nbm8tY2FjaGUnLz4iCiAgICAgIGh0bWwgKz0gIjwvaGVhZD48Ym9keT4iCiAgICAgIGh0bWwgKz0gIjxoMT5BbWF6b24gRWNobyAtIFNTTCBDZXJ0aWZpY2F0ZTwvaDE+IgogICAgICBodG1sICs9ICI8cHJlPjxjb2RlPiIKICAgICAgaHRtbCArPSBzZWxmLmNlcnRUZXh0CiAgICAgIGh0bWwgKz0gIjwvcHJlPjwvY29kZT4iCiAgICAgIGh0bWwgKz0gIjwvYm9keT48L2h0bWw+IgogICAgICBpZiBzdHJlYW06CiAgICAgICAgICBzdHJlYW0ud3JpdGUoaHRtbCkKICAgICAgc2VsZi5EYXRMZW4gPSBsZW4oaHRtbCkKICAgIGRlZiB3ZWJDYWxsYmFja0xvZyhzZWxmLCBzdHJlYW09RmFsc2UpOgogICAgICBodG1sID0gIjxodG1sPjxoZWFkPiIKICAgICAgaHRtbCArPSAiPG1ldGEgY2hhcnNldD0nSVNPLTg4NTktMScvPiIKICAgICAgaHRtbCArPSAiPG1ldGEgaHR0cC1lcXVpdj0nY2FjaGUtY29udHJvbCcgY29udGVudD0nbWF4LWFnZT0wJy8+IgogICAgICBodG1sICs9ICI8bWV0YSBodHRwLWVxdWl2PSdjYWNoZS1jb250cm9sJyBjb250ZW50PSduby1jYWNoZScvPiIKICAgICAgaHRtbCArPSAiPG1ldGEgaHR0cC1lcXVpdj0nZXhwaXJlcycgY29udGVudD0nMCcvPiIKICAgICAgaHRtbCArPSAiPG1ldGEgaHR0cC1lcXVpdj0nZXhwaXJlcycgY29udGVudD0nVHVlLCAwMSBKYW4gMTk4MCAxOjAwOjAwIEdNVCcvPiIKICAgICAgaHRtbCArPSAiPG1ldGEgaHR0cC1lcXVpdj0ncHJhZ21hJyBjb250ZW50PSduby1jYWNoZScvPiIKICAgICAgaHRtbCArPSAiPC9oZWFkPjxib2R5PiIKICAgICAgaHRtbCArPSAiPGgxPkFtYXpvbiBFY2hvIC0gTG9nPC9oMT4iCiAgICAgIGh0bWwgKz0gIjxiPkxvZ2xldmVsID0gIgogICAgICBpZiBzZWxmLmxvZ0xldmVsID09IDA6CiAgICAgICAgaHRtbCArPSAiMCAoT2ZmKSIKICAgICAgZWxpZiBzZWxmLmxvZ0xldmVsID09IDE6CiAgICAgICAgaHRtbCArPSAiMSAoRXJyb3IpIgogICAgICBlbGlmIHNlbGYubG9nTGV2ZWwgPT0gMjoKICAgICAgICBodG1sICs9ICIyIChXYXJuKSIKICAgICAgZWxpZiBzZWxmLmxvZ0xldmVsID09IDM6CiAgICAgICAgaHRtbCArPSAiMyAoSW5mbykiCiAgICAgIGVsaWYgc2VsZi5sb2dMZXZlbCA9PSA0OgogICAgICAgIGh0bWwgKz0gIjQgKERlYnVnKSIKICAgICAgaHRtbCArPSAiPC9iPiIKICAgICAgaHRtbCArPSAiPHByZT48Y29kZT4iCiAgICAgIHdpdGggb3BlbihzZWxmLkZJTEVQQVRIX0xPRywgJ3InKSBhcyBteWZpbGU6CiAgICAgICAgZGF0YSA9IG15ZmlsZS5yZWFkKCkKICAgICAgaHRtbCArPSBkYXRhCiAgICAgIGh0bWwgKz0gIjwvcHJlPjwvY29kZT4iCiAgICAgIGh0bWwgKz0gIjwvYm9keT48L2h0bWw+IgogICAgICBpZiBzdHJlYW06CiAgICAgICAgICBzdHJlYW0ud3JpdGUoaHRtbCkKICAgICAgc2VsZi5EYXRMZW4gPSBsZW4oaHRtbCkKICAgIGRlZiBpbml0X2RlYnVnX2VudHJ5KHNlbGYpOgogICAgICBwcm90byA9ICJodHRwIgogICAgICBpZiBzZWxmLmNlcnRUZXh0ICE9ICIiOgogICAgICAgIHByb3RvID0gImh0dHBzIgogICAgICBpZCA9ICdBbWF6b25fRWNob19TZXJ2ZXInCiAgICAgIGltcG9ydCB1cmxsaWIKICAgICAgc2VsZi5NQy5EZWJ1Zy5hZGRHcnVwcGUoCiAgICAgICAgW2lkLCBpZF0sCiAgICAgICAgICBbIAogICAgICAgICAgICBbIjBWRVJTSU9OSU5GTyIsIlZlcnNpb24iLDEsJ1YwLjIgLSAoMjAxNi0xMi0xMiAwODo0MiknXSwKICAgICAgICAgICAgWyIxUE9SVCIsIlBvcnQiLDEsc3RyKHNlbGYucG9ydCldLAogICAgICAgICAgICBbIjJTU0wiLCJTU0wtQ2VydGlmaWNhdGUiLDEsIjxhIGhyZWY9Jy9vcHQvezB9Jz5zaG93PC9hPjxicj4iLmZvcm1hdChzZWxmLlVSTF9TSE9XX1NTTCldLAogICAgICAgICAgICBbIjNMT0ciLCJMb2dmaWxlIiwxLCI8YSBocmVmPScvb3B0L3swfSc+c2hvdzwvYT48YnI+Ii5mb3JtYXQoc2VsZi5VUkxfU0hPV19MT0cpXSwKICAgICAgICAgICAgWyI0Q09ORklHIiwiQXBwbGlhbmNlcyBjb25maWd1cmF0aW9uIiwxLHUiPGEgaHJlZj0nezB9Oi8vezF9OnsyfS9jb25maWc/YWNjZXNzVG9rZW49ezN9Jz5lZGl0PC9hPjxicj4iLmZvcm1hdChwcm90bywgc2VsZi5oc0lwLCBzZWxmLnBvcnQsIHVybGxpYi5xdW90ZV9wbHVzKHNlbGYuYWNjZXNzVG9rZW4uZW5jb2RlKCd1dGYtOCcpKSldLAogICAgICAgICAgXSAgIAogICAgICApCiAgICBkZWYgc2V0TG9nTGV2ZWwoc2VsZiwgbGV2ZWwpOgogICAgICBzZWxmLmxvZ0xldmVsID0gbGV2ZWwKICAgIGRlZiBjbGVhckxvZyhzZWxmKToKICAgICAgc2VsZi5sb2dGaWxlLnNlZWsoMCkKICAgICAgc2VsZi5sb2dGaWxlLnRydW5jYXRlKCkKICAgICAgc2VsZi5sb2coc2VsZi52ZXJzaW9uKQogICAgZGVmIGV4YyhzZWxmLCBtc2c9IiIpOgogICAgICBpZiBtc2cgIT0gIiI6CiAgICAgICAgc2VsZi5lcnJvcihtc2cpCiAgICAgIGltcG9ydCB0cmFjZWJhY2sKICAgICAgZXhjTXNnID0gdHJhY2ViYWNrLmZvcm1hdF9leGMoKQogICAgICBzZWxmLmVycm9yKGV4Y01zZykKICAgIGRlZiBzZWN1cihzZWxmLCBtc2csICpwYXJhbXMpOgogICAgICBzZWxmLnVuYXV0aG9yaXplZENvdW50ZXIgKz0gMQogICAgICBzZWxmLnNlbmRUb091dHB1dCgxLCBzZWxmLnVuYXV0aG9yaXplZENvdW50ZXIpCiAgICAgIHNlbGYuX2xvZygiU0VDVVIiLCBtc2csICpwYXJhbXMpCiAgICBkZWYgZXJyb3Ioc2VsZiwgbXNnLCAqcGFyYW1zKToKICAgICAgaWYgc2VsZi5sb2dMZXZlbCA+PSAxOgogICAgICAgIHNlbGYuX2xvZygiRVJST1IiLCBtc2csICpwYXJhbXMpCiAgICBkZWYgd2FybihzZWxmLCBtc2csICpwYXJhbXMpOgogICAgICBpZiBzZWxmLmxvZ0xldmVsID49IDI6CiAgICAgICAgc2VsZi5fbG9nKCJXQVJOICIsIG1zZywgKnBhcmFtcykKICAgIGRlZiBpbmZvKHNlbGYsIG1zZywgKnBhcmFtcyk6CiAgICAgIGlmIHNlbGYubG9nTGV2ZWwgPj0gMzoKICAgICAgICBzZWxmLl9sb2coIklORk8gIiwgbXNnLCAqcGFyYW1zKQogICAgZGVmIGRlYnVnKHNlbGYsIG1zZywgKnBhcmFtcyk6CiAgICAgIGlmIHNlbGYubG9nTGV2ZWwgPj0gNDoKICAgICAgICBzZWxmLl9sb2coIkRFQlVHIiwgbXNnLCAqcGFyYW1zKQogICAgZGVmIGxvZyhzZWxmLCBtc2csICpwYXJhbXMpOgogICAgICBzZWxmLl9sb2coIlNZUyAgIiwgbXNnLCAqcGFyYW1zKQogICAgZGVmIF9sb2coc2VsZiwgcHJlZml4LCBtc2csICpwYXJhbXMpOgogICAgICBpbXBvcnQgdGltZQogICAgICB0aW1lc3RhbXAgPSB0aW1lLnN0cmZ0aW1lKCIlWS0lbS0lZCAlSDolTTolUyIpCiAgICAgIGlmIHBhcmFtcyBpcyBub3QgTm9uZToKICAgICAgICBtc2cgPSBtc2cuZm9ybWF0KCpwYXJhbXMpCiAgICAgIG1zZyA9IHRpbWVzdGFtcCArICIgfCAiICsgcHJlZml4ICsgIiAiICsgbXNnICsgJ1xuJwogICAgICBzZWxmLmxvZ0ZpbGUud3JpdGUobXNnKQogICAgICBzZWxmLmxvZ0ZpbGUuZmx1c2goKQogICAgZGVmIHNlbmRUb091dHB1dChzZWxmLCBvdXQsIHZhbHVlKToKICAgICAgc2VsZi5kZWJ1Zygic2VuZFRvT3V0cHV0OiB7MH0gPSAnezF9JyIsIHN0cihvdXQpLCBzdHIodmFsdWUpKQogICAgICBvdXQgLT0gMSAjIyBJbnRlcm4gc3RhcnRlbiBkaWUgQXVzZ+RuZ2UgYmVpIDAgdW5kIG5pY2h0IGJlaSAxCiAgICAgIGlmIHNlbGYubG9naWsuU2VuZEludGVydmFsbCA9PSAwIG9yIHRpbWUudGltZSgpID49IHNlbGYubG9naWsuQXVzZ2FuZ1tvdXRdWzBdOgogICAgICAgIGZvciBpa28gaW4gc2VsZi5sb2dpay5BdXNnYW5nW291dF1bMV06CiAgICAgICAgICBzZWxmLmxvZ2lrLk1DLlRhZ0xpc3Quc2V0V2VydChGTEFHX0VJQl9MT0dJSywgaWtvLCB2YWx1ZSkKICAgICAgICBpZiB2YWx1ZToKICAgICAgICAgIGZvciBjbWQgaW4gc2VsZi5sb2dpay5BdXNnYW5nW291dF1bMl06CiAgICAgICAgICAgIGNtZC5leGVjQmVmZWhsKCkKICAgICAgICBmb3IgY29uIGluIHNlbGYubG9naWsuQXVzZ2FuZ1tvdXRdWzNdOgogICAgICAgICAgc2VsZi5sb2dpay5NQy5Mb2dpa0xpc3QuQ29ubmVjdExpc3QuYXBwZW5kKGNvbiArIFsgdmFsdWUgXSkKICAgICAgICBpZiBzZWxmLmxvZ2lrLlNlbmRJbnRlcnZhbGwgPiAwOgogICAgICAgICAgc2VsZi5sb2dpay5BdXNnYW5nW291dF1bMF0gPSB0aW1lLnRpbWUoKSArIHNlbGYubG9naWsuU2VuZEludGVydmFsbAogICAgICAgIHNlbGYubG9naWsuT3V0V2VydFtvdXRdID0gdmFsdWUgICAgICAKICBnbG9iYWwgQW1hem9uRWNob1dlYkNhbGxiYWNrCiAgY2xhc3MgQW1hem9uRWNob1dlYkNhbGxiYWNrKG9iamVjdCk6CiAgICBkZWYgX19pbml0X18oc2VsZiwgcEl0ZW0sIGFtYXpvbkVjaG8sIGNhbGxiYWNrLCBuYW1lLCB0eXBlPSd0ZXh0L2h0bWwnKToKICAgICAgc2VsZi5sb2dpayA9IHBJdGVtCiAgICAgIHNlbGYuYW1hem9uRWNobyA9IGFtYXpvbkVjaG8KICAgICAgc2VsZi5jYWxsYmFjayA9IGNhbGxiYWNrCiAgICAgIHNlbGYuTUMgPSBwSXRlbS5NQwogICAgICBzZWxmLlVybFBmYWQgPSBuYW1lLnVwcGVyKCkKICAgICAgc2VsZi5EYXROYW1lID0gIk9QVC8lcyIgJSAoc2VsZi5VcmxQZmFkKQogICAgICBzZWxmLkRhdExlbiA9IDAKICAgICAgc2VsZi5UeXAgPSB0eXBlCiAgICAgIHNlbGYuaXNRdWFkID0gMAogICAgICBzZWxmLk1DLkdVSS5FeHREYXRVcmxbc2VsZi5VcmxQZmFkXSA9IHNlbGYKICAgIGRlZiBnZXREYXRlbihzZWxmKToKICAgICAgcmV0dXJuCiAgICBkZWYgZ2V0UXVhZERhdGVuKHNlbGYpOgogICAgICByZXR1cm4gCiAgICBkZWYgZ2V0RGF0ZW5TdHJlYW0oc2VsZiwgc3RyZWFtKToKICAgICAgaW1wb3J0IHRpbWUKICAgICAgc3RyZWFtLnNlZWsoMCkKICAgICAgX2hlYWRlciA9IFsKICAgICAgICAgICJIVFRQLzEuMCAyMDAgT0siLAogICAgICAgICAgIlByYWdtYTogbm8tY2FjaGUiLAogICAgICAgICAgIkNhY2hlLUNvbnRyb2w6ICBtYXgtYWdlPTAsIG5vLXN0b3JlLCBuby1jYWNoZSwgbXVzdC1yZXZhbGlkYXRlIiwKICAgICAgICAgICJMYXN0LU1vZGlmaWVkOiAiICsgdGltZS5zdHJmdGltZSgiJWEsICVkICVtICVZICVIOiVNOiVTIEdNVCIsdGltZS5nbXRpbWUoKSksCiAgICAgICAgICAiQ29ubmVjdGlvbjogY2xvc2UiLAogICAgICAgICAgIkNvbnRlbnQtVHlwZTogIiArIHNlbGYuVHlwICsgIjsgY2hhcnNldD1JU08tODg1OS0xIiwKICAgICAgXQogICAgICBzdHJlYW0ud3JpdGUoIlxuIi5qb2luKF9oZWFkZXIpICsgIlxuXG4iKQogICAgICBzZWxmLkRhdExlbiA9IHNlbGYuY2FsbGJhY2soc3RyZWFtKQogICAgZGVmIGdldFF1YWREYXRlblN0cmVhbShzZWxmLCBzdHJlYW0pOgogICAgICBzZWxmLmFtYXpvbkVjaG8ud2FybigiQW1hem9uRWNob1dlYkNhbGxiYWNrICh7MH0pOiB1bmV4cGVjdGVkIGNhbGwgb2YgZ2V0UXVhZERhdGVuU3RyZWFtKCkuIiwgbmFtZSkKICAgICAgcmV0dXJuCg=='),'<13626_Amazon Echo (13626)>','exec'))"|""|0|0|0|0
## MD5 der Formelzeile: 35cb013126a62f807b9586a32f1ce7fd
### Klasse AmazonEcho
################################
## Quelltext nicht Öffentlich ##
################################




#5012|abbruch bei bed. (0/1)|bedingung|formel|zeit|pin-ausgang|pin-offset|pin-speicher|pin-neg.ausgang
## Klasse auf SN1 
5012|0|"EI"|"AmazonEcho(locals())"|"AmazonEcho.DELAY"|0|1|1|0
5012|0|"OC[1]"|"SN[1].init()"|""|0|0|0|0
5012|0|"EC[1] and EN[1]"|"SN[1].start()"|""|0|0|0|0
5012|0|"EC[1] and not EN[1]"|"SN[1].stop()"|""|0|0|0|0
5012|0|"EC[4]"|"SN[1].setLogLevel(EN[4])"|""|0|0|0|0
5012|0|"EC[5] and EN[5]"|"SN[1].clearLog()"|""|0|0|0|0



