# -*- coding: iso8859-1 -*-
## -----------------------------------------------------
## Amazon Echo (13626)   ### V0.3
##
## erstellt am: 2017-01-16 04:17
## -----------------------------------------------------
## Copyright © 2016, Werner Lindbüchl, All rights reserved.
##
## This program is free software; you can redistribute it and/or modify it under the terms
## of the GNU General Public License as published by the Free Software Foundation; either
## version 3 of the License, or (at your option) any later version.
##
## This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
## without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
## See the GNU General Public License for more details.
##
## You should have received a copy of the GNU General Public License along with this program;
## if not, see <http://www.gnu.de/documents/gpl-3.0.de.html>.

## -- 
## --  

#5000|"Text"|Remanent(1/0)|Anz.Eingänge|.n.|Anzahl Ausgänge|.n.|.n.
5000|"Weitere Bausteine\Amazon Echo (13626)_V0.3"|1|5|"E1 Https-Server Start/Stop"|"E2 Https-Server Port"|"E3 Access Token"|"E4 Loglevel 0=Off, 1=Error, 2=Warn, 3=Info, 4=Debug"|"E5 Clear Log"|1|"A1 Unauthorized Access Counter"|"V0.3"

#5001|Anzahl Eingänge|Ausgänge|Offset|Speicher|Berechnung bei Start
5001|5|1|1|6|1

# Eingaenge
#5002|Index Eingang|Default Wert|0=numerisch 1=alphanummerisch
5002|1|1|0	#* E1 Https-Server Start/Stop 
5002|2|0|0	#* E2 Https-Server Port 
5002|3|0|1	#* E3 Access Token 
5002|4|2|0	#* E4 LogLevel 
5002|5|0|0	#* E5 Clear Log 

# Speicher
#5003|Speicher|Initwert|Remanent
5003|1||0		  #* 
5003|2|""|1		  #*  Bytes - 10000
5003|3|""|1		  #*  Bytes - 20000
5003|4|""|1		  #*  Bytes - 30000
5003|5|""|1		  #*  Bytes - 40000
5003|6|""|1		  #*  Bytes - 50000

# Ausgaenge
#5004|ausgang|Initwert|runden binär (0/1)|typ (1-send/2-sbc)|0=numerisch 1=alphanummerisch
5004|1|0|0|1|0 #* A1 Unauthorized Access Counter

#################################################

5012|0|"EI"|"eval(compile(__import__('base64').decodestring('CmlmIEVJPT0xOgogIGdsb2JhbCBhc0RpY3QKICBkZWYgYXNEaWN0KG8pOgogICAgICByZXR1cm4gby5fX2RpY3RfXwogIGdsb2JhbCBIVFRQU2VydmVyCiAgZ2xvYmFsIEJhc2VIVFRQUmVxdWVzdEhhbmRsZXIKICBmcm9tIEJhc2VIVFRQU2VydmVyIGltcG9ydCBIVFRQU2VydmVyLEJhc2VIVFRQUmVxdWVzdEhhbmRsZXIKICBnbG9iYWwgVGhyZWFkaW5nTWl4SW4KICBmcm9tIFNvY2tldFNlcnZlciBpbXBvcnQgVGhyZWFkaW5nTWl4SW4KICBnbG9iYWwganNvbgogIGltcG9ydCBqc29uCiAgZ2xvYmFsIEFtYXpvbkVjaG8KICBjbGFzcyBBbWF6b25FY2hvKFRocmVhZGluZ01peEluLCBIVFRQU2VydmVyKToKICAgIEhTID0gVHJ1ZQogICAgREVMQVkgPSAyMAogICAgTUlOX0ZJUk1XQVJFX1ZFUlNJT04gPSA0LjIKICAgIFBBUlRfU0laRSA9IDEwMDAwCiAgICBNQVhfUEFSVCA9IDUKICAgIGlmIEhTOgogICAgICBQQVRIX0JBU0UgPSAiL3RtcC8iCiAgICBlbHNlOgogICAgICBQQVRIX0JBU0UgPSAiIgogICAgRklMRU5BTUVfQ0VSVCA9ICJhbWF6b25FY2hvU1NMLmNlcnQiCiAgICBGSUxFUEFUSF9DRVJUID0gUEFUSF9CQVNFICsgRklMRU5BTUVfQ0VSVAogICAgRklMRU5BTUVfTE9HID0gIjEzNjI2LmxvZyIKICAgIEZJTEVQQVRIX0xPRyA9IFBBVEhfQkFTRSArIEZJTEVOQU1FX0xPRwogICAgVVJMX0JBU0UgPSAiYW1hem9uRWNoby8iCiAgICBVUkxfU0hPV19TU0wgPSBVUkxfQkFTRSArICJzc2xDZXJ0Lmh0bSIKICAgIFVSTF9TSE9XX0xPRyA9IFVSTF9CQVNFICsgImxvZy5odG0iCiAgICBhbGxvd19yZXVzZV9hZGRyZXNzID0gVHJ1ZQogICAgZGVmIF9faW5pdF9fKHNlbGYsIGxvY2Fscyk6CiAgICAgIHNlbGYubG9jYWxzID0gbG9jYWxzOwogICAgICBzZWxmLmxvZ2lrID0gbG9jYWxzWydwSXRlbSddCiAgICAgIHNlbGYuTUMgPSBzZWxmLmxvZ2lrLk1DCiAgICAgIHNlbGYuaHNJcCA9IHNlbGYuTUMuRXRoZXJuZXQuSVBBZHIKICAgICAgc2VsZi5oc1BvcnQgPSBzZWxmLk1DLkV0aGVybmV0LklQUG9ydAogICAgICBFTiA9IGxvY2Fsc1snRU4nXQogICAgICBzZWxmLlNUQVJUID0gRU5bMV0KICAgICAgc2VsZi5wb3J0ID0gaW50KEVOWzJdKQogICAgICBzZWxmLmFjY2Vzc1Rva2VuID0gRU5bM10uZGVjb2RlKCdpc284ODU5LTEnKQogICAgICBzZWxmLmxvZ0xldmVsID0gRU5bNF0KICAgICAgc2VsZi5pbml0aWFsaXplZCA9IEZhbHNlCiAgICAgIHNlbGYuY2VydFRleHQgPSAiIgogICAgICBzZWxmLnNlcnZlclRocmVhZCA9IE5vbmUKICAgICAgc2VsZi51bmF1dGhvcml6ZWRDb3VudGVyID0gMAogICAgICBzZWxmLnZlcnNpb24gPSB1J0FtYXpvbiBFY2hvIFNlcnZpY2UgVjAuMyB2b20gMTYuMDEuMjAxNyAwNDoxNyAgLSAgKFB5dGhvbiBWZXJzaW9uOiAnICsgc2VsZi5fZ2V0UHl0aG9uVmVyc2lvbigpICsgJyBEZWZhdWx0IEVuY29kaW5nOicgKyBzZWxmLl9nZXREZWZhdWx0RW5jb2RpbmcoKSArICcpJwogICAgICB0cnk6CiAgICAgICAgaW1wb3J0IGNvZGVjcwogICAgICAgIHNlbGYubG9nRmlsZSA9IGNvZGVjcy5vcGVuKHNlbGYuRklMRVBBVEhfTE9HLCAidysiLCAiSVNPLTg4NTktMSIpCiAgICAgICAgc2VsZi5sb2coc2VsZi52ZXJzaW9uKQogICAgICAgIHNlbGYuZmlybXdhcmVWZXJzaW9uID0gc2VsZi5fZ2V0RmlybXdhcmVWZXJzaW9uKCkKICAgICAgICBzZWxmLmZpcm13YXJlT2sgPSBzZWxmLmZpcm13YXJlVmVyc2lvbiA+PSBzZWxmLk1JTl9GSVJNV0FSRV9WRVJTSU9OCiAgICAgICAgaWYgbm90IHNlbGYuZmlybXdhcmVPazoKICAgICAgICAgIHNlbGYubG9nKCJTb3JyeSwgeW91ciBHaXJhLUhvbWVzZXJ2ZXIgRmlybXdhcmUgaXMgbm90IHN1cHBvcnRlZCAtIGZvdW5kID0gJ3swfScgbmVlZGVkID49ICd7MX0nLiIsIHNlbGYuZmlybXdhcmVWZXJzaW9uLCBzZWxmLk1JTl9GSVJNV0FSRV9WRVJTSU9OKQogICAgICAgICAgcmV0dXJuCiAgICAgICAgc2VsZi5sb2coIkluaXRpYXRlIHswfSBzZWNvbmRzIGRlbGF5IGZvciBIUyB0byBiZSBmdWxseSB1cCBhbmQgcnVubmluZyAuLi4iLCBBbWF6b25FY2hvLkRFTEFZKQogICAgICAgIEFtYXpvbkVjaG9XZWJDYWxsYmFjayhzZWxmLmxvZ2lrLCBzZWxmLCBzZWxmLndlYkNhbGxiYWNrU1NMQ2VydCwgc2VsZi5VUkxfU0hPV19TU0wpCiAgICAgICAgQW1hem9uRWNob1dlYkNhbGxiYWNrKHNlbGYubG9naWssIHNlbGYsIHNlbGYud2ViQ2FsbGJhY2tMb2csIHNlbGYuVVJMX1NIT1dfTE9HKQogICAgICBleGNlcHQ6CiAgICAgICAgc2VsZi5NQy5EZWJ1Zy5zZXRFcnIoc3lzLmV4Y19pbmZvKCksIkFtYXpvbkVjaG86IF9faW5pdF9fKCkgZmFpbGVkLiIpCiAgICBkZWYgX2dldFB5dGhvblZlcnNpb24oc2VsZik6CiAgICAgIGltcG9ydCBzeXMKICAgICAgcmV0dXJuIHN0cihzeXMudmVyc2lvbl9pbmZvKQogICAgZGVmIF9nZXREZWZhdWx0RW5jb2Rpbmcoc2VsZik6CiAgICAgIGltcG9ydCBzeXMKICAgICAgcmV0dXJuIHN0cihzeXMuZ2V0ZGVmYXVsdGVuY29kaW5nKCkpCiAgICBkZWYgX2dldEZpcm13YXJlVmVyc2lvbihzZWxmKToKICAgICAgaW1wb3J0IHJlCiAgICAgIF9maXJtd2FyZSA9IHJlLmZpbmRhbGwoIl4oXGQrXC5cZCspIiwgc2VsZi5NQy5EZWJ1Zy5WZXJzaW9uKQogICAgICBpZiBub3QgX2Zpcm13YXJlOgogICAgICAgIF9maXJtd2FyZSA9IFsiMC4wIl0KICAgICAgcmV0dXJuIGZsb2F0KF9maXJtd2FyZVswXSkKICAgIGRlZiBpbml0KHNlbGYpOgogICAgICBpZiBub3Qgc2VsZi5maXJtd2FyZU9rOgogICAgICAgIHJldHVybgogICAgICB0cnk6CiAgICAgICAgc2VsZi5sb2coIkluaXRpYWxpemUgQW1hem9uIEVjaG8gU2VydmljZS4iKQogICAgICAgIHNlbGYuY2VydFRleHQgPSBzZWxmLmdldFNTTENlcnQoc2VsZi5oc0lwLCBzZWxmLmhzUG9ydCwgc2VsZi5GSUxFTkFNRV9DRVJUKQogICAgICAgIGlmIHNlbGYuY2VydFRleHQgIT0gIiI6CiAgICAgICAgICB0cnk6CiAgICAgICAgICAgIHNlbGYuY2VydFRleHQuaW5kZXgoIlByb2MtVHlwZTogNCxFTkNSWVBURUQiKQogICAgICAgICAgICBzZWxmLmxvZygiU1NMIGNlcnRpZmljYXRlcyB3aGljaCBuZWVkcyBhIHBhc3NwaHJhc2UgYXJlIG5vdCBzdXBwb3J0ZWQuIFBsZWFzZSByZW1vdmUgcGFzc3BocmFzZSBhbmQgdXBsb2FkIGFnYWluLiIpCiAgICAgICAgICAgIHNlbGYuY2VydFRleHQgPSAiIgogICAgICAgICAgZXhjZXB0IFZhbHVlRXJyb3I6CiAgICAgICAgICAgIHNlbGYubG9nKCJTU0wgY2VydGlmaWNhdGUgbG9hZGVkIHN1Y2Nlc3NmdWxseSAtIHdyaXRpbmcgaXQgdG8gZmlsZSAnezB9Jy4iLCBzZWxmLkZJTEVQQVRIX0NFUlQpCiAgICAgICAgICAgIHdpdGggb3BlbihzZWxmLkZJTEVQQVRIX0NFUlQsICJ3YiIpIGFzIG91dHB1dDoKICAgICAgICAgICAgICBvdXRwdXQud3JpdGUoc2VsZi5jZXJ0VGV4dCkKICAgICAgICBzZWxmLmluaXRfZGVidWdfZW50cnkoKTsKICAgICAgICBzZWxmLnJlYWRBcHBsaWFuY2VzQ29uZigpCiAgICAgICAgc2VsZi5pbml0aWFsaXplZCA9IFRydWUKICAgICAgICBpZiBzZWxmLlNUQVJUOgogICAgICAgICAgc2VsZi5zdGFydCgpCiAgICAgIGV4Y2VwdDoKICAgICAgICBzZWxmLk1DLkRlYnVnLnNldEVycihzeXMuZXhjX2luZm8oKSwiQW1hem9uRWNobzogaW5pdCgpIGZhaWxlZC4iKQogICAgZGVmIHN0YXJ0KHNlbGYpOgogICAgICBpZiBub3Qgc2VsZi5maXJtd2FyZU9rOgogICAgICAgIHJldHVybgogICAgICB0cnk6CiAgICAgICAgaWYgbm90IHNlbGYuaW5pdGlhbGl6ZWQ6CiAgICAgICAgICBzZWxmLlNUQVJUID0gVHJ1ZQogICAgICAgICAgcmV0dXJuCiAgICAgICAgaWYgc2VsZi5zZXJ2ZXJUaHJlYWQgaXMgTm9uZToKICAgICAgICAgIHNlbGYubG9nKCJTdGFydGluZyBBbWF6b24gRWNobyBTZXJ2aWNlLiIpCiAgICAgICAgICBzZWxmLnVuYXV0aG9yaXplZENvdW50ZXIgPSAwIAogICAgICAgICAgSFRUUFNlcnZlci5fX2luaXRfXyhzZWxmLCAoc2VsZi5oc0lwLCBzZWxmLnBvcnQpLCBzZWxmLkhUVFBSZXF1ZXN0SGFuZGxlcikKICAgICAgICAgIGlmIHNlbGYuY2VydFRleHQgIT0gIiI6CiAgICAgICAgICAgIGltcG9ydCBzc2wKICAgICAgICAgICAgc2VsZi5zb2NrZXQgPSBzc2wud3JhcF9zb2NrZXQoc2VsZi5zb2NrZXQsIGNlcnRmaWxlPXNlbGYuRklMRVBBVEhfQ0VSVCwgc2VydmVyX3NpZGU9VHJ1ZSkKICAgICAgICAgIGZyb20gaHNfcXVldWUgaW1wb3J0IGhzX3RocmVhZGluZyBhcyB0aHJlYWRpbmcKICAgICAgICAgIHNlbGYuc2VydmVyVGhyZWFkID0gdGhyZWFkaW5nLlRocmVhZCh0YXJnZXQ9c2VsZi5zZXJ2ZV9mb3JldmVyLCBuYW1lPSdhbWF6b25fZWNob19zZXJ2ZXInKQogICAgICAgICAgc2VsZi5zZXJ2ZXJUaHJlYWQuZGFlbW9uID0gVHJ1ZQogICAgICAgICAgc2VsZi5zZXJ2ZXJUaHJlYWQuc3RhcnQoKQogICAgICAgIGVsc2U6CiAgICAgICAgICBzZWxmLmxvZygiQW1hem9uIEVjaG8gU2VydmljZSBhbHJlYWR5IHN0YXJ0ZWQuIikKICAgICAgZXhjZXB0OgogICAgICAgIHNlbGYuTUMuRGVidWcuc2V0RXJyKHN5cy5leGNfaW5mbygpLCJBbWF6b25FY2hvOiBzdGFydCgpIGZhaWxlZC4iKQogICAgZGVmIHN0b3Aoc2VsZik6CiAgICAgIGlmIG5vdCBzZWxmLmZpcm13YXJlT2s6CiAgICAgICAgcmV0dXJuCiAgICAgIHRyeToKICAgICAgICBpZiBub3Qgc2VsZi5pbml0aWFsaXplZDoKICAgICAgICAgIHNlbGYuU1RBUlQgPSBmYWxzZQogICAgICAgICAgcmV0dXJuCiAgICAgICAgaWYgc2VsZi5zZXJ2ZXJUaHJlYWQgaXMgbm90IE5vbmU6CiAgICAgICAgICBIVFRQU2VydmVyLnNodXRkb3duKHNlbGYpCiAgICAgICAgICBzZWxmLnNvY2tldC5jbG9zZSgpCiAgICAgICAgICBzZWxmLnNlcnZlclRocmVhZCA9IE5vbmUKICAgICAgICBzZWxmLmxvZygiQW1hem9uIEVjaG8gU2VydmljZSBzdG9wcGVkLiIpCiAgICAgIGV4Y2VwdDoKICAgICAgICBzZWxmLk1DLkRlYnVnLnNldEVycihzeXMuZXhjX2luZm8oKSwiQW1hem9uRWNobzogc3RvcCgpIGZhaWxlZC4iKQogICAgZGVmIHJlYWRBcHBsaWFuY2VzQ29uZihzZWxmKToKICAgICAgc2VsZi5kZWJ1ZygicmVhZEFwcGxpYW5jZXNDb25mKCkiKQogICAgICB0cnk6CiAgICAgICAgc2VsZi5hcHBsaWFuY2VzID0gTm9uZQogICAgICAgIFNOID0gc2VsZi5sb2NhbHNbJ1NOJ10KICAgICAgICBhcHBsaWFuY2VzVGV4dCA9ICIiCiAgICAgICAgZm9yIGlkeCBpbiByYW5nZSgwLCBzZWxmLk1BWF9QQVJUKToKICAgICAgICAgIHBhcnQgPSBTTltpZHggKyAyXQogICAgICAgICAgaWYgcGFydCBpcyBub3QgTm9uZSBhbmQgdHlwZShwYXJ0KSBpcyBzdHI6CiAgICAgICAgICAgIGFwcGxpYW5jZXNUZXh0ICs9IHBhcnQKICAgICAgICBpZiBhcHBsaWFuY2VzVGV4dC5zdHJpcCgpICE9ICIiOgogICAgICAgICAgdHJ5OgogICAgICAgICAgICBzZWxmLmFwcGxpYW5jZXMgPSBqc29uLmxvYWRzKHNlbGYucmVtb3ZlQ29tbWVudHMoYXBwbGlhbmNlc1RleHQpLCBlbmNvZGluZz0idXRmLTgiKQogICAgICAgICAgZXhjZXB0IFVuaWNvZGVEZWNvZGVFcnJvcjoKICAgICAgICAgICAgc2VsZi5pbmZvKCJUcnlpbmcgdG8gY29udmVydCBhcHBsaWFuY2VzIGNvbmZpZ3VyYXRpb24gZm9ybSAnaXNvODg1OS0xJyB0byAndXRmLTgnLiIpCiAgICAgICAgICAgIGFwcGxpYW5jZXNUZXh0ID0gYXBwbGlhbmNlc1RleHQuZGVjb2RlKCdpc284ODU5LTEnKS5lbmNvZGUoJ3V0Zi04JykKICAgICAgICAgICAgc2VsZi5pbmZvKCJBcHBsaWFuY2VzIGNvbmZpZ3VyYXRpb24gc3VjY2Vzc2Z1bGx5IGNvbnZlcnRlZC4iKQogICAgICAgICAgICBzZWxmLnNhdmVBcHBsaWFuY2VzQ29uZihhcHBsaWFuY2VzVGV4dCkKICAgICAgICAgIHNlbGYuaW5mbygiQXBwbGlhbmNlcyBjb25maWd1cmF0aW9uIHN1Y2Nlc3NmdWxseSBsb2FkZWQuIikKICAgICAgICBlbHNlOgogICAgICAgICAgc2VsZi53YXJuKCJBcHBsaWFuY2VzIGNvbmZpZ3VyYXRpb24gaXMgZW1wdHkuIikKICAgICAgZXhjZXB0OgogICAgICAgIHNlbGYuZXhjKCJKc29uIGV4Y2VwdGlvbiB3aGlsZSBwYXJzaW5nIGFwcGxpYW5jZXMgY29uZmlndXJhdGlvbjoiKQogICAgZGVmIHNhdmVBcHBsaWFuY2VzQ29uZihzZWxmLCBhcHBsaWFuY2VzVGV4dCk6CiAgICAgIHNlbGYuaW5mbygiVHJ5aW5nIHRvIHNhdmUgYXBwbGlhbmNlcyBjb25maWd1cmF0aW9uLiIpCiAgICAgIG1zZyA9ICIiCiAgICAgIHN5bnRheEVycm9yID0gRmFsc2UKICAgICAgdHJ5OgogICAgICAgIGlmIGFwcGxpYW5jZXNUZXh0ICE9ICIiOgogICAgICAgICAganNvblRleHQgPSBzZWxmLnJlbW92ZUNvbW1lbnRzKGFwcGxpYW5jZXNUZXh0KQogICAgICAgICAgc2VsZi5hcHBsaWFuY2VzID0ganNvbi5sb2Fkcyhqc29uVGV4dCwgZW5jb2Rpbmc9InV0Zi04IikKICAgICAgICAgIHNlbGYuaW5mbygiQXBwbGlhbmNlcyBjb25maWd1cmF0aW9uIHN1Y2Nlc3NmdWxseSBzYXZlZC4iKQogICAgICAgIGVsc2U6CiAgICAgICAgICBzZWxmLmFwcGxpYW5jZXMgPSBOb25lCiAgICAgICAgICBzZWxmLndhcm4oIkFwcGxpYW5jZXMgY29uZmlndXJhdGlvbiB3YXMgZW1wdHkuIikKICAgICAgICBTTiA9IHNlbGYubG9jYWxzWydTTiddCiAgICAgICAgYXBwbGlhbmNlc0xlbiA9IGxlbihhcHBsaWFuY2VzVGV4dCkKICAgICAgICBpZiBhcHBsaWFuY2VzTGVuIDw9IChzZWxmLk1BWF9QQVJUICogc2VsZi5QQVJUX1NJWkUpOgogICAgICAgICAgaWR4ID0gMAogICAgICAgICAgd2hpbGUgaWR4IDwgc2VsZi5NQVhfUEFSVDoKICAgICAgICAgICAgaWYgYXBwbGlhbmNlc0xlbiA+IChpZHggKyAxKSAqIHNlbGYuUEFSVF9TSVpFOgogICAgICAgICAgICAgIFNOW2lkeCArIDJdID0gYXBwbGlhbmNlc1RleHRbaWR4ICogc2VsZi5QQVJUX1NJWkU6IChpZHggKyAxKSAqIHNlbGYuUEFSVF9TSVpFXQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgIFNOW2lkeCArIDJdID0gYXBwbGlhbmNlc1RleHRbaWR4ICogc2VsZi5QQVJUX1NJWkU6XQogICAgICAgICAgICAgIGlkeCArPSAxCiAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgaWR4ICs9IDEKICAgICAgICAgIHdoaWxlIGlkeCA8IHNlbGYuTUFYX1BBUlQ6CiAgICAgICAgICAgIFNOW2lkeCArIDJdID0gTm9uZQogICAgICAgICAgICBpZHggKz0gMQogICAgICAgIGVsc2U6CiAgICAgICAgICBtc2cgPSB1IkNvbmZpZ3VyYXRpb24gbm90IHNhdmVkLiBMZW5ndGggZXhjZWVkcyBtYXggb2YgezB9IGJ5dGVzLiIuZm9ybWF0KHNlbGYuTUFYX1BBUlQgKiBzZWxmLlBBUlRfU0laRSkKICAgICAgICAgIHJldHVybiBtc2csIHN5bnRheEVycm9yCiAgICAgICAgZm9yIGlkeCBpbiByYW5nZSgwLCBzZWxmLk1BWF9QQVJUKTogCiAgICAgICAgICBzZWxmLmxvZ2lrLlNwZWljaGVyV2VydFtpZHggKyAxXSA9IFNOW2lkeCArIDJdCiAgICAgICAgc2VsZi5NQy5TaWNoUXVldWUucHV0KFsxMDAsIHNlbGYubG9naWssIHNlbGYubG9naWsuU3BlaWNoZXJXZXJ0XSkKICAgICAgZXhjZXB0IFZhbHVlRXJyb3I6CiAgICAgICAgc2VsZi5leGMoIkpzb24gZXhjZXB0aW9uIHdoaWxlIHBhcnNpbmcgYXBwbGlhbmNlcyBjb25maWd1cmF0aW9uOiIpCiAgICAgICAgbXNnID0gIkZhaWxlZCB0byBwYXJzZSBhcHBsaWFuY2VzIGNvbmZpZ3VyYXRpb24uIgogICAgICAgIHN5bnRheEVycm9yID0gVHJ1ZQogICAgICByZXR1cm4gbXNnLCBzeW50YXhFcnJvcgogICAgZGVmIHJlbW92ZUNvbW1lbnRzKHNlbGYsIHN0cmluZyk6CiAgICAgIGltcG9ydCByZSAgICAKICAgICAgcGF0dGVybiA9IHIiKFwiLio/XCJ8XCcuKj9cJyl8KC9cKi4qP1wqL3wvL1teXG5dKiQpIgogICAgICByZWdleCA9IHJlLmNvbXBpbGUocGF0dGVybiwgcmUuTVVMVElMSU5FfHJlLkRPVEFMTCkKICAgICAgZGVmIF9yZXBsYWNlcihtYXRjaCk6CiAgICAgICAgaWYgbWF0Y2guZ3JvdXAoMikgaXMgbm90IE5vbmU6CiAgICAgICAgICByZXR1cm4gIiIKICAgICAgICBlbHNlOgogICAgICAgICAgcmV0dXJuIG1hdGNoLmdyb3VwKDEpCiAgICAgIHJldHVybiByZWdleC5zdWIoX3JlcGxhY2VyLCBzdHJpbmcpCiAgICBkZWYgZGlzY292ZXJ5KHNlbGYsIG1lc3NhZ2VJZCwgY3VzdG9tU2tpbGwpOgogICAgICByZXNwb25zZU9iamVjdCA9IEFtYXpvbkVjaG8uRGlzY292ZXJ5UmVzcG9uc2UobWVzc2FnZUlkKQogICAgICBpZiBzZWxmLmFwcGxpYW5jZXMgaXMgbm90IE5vbmU6CiAgICAgICAgaWQgPSAwCiAgICAgICAgZm9yIGRldmljZSBpbiBzZWxmLmFwcGxpYW5jZXM6CiAgICAgICAgICByb29tID0gZGV2aWNlLmdldCgncm9vbScpCiAgICAgICAgICBpZCArPSAxCiAgICAgICAgICBpZFN0ciA9IGRldmljZS5nZXQoJ2lkJykKICAgICAgICAgIGlmIGlkU3RyIGlzIE5vbmU6CiAgICAgICAgICAgIGlkU3RyID0gc3RyKGlkKQogICAgICAgICAgYXBwbGlhbmNlcyA9IGRldmljZS5nZXQoJ2FwcGxpYW5jZXMnKQogICAgICAgICAgaWYgYXBwbGlhbmNlcyBpcyBOb25lOgogICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgamQgPSAwCiAgICAgICAgICBmb3IgYXBwbGlhbmNlIGluIGFwcGxpYW5jZXM6ICAgICAgICAgIAogICAgICAgICAgICBqZCArPSAxCiAgICAgICAgICAgIHR5cGUgPSBOb25lCiAgICAgICAgICAgIG9uT2ZmID0gYXBwbGlhbmNlLmdldCgnb25PZmYnKTsKICAgICAgICAgICAgaWYgb25PZmYgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgdHlwZSA9ICdTd2l0Y2hhYmxlJwogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgIG9uID0gYXBwbGlhbmNlLmdldCgnb24nKQogICAgICAgICAgICAgIG9mZiA9IGFwcGxpYW5jZS5nZXQoJ29mZicpCiAgICAgICAgICAgICAgaWYgb24gaXMgbm90IE5vbmUgYW5kIG9mZiBpcyBub3QgTm9uZToKICAgICAgICAgICAgICAgIHR5cGUgPSAnU3dpdGNoYWJsZScKICAgICAgICAgICAgICBlbGlmIG9uIGlzIG5vdCBOb25lOgogICAgICAgICAgICAgICAgdHlwZSA9ICdTd2l0Y2hPbicKICAgICAgICAgICAgICBlbGlmIG9mZiBpcyBub3QgTm9uZToKICAgICAgICAgICAgICAgIHR5cGUgPSAnU3dpdGNoT2ZmJwogICAgICAgICAgICBwZXJjZW50ID0gYXBwbGlhbmNlLmdldCgncGVyY2VudCcpOwogICAgICAgICAgICBpZiBwZXJjZW50IGlzIG5vdCBOb25lOgogICAgICAgICAgICAgIHR5cGUgPSAnTGlnaHRpbmcnCiAgICAgICAgICAgIGlmIHJvb20gaXMgbm90IE5vbmUgYW5kIHJvb20gIT0gIiI6CiAgICAgICAgICAgICAgaWYgamQgPT0gMToKICAgICAgICAgICAgICAgIGlmIGRldmljZS5nZXQoJ3RhcmdldFRlbXBlcmF0dXJlJykgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICAgIGRpc2NvdmVyeUFwcGxpYW5jZSA9IEFtYXpvbkVjaG8uRGlzY292ZXJ5QXBwbGlhbmNlKGlkU3RyLCByb29tLCAiVGhlcm1vc3RhdCIpCiAgICAgICAgICAgICAgICAgIHJlc3BvbnNlT2JqZWN0LmFkZEFwcGxpYW5jZShkaXNjb3ZlcnlBcHBsaWFuY2UpCiAgICAgICAgICAgICAgICBlbGlmIGN1c3RvbVNraWxsOgogICAgICAgICAgICAgICAgICBpZiAoZGV2aWNlLmdldCgnYWN0dWFsVGVtcGVyYXR1cmUnKSBpcyBub3QgTm9uZQogICAgICAgICAgICAgICAgICAgIG9yIGRldmljZS5nZXQoJ3RleHQnKSBpcyBub3QgTm9uZSk6CiAgICAgICAgICAgICAgICAgICAgZGlzY292ZXJ5QXBwbGlhbmNlID0gQW1hem9uRWNoby5EaXNjb3ZlcnlBcHBsaWFuY2UoaWRTdHIsIHJvb20sIE5vbmUpCiAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2VPYmplY3QuYWRkQXBwbGlhbmNlKGRpc2NvdmVyeUFwcGxpYW5jZSkKICAgICAgICAgICAgICBuYW1lID0gYXBwbGlhbmNlLmdldCgnbmFtZScpCiAgICAgICAgICAgICAgaWYgbmFtZSBpcyBOb25lOgogICAgICAgICAgICAgICAgbmFtZSA9IHJvb20KICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgbmFtZSA9IHJvb20gKyAiICIgKyBuYW1lCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgbmFtZSA9IGFwcGxpYW5jZS5nZXQoJ25hbWUnKQogICAgICAgICAgICAgIGlmIG5hbWUgaXMgTm9uZToKICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgIGpkU3RyID0gYXBwbGlhbmNlLmdldCgnaWQnKQogICAgICAgICAgICBpZiBqZFN0ciBpcyBOb25lOgogICAgICAgICAgICAgIGpkU3RyID0gc3RyKGpkKQogICAgICAgICAgICBpZiBjdXN0b21Ta2lsbCBvciB0eXBlIGlzIG5vdCBOb25lOgogICAgICAgICAgICAgIGRpc2NvdmVyeUFwcGxpYW5jZSA9IEFtYXpvbkVjaG8uRGlzY292ZXJ5QXBwbGlhbmNlKGlkU3RyICsgIl8iICsgamRTdHIsIG5hbWUsIHR5cGUpCiAgICAgICAgICAgICAgcmVzcG9uc2VPYmplY3QuYWRkQXBwbGlhbmNlKGRpc2NvdmVyeUFwcGxpYW5jZSkKICAgICAgICAgICAgICBhbGlhc2VzID0gYXBwbGlhbmNlLmdldCgnYWxpYXNlcycpOwogICAgICAgICAgICAgIGlmIGFsaWFzZXMgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICBrZCA9IDAKICAgICAgICAgICAgICAgIGZvciBhbGlhcyBpbiBhbGlhc2VzOgogICAgICAgICAgICAgICAgICBrZCArPSAxCiAgICAgICAgICAgICAgICAgIGRpc2NvdmVyeUFwcGxpYW5jZSA9IEFtYXpvbkVjaG8uRGlzY292ZXJ5QXBwbGlhbmNlKGlkU3RyICsgIl8iICsgamRTdHIgKyAiXyIgKyBzdHIoa2QpLCBhbGlhcywgdHlwZSkKICAgICAgICAgICAgICAgICAgcmVzcG9uc2VPYmplY3QuYWRkQXBwbGlhbmNlKGRpc2NvdmVyeUFwcGxpYW5jZSkKICAgICAgc2VsZi5pbmZvKCJEaXNjb3ZlcnkgZm91bmQgezB9IGFwcGxpYW5jZXMuIChtZXNzYWdlSWQ9J3sxfScpLiIsIHJlc3BvbnNlT2JqZWN0LmdldE5yT2ZBcHBsaWFuY2VzKCksIG1lc3NhZ2VJZCkKICAgICAgcmV0dXJuIHJlc3BvbnNlT2JqZWN0CiAgICBkZWYgY29udHJvbChzZWxmLCBtZXNzYWdlSWQsIGFwcGxpYW5jZUlkLCByZXF1ZXN0LCB2YWx1ZSk6CiAgICAgIHJlc3BvbnNlT2JqZWN0ID0gQW1hem9uRWNoby5Db250cm9sUmVzcG9uc2UobWVzc2FnZUlkKQogICAgICBhcHBsaWFuY2VzVGV4dElzRW1wdHkgPSBUcnVlCiAgICAgIGFwcGxpYW5jZXNUZXh0UGFydDEgPSBzZWxmLmxvY2Fsc1snU04nXVsyXQogICAgICBpZiBhcHBsaWFuY2VzVGV4dFBhcnQxIGlzIG5vdCBOb25lIGFuZCB0eXBlKGFwcGxpYW5jZXNUZXh0UGFydDEpIGlzIHN0ciBhbmQgYXBwbGlhbmNlc1RleHRQYXJ0MS5zdHJpcCgpICE9ICIiOgogICAgICAgIGFwcGxpYW5jZXNUZXh0SXNFbXB0eSA9IEZhbHNlCiAgICAgIGlmIGFwcGxpYW5jZXNUZXh0SXNFbXB0eToKICAgICAgICByZXNwb25zZU9iamVjdC5zZXROYW1lKCJOb1N1Y2hUYXJnZXRFcnJvciIpCiAgICAgICAgcmVzcG9uc2VPYmplY3QuYWRkUGF5bG9hZCgiZXJyb3IiLCAiY29kZSIsICJBRV8xMCIpCiAgICAgICAgcmVzcG9uc2VPYmplY3QuYWRkUGF5bG9hZCgiZXJyb3IiLCAibXNnIiwgImFwcGxpYW5jZSBjb25maWd1cmF0aW9uIGlzIGVtcHR5IikKICAgICAgICByZXR1cm4gcmVzcG9uc2VPYmplY3QKICAgICAgYXBwbGlhbmNlID0gc2VsZi5maW5kQXBwbGlhbmNlKGFwcGxpYW5jZUlkKQogICAgICBpZiBhcHBsaWFuY2UgaXMgTm9uZToKICAgICAgICBzZWxmLmVycm9yKHUiQ29udHJvbDogYXBwbGlhbmNlIHdpdGggaWQ9J3swfScgbm90IGZvdW5kLiAobWVzc2FnZUlkPSd7MX0nKSIsIGFwcGxpYW5jZUlkLCBtZXNzYWdlSWQpCiAgICAgICAgcmVzcG9uc2VPYmplY3Quc2V0TmFtZSgiTm9TdWNoVGFyZ2V0RXJyb3IiKQogICAgICAgIHJlc3BvbnNlT2JqZWN0LmFkZFBheWxvYWQoImVycm9yIiwgImNvZGUiLCAiQUVfMTEiKQogICAgICAgIHJlc3BvbnNlT2JqZWN0LmFkZFBheWxvYWQoImVycm9yIiwgIm1zZyIsICJhcHBsaWFuY2Ugbm90IGZvdW5kIikKICAgICAgICByZXNwb25zZU9iamVjdC5hZGRQYXlsb2FkKCJlcnJvciIsICJhcHBsaWFuY2VJZCIsIGFwcGxpYW5jZUlkKQogICAgICAgIHJldHVybiByZXNwb25zZU9iamVjdAogICAgICB0cnk6CiAgICAgICAgb25WYWx1ZSA9IDEuMAogICAgICAgIG9mZlZhbHVlID0gMC4wCiAgICAgICAgaWYgcmVxdWVzdCA9PSAnVHVybk9uUmVxdWVzdCcgb3IgcmVxdWVzdCA9PSAnVHVybk9mZlJlcXVlc3QnOgogICAgICAgICAgYXBwbGlhbmNlVmFsdWUgPSBhcHBsaWFuY2UuZ2V0KCdvblZhbHVlJykKICAgICAgICAgIGlmIGFwcGxpYW5jZVZhbHVlIGlzIG5vdCBOb25lOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgb25WYWx1ZSA9IGZsb2F0KGFwcGxpYW5jZVZhbHVlKQogICAgICAgICAgICBleGNlcHQgVmFsdWVFcnJvcjoKICAgICAgICAgICAgICBzZWxmLmVycm9yKHUiQ29udHJvbDogaWxsZWdhbCBkZWZhdWx0IHZhbHVlPSd7MH0nIChub3QgcGFyc2VhYmxlIGFzIGZsb2F0KSBmb3IgYXBwbGlhbmNlIHdpdGggaWQ9J3sxfScuIChyZXF1ZXN0PSd7Mn0nLCBtZXNzYWdlSWQ9J3szfScpIiwgYXBwbGlhbmNlVmFsdWUsIGFwcGxpYW5jZUlkLCByZXF1ZXN0LCBtZXNzYWdlSWQpCiAgICAgICAgICAgICAgcmVzcG9uc2VPYmplY3Quc2V0TmFtZSgiVW5zdXBwb3J0ZWRUYXJnZXRTZXR0aW5nRXJyb3IiKQogICAgICAgICAgICAgIHJldHVybiByZXNwb25zZU9iamVjdAogICAgICAgICAgYXR0cmlidXRlTmFtZSA9IE5vbmUKICAgICAgICAgIGlmIGFwcGxpYW5jZS5nZXQoJ29uT2ZmJykgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIGF0dHJpYnV0ZU5hbWUgPSAnb25PZmYnCiAgICAgICAgICBpZiByZXF1ZXN0ID09ICdUdXJuT25SZXF1ZXN0JzoKICAgICAgICAgICAgaWYgYXR0cmlidXRlTmFtZSBpcyBOb25lOgogICAgICAgICAgICAgIGlmIGFwcGxpYW5jZS5nZXQoJ29uJykgaXMgTm9uZSBhbmQgYXBwbGlhbmNlLmdldCgnb2ZmJykgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICByZXNwb25zZU9iamVjdC5zZXROYW1lKCJVbnN1cHBvcnRlZE9wZXJhdGlvbkVycm9yIikKICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZU9iamVjdAogICAgICAgICAgICAgIGF0dHJpYnV0ZU5hbWUgPSAnb24nCiAgICAgICAgICAgIGtvID0gc2VsZi5maW5kS08oYXBwbGlhbmNlSWQsIGFwcGxpYW5jZSwgYXR0cmlidXRlTmFtZSwgbWVzc2FnZUlkKQogICAgICAgICAgICBzZWxmLmluZm8odSJDb250cm9sIGFwcGxpYW5jZSB3aXRoIGlkPSd7MH0nLCBuYW1lPSd7MX0nLCByZXF1ZXN0PSd7Mn0nLCBtZXNzYWdlSWQ9J3szfScuIiwgYXBwbGlhbmNlSWQsIGtvLlJQQ1RleHQuZGVjb2RlKCdpc284ODU5LTEnKSwgcmVxdWVzdCwgbWVzc2FnZUlkKQogICAgICAgICAgICBzZWxmLl9LTlhTZXRWYWx1ZShrbywgb25WYWx1ZSwgIlR1cm5PbkNvbmZpcm1hdGlvbiIsIHJlc3BvbnNlT2JqZWN0KQogICAgICAgICAgZWxpZiByZXF1ZXN0ID09ICdUdXJuT2ZmUmVxdWVzdCc6CiAgICAgICAgICAgIGlmIGF0dHJpYnV0ZU5hbWUgaXMgTm9uZToKICAgICAgICAgICAgICBpZiBhcHBsaWFuY2UuZ2V0KCdvZmYnKSBpcyBOb25lIGFuZCBhcHBsaWFuY2UuZ2V0KCdvbicpIGlzIG5vdCBOb25lOgogICAgICAgICAgICAgICAgcmVzcG9uc2VPYmplY3Quc2V0TmFtZSgiVW5zdXBwb3J0ZWRPcGVyYXRpb25FcnJvciIpCiAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2VPYmplY3QKICAgICAgICAgICAgICBhdHRyaWJ1dGVOYW1lID0gJ29mZicKICAgICAgICAgICAga28gPSBzZWxmLmZpbmRLTyhhcHBsaWFuY2VJZCwgYXBwbGlhbmNlLCBhdHRyaWJ1dGVOYW1lLCBtZXNzYWdlSWQpCiAgICAgICAgICAgIHNlbGYuaW5mbyh1IkNvbnRyb2wgYXBwbGlhbmNlIHdpdGggaWQ9J3swfScsIG5hbWU9J3sxfScsIHJlcXVlc3Q9J3syfScsIG1lc3NhZ2VJZD0nezN9Jy4iLCBhcHBsaWFuY2VJZCwga28uUlBDVGV4dC5kZWNvZGUoJ2lzbzg4NTktMScpLCByZXF1ZXN0LCBtZXNzYWdlSWQpCiAgICAgICAgICAgIHNlbGYuX0tOWFNldFZhbHVlKGtvLCBvZmZWYWx1ZSwgIlR1cm5PZmZDb25maXJtYXRpb24iLCByZXNwb25zZU9iamVjdCkKICAgICAgICBlbGlmIHJlcXVlc3QgPT0gJ1NldFBlcmNlbnRhZ2VSZXF1ZXN0JyBvciByZXF1ZXN0ID09ICdJbmNyZW1lbnRQZXJjZW50YWdlUmVxdWVzdCcgb3IgcmVxdWVzdCA9PSAnRGVjcmVtZW50UGVyY2VudGFnZVJlcXVlc3QnOgogICAgICAgICAgdHJ5OgogICAgICAgICAgICBmdmFsdWUgPSBmbG9hdCh2YWx1ZSkKICAgICAgICAgIGV4Y2VwdCBWYWx1ZUVycm9yOgogICAgICAgICAgICBzZWxmLmVycm9yKHUiSWxsZWdhbCByZXF1ZXN0IHZhbHVlPSd7MH0nIChub3QgcGFyc2VhYmxlIGFzIGZsb2F0KSBmb3IgYXBwbGlhbmNlIHdpdGggaWQ9J3sxfScuIChyZXF1ZXN0PSd7Mn0nLCBtZXNzYWdlSWQ9J3szfScpIiwgdmFsdWUsIGFwcGxpYW5jZUlkLCByZXF1ZXN0LCBtZXNzYWdlSWQpCiAgICAgICAgICAgIHJlc3BvbnNlT2JqZWN0LnNldE5hbWUoIlVuc3VwcG9ydGVkVGFyZ2V0U2V0dGluZ0Vycm9yIikKICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlT2JqZWN0CiAgICAgICAgICBrbyA9IHNlbGYuZmluZEtPKGFwcGxpYW5jZUlkLCBhcHBsaWFuY2UsICdwZXJjZW50JywgbWVzc2FnZUlkKQogICAgICAgICAgc2VsZi5pbmZvKHUiQ29udHJvbCBhcHBsaWFuY2Ugd2l0aCBpZD0nezB9JywgbmFtZT0nezF9JywgcmVxdWVzdD0nezJ9JywgdmFsdWU9J3s0fScsIG1lc3NhZ2VJZD0nezN9Jy4iLCBhcHBsaWFuY2VJZCwga28uUlBDVGV4dC5kZWNvZGUoJ2lzbzg4NTktMScpLCByZXF1ZXN0LCBtZXNzYWdlSWQsIHZhbHVlKQogICAgICAgICAgaWYgcmVxdWVzdCA9PSAnU2V0UGVyY2VudGFnZVJlcXVlc3QnOgogICAgICAgICAgICBzZWxmLl9LTlhTZXRQZXJjZW50KGtvLCBmdmFsdWUsICJTZXRQZXJjZW50YWdlQ29uZmlybWF0aW9uIiwgcmVzcG9uc2VPYmplY3QpCiAgICAgICAgICBlbGlmIHJlcXVlc3QgPT0gJ0luY3JlbWVudFBlcmNlbnRhZ2VSZXF1ZXN0JzoKICAgICAgICAgICAgc2VsZi5fS05YQWRkUGVyY2VudChrbywgZnZhbHVlLCAxLCAiSW5jcmVtZW50UGVyY2VudGFnZUNvbmZpcm1hdGlvbiIsIHJlc3BvbnNlT2JqZWN0KQogICAgICAgICAgZWxpZiByZXF1ZXN0ID09ICdEZWNyZW1lbnRQZXJjZW50YWdlUmVxdWVzdCc6CiAgICAgICAgICAgIHNlbGYuX0tOWEFkZFBlcmNlbnQoa28sIGZ2YWx1ZSwgLTEsICJEZWNyZW1lbnRQZXJjZW50YWdlQ29uZmlybWF0aW9uIiwgcmVzcG9uc2VPYmplY3QpCiAgICAgICAgZWxpZiByZXF1ZXN0ID09ICdTZXRUYXJnZXRUZW1wZXJhdHVyZVJlcXVlc3QnIG9yIHJlcXVlc3QgPT0gJ0luY3JlbWVudFRhcmdldFRlbXBlcmF0dXJlUmVxdWVzdCcgb3IgcmVxdWVzdCA9PSAnRGVjcmVtZW50VGFyZ2V0VGVtcGVyYXR1cmVSZXF1ZXN0JzoKICAgICAgICAgIHRyeToKICAgICAgICAgICAgZnZhbHVlID0gZmxvYXQodmFsdWUpCiAgICAgICAgICBleGNlcHQgVmFsdWVFcnJvcjoKICAgICAgICAgICAgc2VsZi5lcnJvcih1IklsbGVnYWwgcmVxdWVzdCB2YWx1ZT0nezB9JyAobm90IHBhcnNlYWJsZSBhcyBmbG9hdCkgZm9yIGFwcGxpYW5jZSB3aXRoIGlkPSd7MX0nLiAocmVxdWVzdD0nezJ9JywgbWVzc2FnZUlkPSd7M30nKSIsIHZhbHVlLCBhcHBsaWFuY2VJZCwgcmVxdWVzdCwgbWVzc2FnZUlkKQogICAgICAgICAgICByZXNwb25zZU9iamVjdC5zZXROYW1lKCJVbnN1cHBvcnRlZFRhcmdldFNldHRpbmdFcnJvciIpCiAgICAgICAgICAgIHJldHVybiByZXNwb25zZU9iamVjdAogICAgICAgICAga28gPSBzZWxmLmZpbmRLTyhhcHBsaWFuY2VJZCwgYXBwbGlhbmNlLCAndGFyZ2V0VGVtcGVyYXR1cmUnLCBtZXNzYWdlSWQpCiAgICAgICAgICBzZWxmLmluZm8odSJDb250cm9sIGFwcGxpYW5jZSB3aXRoIGlkPSd7MH0nLCBuYW1lPSd7MX0nLCByZXF1ZXN0PSd7Mn0nLCB2YWx1ZT0nezR9JywgbWVzc2FnZUlkPSd7M30nLiIsIGFwcGxpYW5jZUlkLCBrby5SUENUZXh0LmRlY29kZSgnaXNvODg1OS0xJyksIHJlcXVlc3QsIG1lc3NhZ2VJZCwgdmFsdWUpCiAgICAgICAgICBpZiByZXF1ZXN0ID09ICdTZXRUYXJnZXRUZW1wZXJhdHVyZVJlcXVlc3QnOgogICAgICAgICAgICBzZWxmLl9LTlhTZXRUZW1wZXJhdHVyZShrbywgZnZhbHVlLCAiU2V0VGFyZ2V0VGVtcGVyYXR1cmVDb25maXJtYXRpb24iLCByZXNwb25zZU9iamVjdCkKICAgICAgICAgIGVsaWYgcmVxdWVzdCA9PSAnSW5jcmVtZW50VGFyZ2V0VGVtcGVyYXR1cmVSZXF1ZXN0JzoKICAgICAgICAgICAgc2VsZi5fS05YQWRkVGVtcGVyYXR1cmUoa28sIGZ2YWx1ZSwgMSwgIkluY3JlbWVudFRhcmdldFRlbXBlcmF0dXJlQ29uZmlybWF0aW9uIiwgcmVzcG9uc2VPYmplY3QpCiAgICAgICAgICBlbGlmIHJlcXVlc3QgPT0gJ0RlY3JlbWVudFRhcmdldFRlbXBlcmF0dXJlUmVxdWVzdCc6CiAgICAgICAgICAgIHNlbGYuX0tOWEFkZFRlbXBlcmF0dXJlKGtvLCBmdmFsdWUsIC0xLCAiRGVjcmVtZW50VGFyZ2V0VGVtcGVyYXR1cmVDb25maXJtYXRpb24iLCByZXNwb25zZU9iamVjdCkKICAgICAgICBlbGlmIHJlcXVlc3QgPT0gJ0dldFRleHRSZXF1ZXN0JzoKICAgICAgICAgIGtvID0gc2VsZi5maW5kS08oYXBwbGlhbmNlSWQsIGFwcGxpYW5jZSwgJ3RleHQnLCBtZXNzYWdlSWQpCiAgICAgICAgICBzZWxmLmluZm8odSJDb250cm9sIGFwcGxpYW5jZSB3aXRoIGlkPSd7MH0nLCBuYW1lPSd7MX0nLCByZXF1ZXN0PSd7Mn0nLCBtZXNzYWdlSWQ9J3szfScuIiwgYXBwbGlhbmNlSWQsIGtvLlJQQ1RleHQuZGVjb2RlKCdpc284ODU5LTEnKSwgcmVxdWVzdCwgbWVzc2FnZUlkKQogICAgICAgICAgdmFsdWUgPSBrby5nZXRXZXJ0KCkKICAgICAgICAgIHJlc3BvbnNlT2JqZWN0LnNldE5hbWUoIkdldFRleHRDb25maXJtYXRpb24iKQogICAgICAgICAgcmVzcG9uc2VPYmplY3Quc2V0UGF5bG9hZCgidGV4dCIsIHZhbHVlLCBrby5Gb3JtYXQpCiAgICAgICAgZWxpZiByZXF1ZXN0ID09ICdHZXRWYWx1ZVJlcXVlc3QnOgogICAgICAgICAga28gPSBzZWxmLmZpbmRLTyhhcHBsaWFuY2VJZCwgYXBwbGlhbmNlLCAndmFsdWUnLCBtZXNzYWdlSWQpCiAgICAgICAgICBzZWxmLmluZm8odSJDb250cm9sIGFwcGxpYW5jZSB3aXRoIGlkPSd7MH0nLCBuYW1lPSd7MX0nLCByZXF1ZXN0PSd7Mn0nLCBtZXNzYWdlSWQ9J3szfScuIiwgYXBwbGlhbmNlSWQsIGtvLlJQQ1RleHQuZGVjb2RlKCdpc284ODU5LTEnKSwgcmVxdWVzdCwgbWVzc2FnZUlkKQogICAgICAgICAgdmFsdWUgPSBrby5nZXRXZXJ0KCkKICAgICAgICAgIHJlc3BvbnNlT2JqZWN0LnNldE5hbWUoIkdldFZhbHVlQ29uZmlybWF0aW9uIikKICAgICAgICAgIHJlc3BvbnNlT2JqZWN0LnNldFBheWxvYWQoInZhbHVlIiwgdmFsdWUsIGtvLkZvcm1hdCwgYXBwbGlhbmNlLmdldCgidW5pdCIpKQogICAgICAgIGVsaWYgcmVxdWVzdCA9PSAnR2V0T25PZmZWYWx1ZVJlcXVlc3QnOgogICAgICAgICAgaWYgYXBwbGlhbmNlLmdldCgnb25PZmYnKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgYXR0cmlidXRlTmFtZSA9ICdvbk9mZicKICAgICAgICAgIGVsaWYgYXBwbGlhbmNlLmdldCgnb24nKToKICAgICAgICAgICAgYXR0cmlidXRlTmFtZSA9ICdvbicKICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgIGF0dHJpYnV0ZU5hbWUgPSAnb2ZmJwogICAgICAgICAga28gPSBzZWxmLmZpbmRLTyhhcHBsaWFuY2VJZCwgYXBwbGlhbmNlLCBhdHRyaWJ1dGVOYW1lLCBtZXNzYWdlSWQpCiAgICAgICAgICBzZWxmLmluZm8odSJDb250cm9sIGFwcGxpYW5jZSB3aXRoIGlkPSd7MH0nLCBuYW1lPSd7MX0nLCByZXF1ZXN0PSd7Mn0nLCBtZXNzYWdlSWQ9J3szfScuIiwgYXBwbGlhbmNlSWQsIGtvLlJQQ1RleHQuZGVjb2RlKCdpc284ODU5LTEnKSwgcmVxdWVzdCwgbWVzc2FnZUlkKQogICAgICAgICAgdmFsdWUgPSBrby5nZXRXZXJ0KCkKICAgICAgICAgIHJlc3BvbnNlT2JqZWN0LnNldE5hbWUoIkdldE9uT2ZmVmFsdWVDb25maXJtYXRpb24iKQogICAgICAgICAgcmVzcG9uc2VPYmplY3Quc2V0UGF5bG9hZCgib25PZmYiLCB2YWx1ZSwga28uRm9ybWF0KQogICAgICAgIGVsaWYgcmVxdWVzdCA9PSAnR2V0UGVyY2VudFZhbHVlUmVxdWVzdCc6CiAgICAgICAgICBrbyA9IHNlbGYuZmluZEtPKGFwcGxpYW5jZUlkLCBhcHBsaWFuY2UsICdwZXJjZW50JywgbWVzc2FnZUlkKQogICAgICAgICAgdmFsdWUgPSBrby5nZXRXZXJ0KCkKICAgICAgICAgIHNlbGYuaW5mbyh1IkNvbnRyb2wgYXBwbGlhbmNlIHdpdGggaWQ9J3swfScsIG5hbWU9J3sxfScsIHJlcXVlc3Q9J3syfScsIG1lc3NhZ2VJZD0nezN9Jy4iLCBhcHBsaWFuY2VJZCwga28uUlBDVGV4dC5kZWNvZGUoJ2lzbzg4NTktMScpLCByZXF1ZXN0LCBtZXNzYWdlSWQpCiAgICAgICAgICByZXNwb25zZU9iamVjdC5zZXROYW1lKCJHZXRQZXJjZW50VmFsdWVDb25maXJtYXRpb24iKQogICAgICAgICAgcmVzcG9uc2VPYmplY3Quc2V0UGF5bG9hZCgicGVyY2VudCIsIHZhbHVlLCBrby5Gb3JtYXQpCiAgICAgICAgZWxpZiByZXF1ZXN0ID09ICdHZXRUYXJnZXRUZW1wZXJhdHVyZVJlcXVlc3QnOgogICAgICAgICAga28gPSBzZWxmLmZpbmRLTyhhcHBsaWFuY2VJZCwgYXBwbGlhbmNlLCAndGFyZ2V0VGVtcGVyYXR1cmUnLCBtZXNzYWdlSWQpCiAgICAgICAgICB2YWx1ZSA9IGtvLmdldFdlcnQoKQogICAgICAgICAgc2VsZi5pbmZvKHUiQ29udHJvbCBhcHBsaWFuY2Ugd2l0aCBpZD0nezB9JywgbmFtZT0nezF9JywgcmVxdWVzdD0nezJ9JywgbWVzc2FnZUlkPSd7M30nLiIsIGFwcGxpYW5jZUlkLCBrby5SUENUZXh0LmRlY29kZSgnaXNvODg1OS0xJyksIHJlcXVlc3QsIG1lc3NhZ2VJZCkKICAgICAgICAgIHJlc3BvbnNlT2JqZWN0LnNldE5hbWUoIkdldFRhcmdldFRlbXBlcmF0dXJlQ29uZmlybWF0aW9uIikKICAgICAgICAgIHJlc3BvbnNlT2JqZWN0LnNldFBheWxvYWQoInRhcmdldFRlbXBlcmF0dXJlIiwgdmFsdWUsIGtvLkZvcm1hdCkKICAgICAgICBlbGlmIHJlcXVlc3QgPT0gJ0dldEFjdHVhbFRlbXBlcmF0dXJlUmVxdWVzdCc6CiAgICAgICAgICBrbyA9IHNlbGYuZmluZEtPKGFwcGxpYW5jZUlkLCBhcHBsaWFuY2UsICdhY3R1YWxUZW1wZXJhdHVyZScsIG1lc3NhZ2VJZCkKICAgICAgICAgIHZhbHVlID0ga28uZ2V0V2VydCgpCiAgICAgICAgICBzZWxmLmluZm8odSJDb250cm9sIGFwcGxpYW5jZSB3aXRoIGlkPSd7MH0nLCBuYW1lPSd7MX0nLCByZXF1ZXN0PSd7Mn0nLCBtZXNzYWdlSWQ9J3szfScuIiwgYXBwbGlhbmNlSWQsIGtvLlJQQ1RleHQuZGVjb2RlKCdpc284ODU5LTEnKSwgcmVxdWVzdCwgbWVzc2FnZUlkKQogICAgICAgICAgcmVzcG9uc2VPYmplY3Quc2V0TmFtZSgiR2V0QWN0dWFsVGVtcGVyYXR1cmVDb25maXJtYXRpb24iKQogICAgICAgICAgcmVzcG9uc2VPYmplY3Quc2V0UGF5bG9hZCgiYWN0dWFsVGVtcGVyYXR1cmUiLCB2YWx1ZSwga28uRm9ybWF0KQogICAgICBleGNlcHQgQW1hem9uRWNoby5FcnJvciBhcyBleDoKICAgICAgICByZXNwb25zZU9iamVjdC5zZXROYW1lKCJOb1N1Y2hUYXJnZXRFcnJvciIpCiAgICAgICAgcmVzcG9uc2VPYmplY3QuYWRkUGF5bG9hZCgiZXJyb3IiLCAiY29kZSIsIGV4LmNvZGUpCiAgICAgICAgcmVzcG9uc2VPYmplY3QuYWRkUGF5bG9hZCgiZXJyb3IiLCAibXNnIiwgZXgudmFsdWUpCiAgICAgICAgaWYgZXguZGljdCBpcyBub3QgTm9uZToKICAgICAgICAgIGZvciBrZXksIHZhbHVlIGluIGV4LmRpY3QuaXRlcml0ZW1zKCk6CiAgICAgICAgICAgIHJlc3BvbnNlT2JqZWN0LmFkZFBheWxvYWQoImVycm9yIiwga2V5LCB2YWx1ZSkKICAgICAgaWYgcmVzcG9uc2VPYmplY3QuZ2V0TmFtZSgpIGlzIE5vbmU6CiAgICAgICAgc2VsZi5lcnJvcih1IkNvbnRyb2w6IHVuc3VwcG9ydGVkIG9wZXJhdGlvbiAnezB9JyBmb3IgYXBwbGlhbmNlIHdpdGggaWQ9J3sxfScuIChtZXNzYWdlSWQ9J3syfScpIiwgcmVxdWVzdCwgYXBwbGlhbmNlSWQsIG1lc3NhZ2VJZCkKICAgICAgICByZXNwb25zZU9iamVjdC5zZXROYW1lKCJVbnN1cHBvcnRlZE9wZXJhdGlvbkVycm9yIikKICAgICAgcmV0dXJuIHJlc3BvbnNlT2JqZWN0CiAgICBjbGFzcyBFcnJvcihFeGNlcHRpb24pOgogICAgICBkZWYgX19pbml0X18oc2VsZiwgdmFsdWUsIGNvZGUsIGRpY3Q9Tm9uZSk6CiAgICAgICAgc2VsZi52YWx1ZSA9IHZhbHVlCiAgICAgICAgc2VsZi5jb2RlID0gY29kZQogICAgICAgIHNlbGYuZGljdCA9IGRpY3QKICAgICAgZGVmIF9fc3RyX18oc2VsZik6CiAgICAgICAgcmV0dXJuIHJlcHIoc2VsZi52YWx1ZSkKICAgIGRlZiBmaW5kS08oc2VsZiwgYXBwbGlhbmNlSWQsIGFwcGxpYW5jZSwgYXR0cmlidXRlTmFtZSwgbWVzc2FnZUlkKToKICAgICAgYXR0cmlidXRlVmFsdWUgPSBhcHBsaWFuY2UuZ2V0KGF0dHJpYnV0ZU5hbWUpCiAgICAgIGlmIGF0dHJpYnV0ZVZhbHVlIGlzIE5vbmU6CiAgICAgICAgc2VsZi5lcnJvcih1IkNvbnRyb2w6IGFwcGxpYW5jZSB3aXRoIGlkPSd7MH0nIGhhcyBubyAnezF9JyBhdHRyaWJ1dGUuIChtZXNzYWdlSWQ9J3syfScpIiwgYXBwbGlhbmNlSWQsIGF0dHJpYnV0ZU5hbWUsIG1lc3NhZ2VJZCkKICAgICAgICByYWlzZSBBbWF6b25FY2hvLkVycm9yKCJhdHRyaWJ1dGUgbm90IGZvdW5kIiwgIkFFXzEyIiwgeyJhcHBsaWFuY2VJZCI6YXBwbGlhbmNlSWQsICJhdHRyaWJ1dGVOYW1lIjphdHRyaWJ1dGVOYW1lfSkKICAgICAga28gPSBzZWxmLl9maW5kS28oYXR0cmlidXRlVmFsdWUpCiAgICAgIGlmIGtvIGlzIE5vbmU6CiAgICAgICAgc2VsZi5lcnJvcigiQ29udHJvbDogS08tb2JqZWN0IGZvciBncm91cCBhZGRyZXNzIHswfT0nezF9JyBjb3VsZCBub3QgYmUgZm91bmQuIChtZXNzYWdlSWQ9J3syfScpIiwgYXR0cmlidXRlTmFtZSwgYXR0cmlidXRlVmFsdWUsIG1lc3NhZ2VJZCkKICAgICAgICByYWlzZSBBbWF6b25FY2hvLkVycm9yKCJLTy1vYmplY3Qgbm90IGZvdW5kIiwgIkFFXzEzIiwgeyJhcHBsaWFuY2VJZCI6YXBwbGlhbmNlSWQsICJhdHRyaWJ1dGVWYWx1ZSI6YXR0cmlidXRlVmFsdWV9KQogICAgICByZXR1cm4ga28KICAgIGRlZiBfZmluZEtvKHNlbGYsIGdycEFkclN0cik6CiAgICAgIGZvciBpa28gaW4gc2VsZi5NQy5UYWdMaXN0LlRhZ0xpc3Q6IAogICAgICAgIGtvID0gc2VsZi5NQy5UYWdMaXN0LlRhZ0xpc3RbaWtvXQogICAgICAgIGlmIGtvLkdycEFkclN0ciA9PSBncnBBZHJTdHI6CiAgICAgICAgICByZXR1cm4ga28KICAgICAgcmV0dXJuIE5vbmU7CiAgICBkZWYgX0tOWEFkZFRlbXBlcmF0dXJlKHNlbGYsIGtvLCB2YWx1ZSwgc2lnbiwgbmFtZSwgcmVzcG9uc2VPYmplY3QpOgogICAgICBzZWxmLmRlYnVnKHUiX0tOWEFkZFRlbXBlcmF0dXJlKGtvPSd7MH0nLCB2YWx1ZT0nezF9Jywgc2lnbj0nezJ9JywgbmFtZT0nezN9KScuIiwga28uR3JwQWRyU3RyLCB2YWx1ZSwgc2lnbiwgbmFtZSkKICAgICAgb2xkVmFsdWUgPSBrby5nZXRXZXJ0KCkKICAgICAgbmV3VmFsdWUgPSBvbGRWYWx1ZSArIChzaWduICogdmFsdWUpCiAgICAgIGlmIG9sZFZhbHVlID4ga28uTWluIGFuZCBvbGRWYWx1ZSA8IGtvLk1heDoKICAgICAgICBpZiBuZXdWYWx1ZSA8IGtvLk1pbjoKICAgICAgICAgIG5ld1ZhbHVlID0ga28uTWluCiAgICAgICAgZWxpZiBuZXdWYWx1ZSA+IGtvLk1heDoKICAgICAgICAgIG5ld1ZhbHVlID0ga28uTWF4CiAgICAgICAgc2VsZi5fS05YU2VuZChrbywgbmV3VmFsdWUpCiAgICAgICAgcmVzcG9uc2VPYmplY3Quc2V0TmFtZShuYW1lKQogICAgICAgIHJlc3BvbnNlT2JqZWN0LnNldFRhcmdldFRlbXBlcmF0dXJlUGF5bG9hZCgiezA6MC4xZn0iLmZvcm1hdChvbGRWYWx1ZSksICJ7MDowLjFmfSIuZm9ybWF0KG5ld1ZhbHVlKSkKICAgICAgZWxzZToKICAgICAgICBzZWxmLndhcm4odSJWYWx1ZSBvdXQgb2YgcmFuZ2U6IGtvPSd7MH0nIG5ld1ZhbHVlPSd7MX0nIG1pbj0nezJ9JyBtYXg9J3szfSciLCBrby5HcnBBZHJTdHIsIG5ld1ZhbHVlLCBrby5NaW4sIGtvLk1heCkKICAgICAgICByZXNwb25zZU9iamVjdC5zZXROYW1lKCJWYWx1ZU91dE9mUmFuZ2VFcnJvciIpCiAgICBkZWYgX0tOWFNldFRlbXBlcmF0dXJlKHNlbGYsIGtvLCB2YWx1ZSwgbmFtZSwgcmVzcG9uc2VPYmplY3QpOgogICAgICBzZWxmLmRlYnVnKHUiX0tOWFNldFRlbXBlcmF0dXJlKGtvPSd7MH0nLCB2YWx1ZT0nezF9JywgbmFtZT0nezJ9JykuIiwga28uR3JwQWRyU3RyLCB2YWx1ZSwgbmFtZSkKICAgICAgb2xkVmFsdWUgPSBrby5nZXRXZXJ0KCkKICAgICAgc2VsZi5kZWJ1Zyh1Il9LTlhTZXRUZW1wZXJhdHVyZTogb2xkVmFsdWU9J3swfScgbWluPSd7MX0nIG1heD0nezJ9JyIsIG9sZFZhbHVlLCBrby5NaW4sIGtvLk1heCkKICAgICAgaWYgdmFsdWUgPj0ga28uTWluIGFuZCB2YWx1ZSA8PSBrby5NYXg6CiAgICAgICAgc2VsZi5fS05YU2VuZChrbywgdmFsdWUpCiAgICAgICAgcmVzcG9uc2VPYmplY3Quc2V0TmFtZShuYW1lKQogICAgICAgIHJlc3BvbnNlT2JqZWN0LnNldFRhcmdldFRlbXBlcmF0dXJlUGF5bG9hZCgiezA6MC4xZn0iLmZvcm1hdChvbGRWYWx1ZSksICJ7MDowLjFmfSIuZm9ybWF0KHZhbHVlKSkKICAgICAgZWxzZToKICAgICAgICBzZWxmLndhcm4odSJWYWx1ZSBvdXQgb2YgcmFuZ2U6IGtvPSd7MH0nIHZhbHVlPSd7MX0nIG1pbj0nezJ9JyBtYXg9J3szfSciLCBrby5HcnBBZHJTdHIsIHZhbHVlLCBrby5NaW4sIGtvLk1heCkKICAgICAgICByZXNwb25zZU9iamVjdC5zZXROYW1lKCJWYWx1ZU91dE9mUmFuZ2VFcnJvciIpCiAgICBkZWYgX0tOWEFkZFBlcmNlbnQoc2VsZiwga28sIHZhbHVlLCBzaWduLCBuYW1lLCByZXNwb25zZU9iamVjdCk6CiAgICAgIHNlbGYuZGVidWcodSJfS05YQWRkUGVyY2VudChrbz0nezB9JywgdmFsdWU9J3sxfScsIHNpZ249J3syfScsIG5hbWU9J3szfScpIiwga28uR3JwQWRyU3RyLCB2YWx1ZSwgc2lnbiwgbmFtZSkKICAgICAgb2xkVmFsdWUgPSBrby5nZXRXZXJ0KCkKICAgICAgbmV3VmFsdWUgPSBvbGRWYWx1ZSArIChzaWduICogdmFsdWUpCiAgICAgIGlmIG9sZFZhbHVlID4ga28uTWluIGFuZCBvbGRWYWx1ZSA8IGtvLk1heDoKICAgICAgICBpZiBuZXdWYWx1ZSA8IGtvLk1pbjoKICAgICAgICAgIG5ld1ZhbHVlID0ga28uTWluCiAgICAgICAgZWxpZiBuZXdWYWx1ZSA+IGtvLk1heDoKICAgICAgICAgIG5ld1ZhbHVlID0ga28uTWF4CiAgICAgICAgc2VsZi5fS05YU2VuZChrbywgbmV3VmFsdWUpCiAgICAgICAgcmVzcG9uc2VPYmplY3Quc2V0TmFtZShuYW1lKQogICAgICBlbHNlOgogICAgICAgIHNlbGYud2Fybih1IlZhbHVlIG91dCBvZiByYW5nZToga289J3swfScgbmV3VmFsdWU9J3sxfScgbWluPSd7Mn0nIG1heD0nezN9JyIsIGtvLkdycEFkclN0ciwgbmV3VmFsdWUsIGtvLk1pbiwga28uTWF4KQogICAgICAgIHJlc3BvbnNlT2JqZWN0LnNldE5hbWUoIlZhbHVlT3V0T2ZSYW5nZUVycm9yIikKICAgIGRlZiBfS05YU2V0UGVyY2VudChzZWxmLCBrbywgdmFsdWUsIG5hbWUsIHJlc3BvbnNlT2JqZWN0KToKICAgICAgc2VsZi5kZWJ1Zyh1Il9LTlhTZXRQZXJjZW50KGtvPSd7MH0nLCB2YWx1ZT0nezF9JywgbmFtZT0nezJ9JykiLCBrby5HcnBBZHJTdHIsIHZhbHVlLCBuYW1lKQogICAgICBpZiB2YWx1ZSA+PSBrby5NaW4gYW5kIHZhbHVlIDw9IGtvLk1heDoKICAgICAgICBzZWxmLl9LTlhTZW5kKGtvLCB2YWx1ZSkKICAgICAgICByZXNwb25zZU9iamVjdC5zZXROYW1lKG5hbWUpCiAgICAgIGVsc2U6CiAgICAgICAgc2VsZi53YXJuKHUiVmFsdWUgb3V0IG9mIHJhbmdlOiBrbz0nezB9JyB2YWx1ZT0nezF9JyBtaW49J3syfScgbWF4PSd7M30nIiwga28uR3JwQWRyU3RyLCB2YWx1ZSwga28uTWluLCBrby5NYXgpCiAgICAgICAgcmVzcG9uc2VPYmplY3Quc2V0TmFtZSgiVmFsdWVPdXRPZlJhbmdlRXJyb3IiKQogICAgZGVmIF9LTlhTZXRWYWx1ZShzZWxmLCBrbywgdmFsdWUsIG5hbWUsIHJlc3BvbnNlT2JqZWN0KToKICAgICAgc2VsZi5kZWJ1Zyh1Il9LTlhTZXRWYWx1ZShrbz0nezB9JywgdmFsdWU9J3sxfScsIG5hbWU9J3syfScpLiIsIGtvLkdycEFkclN0ciwgdmFsdWUsIG5hbWUpCiAgICAgIHNlbGYuX0tOWFNlbmQoa28sIHZhbHVlKQogICAgICByZXNwb25zZU9iamVjdC5zZXROYW1lKG5hbWUpCiAgICBkZWYgX0tOWFNlbmQoc2VsZiwga28sIHZhbHVlKToKICAgICAgc2VsZi5kZWJ1Zyh1Il9LTlhTZW5kKGtvPSd7MH0nLCB2YWx1ZT0nezF9Jyk6Iiwga28uR3JwQWRyU3RyLCB2YWx1ZSkKICAgICAgc2VsZi5sb2dpay5NQy5UYWdMaXN0LnNldFdlcnQoRkxBR19FSUJfTE9HSUssIGtvLCB2YWx1ZSkKICAgIGRlZiBmaW5kQXBwbGlhbmNlKHNlbGYsIGFwcGxpYW5jZUlkKToKICAgICAgc2VsZi5kZWJ1Zyh1ImZpbmRBcHBsaWFuY2UoYXBwbGlhbmNlSWQ9J3swfScpIiwgYXBwbGlhbmNlSWQpCiAgICAgIGlmIHNlbGYuYXBwbGlhbmNlcyBpcyBub3QgTm9uZToKICAgICAgICBpZCA9IDAKICAgICAgICBmb3IgZGV2aWNlIGluIHNlbGYuYXBwbGlhbmNlczoKICAgICAgICAgIHJvb20gPSBkZXZpY2UuZ2V0KCdyb29tJykKICAgICAgICAgIGlkICs9IDEKICAgICAgICAgIGlkU3RyID0gZGV2aWNlLmdldCgnaWQnKQogICAgICAgICAgaWYgaWRTdHIgaXMgTm9uZToKICAgICAgICAgICAgaWRTdHIgPSBzdHIoaWQpCiAgICAgICAgICBpZiBhcHBsaWFuY2VJZCA9PSBpZFN0cjoKICAgICAgICAgICAgc2VsZi5kZWJ1Zyh1IkZvdW5kIHJvb209J3swfScuIiwgcm9vbSkKICAgICAgICAgICAgcmV0dXJuIGRldmljZQogICAgICAgICAgamQgPSAwCiAgICAgICAgICBmb3IgYXBwbGlhbmNlIGluIGRldmljZVsnYXBwbGlhbmNlcyddOgogICAgICAgICAgICBuYW1lID0gYXBwbGlhbmNlLmdldCgnbmFtZScpCiAgICAgICAgICAgIGpkICs9IDEKICAgICAgICAgICAgamRTdHIgPSBhcHBsaWFuY2UuZ2V0KCdpZCcpCiAgICAgICAgICAgIGlmIGpkU3RyIGlzIE5vbmU6CiAgICAgICAgICAgICAgamRTdHIgPSBzdHIoamQpCiAgICAgICAgICAgIGlmIGFwcGxpYW5jZUlkID09IGlkU3RyICsgIl8iICsgamRTdHI6CiAgICAgICAgICAgICAgc2VsZi5kZWJ1Zyh1IkZvdW5kIGFwcGxpYW5jZSB3aXRoIG5hbWU9J3swfScuIiwgbmFtZSkKICAgICAgICAgICAgICByZXR1cm4gYXBwbGlhbmNlCiAgICAgICAgICAgIGFsaWFzZXMgPSBhcHBsaWFuY2UuZ2V0KCdhbGlhc2VzJyk7CiAgICAgICAgICAgIGlmIGFsaWFzZXMgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAga2QgPSAwCiAgICAgICAgICAgICAgZm9yIGFsaWFzIGluIGFsaWFzZXM6CiAgICAgICAgICAgICAgICBrZCArPSAxCiAgICAgICAgICAgICAgICBpZiBhcHBsaWFuY2VJZCA9PSBpZFN0ciArICJfIiArIGpkU3RyICsgIl8iICsgc3RyKGtkKToKICAgICAgICAgICAgICAgICAgc2VsZi5kZWJ1Zyh1IkZvdW5kIGFwcGxpYW5jZSB3aXRoIGFsaWFzPSd7MH0nLiIsIGFsaWFzKQogICAgICAgICAgICAgICAgICByZXR1cm4gYXBwbGlhbmNlCiAgICAgIHJldHVybiBOb25lCiAgICBkZWYgZW5jb2RlKHNlbGYsIGtleSwgZGVjKToKICAgICAgaW1wb3J0IGJhc2U2NAogICAgICBlbmMgPSBbXQogICAgICBmb3IgaSBpbiByYW5nZShsZW4oZGVjKSk6CiAgICAgICAga2V5X2MgPSBrZXlbaSAlIGxlbihrZXkpXQogICAgICAgIGVuY19jID0gY2hyKChvcmQoZGVjW2ldKSArIG9yZChrZXlfYykpICUgMjU2KQogICAgICAgIGVuYy5hcHBlbmQoZW5jX2MpCiAgICAgIHJldHVybiBiYXNlNjQudXJsc2FmZV9iNjRlbmNvZGUoIiIuam9pbihlbmMpKQogICAgZGVmIGRlY29kZShzZWxmLCBrZXksIGVuYyk6CiAgICAgIGltcG9ydCBiYXNlNjQKICAgICAgZGVjID0gW10KICAgICAgZW5jID0gYmFzZTY0LnVybHNhZmVfYjY0ZGVjb2RlKGVuYykKICAgICAgZm9yIGkgaW4gcmFuZ2UobGVuKGVuYykpOgogICAgICAgIGtleV9jID0ga2V5W2kgJSBsZW4oa2V5KV0KICAgICAgICBkZWNfYyA9IGNocigoMjU2ICsgb3JkKGVuY1tpXSkgLSBvcmQoa2V5X2MpKSAlIDI1NikKICAgICAgICBkZWMuYXBwZW5kKGRlY19jKQogICAgICByZXR1cm4gIiIuam9pbihkZWMpCiAgICBjbGFzcyBIZWFkZXIoKToKICAgICAgZGVmIF9faW5pdF9fKHNlbGYsIG1lc3NhZ2VJZCwgbmFtZSwgbmFtZXNwYWNlLCBwYXlsb2FkVmVyc2lvbik6CiAgICAgICAgc2VsZi5tZXNzYWdlSWQgPSBtZXNzYWdlSWQKICAgICAgICBzZWxmLm5hbWUgPSBuYW1lCiAgICAgICAgc2VsZi5uYW1lc3BhY2UgPSBuYW1lc3BhY2UKICAgICAgICBzZWxmLnBheWxvYWRWZXJzaW9uID0gcGF5bG9hZFZlcnNpb24KICAgIGNsYXNzIENvbnRyb2xSZXNwb25zZSgpOgogICAgICBkZWYgX19pbml0X18oc2VsZiwgbWVzc2FnZUlkKToKICAgICAgICBzZWxmLmhlYWRlciA9IEFtYXpvbkVjaG8uSGVhZGVyKG1lc3NhZ2VJZCwgTm9uZSwgIkFsZXhhLkNvbm5lY3RlZEhvbWUuQ29udHJvbCIsICIyIikKICAgICAgICBzZWxmLnBheWxvYWQgPSB7fQogICAgICBkZWYgc2V0TmFtZShzZWxmLCBuYW1lKToKICAgICAgICBzZWxmLmhlYWRlci5uYW1lID0gbmFtZQogICAgICBkZWYgZ2V0TmFtZShzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5oZWFkZXIubmFtZQogICAgICBkZWYgc2V0VGFyZ2V0VGVtcGVyYXR1cmVQYXlsb2FkKHNlbGYsIG9sZFZhbHVlLCBuZXdWYWx1ZSk6CiAgICAgICAgc2VsZi5wYXlsb2FkID0gewogICAgICAgICAgInRhcmdldFRlbXBlcmF0dXJlIjp7InZhbHVlIjpuZXdWYWx1ZX0sCiAgICAgICAgICAidGVtcGVyYXR1cmVNb2RlIjp7InZhbHVlIjoiQVVUTyJ9LAogICAgICAgICAgInByZXZpb3VzU3RhdGUiOnsKICAgICAgICAgICAgInRhcmdldFRlbXBlcmF0dXJlIjp7InZhbHVlIjpvbGRWYWx1ZX0sCiAgICAgICAgICAgICJtb2RlIjp7InZhbHVlIjoiQVVUTyJ9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICBkZWYgc2V0UGF5bG9hZChzZWxmLCBuYW1lLCB2YWx1ZSwgdHlwZT1Ob25lLCB1bml0PU5vbmUpOgogICAgICAgIGlmIHR5cGUgaXMgbm90IE5vbmUgYW5kIHR5cGUgPT0gMjI6CiAgICAgICAgICB2YWx1ZSA9IHZhbHVlLmRlY29kZSgnaXNvODg1OS0xJykKICAgICAgICBzZWxmLmFkZFBheWxvYWQobmFtZSwgInZhbHVlIiwgdmFsdWUpCiAgICAgICAgaWYgdW5pdCBpcyBub3QgTm9uZToKICAgICAgICAgIHNlbGYuYWRkUGF5bG9hZChuYW1lLCAidW5pdCIsIHVuaXQpCiAgICAgICAgaWYgdHlwZSBpcyBub3QgTm9uZToKICAgICAgICAgIHNlbGYuYWRkUGF5bG9hZChuYW1lLCAidHlwZSIsIHR5cGUpCiAgICAgIGRlZiBhZGRQYXlsb2FkKHNlbGYsIG5hbWUsIGtleSwgdmFsdWUpOgogICAgICAgIHNlY3QgPSBzZWxmLnBheWxvYWQuZ2V0KG5hbWUpCiAgICAgICAgaWYgc2VjdCBpcyBOb25lOgogICAgICAgICAgc2VsZi5wYXlsb2FkW25hbWVdID0ge30KICAgICAgICBzZWxmLnBheWxvYWRbbmFtZV1ba2V5XSA9IHZhbHVlCiAgICBjbGFzcyBEaXNjb3ZlcnlSZXNwb25zZSgpOgogICAgICBkZWYgX19pbml0X18oc2VsZiwgbWVzc2FnZUlkKToKICAgICAgICBzZWxmLmhlYWRlciA9IEFtYXpvbkVjaG8uSGVhZGVyKG1lc3NhZ2VJZCwgIkRpc2NvdmVyQXBwbGlhbmNlc1Jlc3BvbnNlIiwgIkFsZXhhLkNvbm5lY3RlZEhvbWUuRGlzY292ZXJ5IiwgIjIiKQogICAgICAgIHNlbGYucGF5bG9hZCA9IEFtYXpvbkVjaG8uRGlzY292ZXJ5UGF5bG9hZCgpCiAgICAgIGRlZiBzZXROYW1lKHNlbGYsIG5hbWUpOgogICAgICAgIHNlbGYuaGVhZGVyLm5hbWUgPSBuYW1lCiAgICAgIGRlZiBhZGRBcHBsaWFuY2Uoc2VsZiwgYXBwbGlhbmNlKToKICAgICAgICBzZWxmLnBheWxvYWQuZGlzY292ZXJlZEFwcGxpYW5jZXMuYXBwZW5kKGFwcGxpYW5jZSkKICAgICAgZGVmIGdldE5yT2ZBcHBsaWFuY2VzKHNlbGYpOgogICAgICAgIHJldHVybiBsZW4oc2VsZi5wYXlsb2FkLmRpc2NvdmVyZWRBcHBsaWFuY2VzKQogICAgY2xhc3MgRGlzY292ZXJ5UGF5bG9hZCgpOgogICAgICBkZWYgX19pbml0X18oc2VsZik6CiAgICAgICAgc2VsZi5kaXNjb3ZlcmVkQXBwbGlhbmNlcyA9IFtdCiAgICBjbGFzcyBEaXNjb3ZlcnlBcHBsaWFuY2UoKToKICAgICAgZGVmIF9faW5pdF9fKHNlbGYsIGFwcGxpYW5jZUlkLCBmcmllbmRseU5hbWUsIGFwcGxpYW5jZVR5cGUpOgogICAgICAgIHNlbGYuYXBwbGlhbmNlSWQgPSBhcHBsaWFuY2VJZAogICAgICAgIHNlbGYuZnJpZW5kbHlEZXNjcmlwdGlvbiA9IGZyaWVuZGx5TmFtZQogICAgICAgIHNlbGYuZnJpZW5kbHlOYW1lID0gZnJpZW5kbHlOYW1lCiAgICAgICAgc2VsZi5pc1JlYWNoYWJsZSA9IFRydWUKICAgICAgICBzZWxmLm1hbnVmYWN0dXJlck5hbWUgPSAibi5hLiIKICAgICAgICBzZWxmLm1vZGVsTmFtZSA9ICJuLmEuIgogICAgICAgIHNlbGYudmVyc2lvbiA9ICIxLjAiCiAgICAgICAgaWYgYXBwbGlhbmNlVHlwZSA9PSAiU3dpdGNoYWJsZSI6CiAgICAgICAgICBzZWxmLmFjdGlvbnMgPSBbInR1cm5PbiIsICJ0dXJuT2ZmIl0KICAgICAgICBlbGlmIGFwcGxpYW5jZVR5cGUgPT0gIlN3aXRjaE9uIjoKICAgICAgICAgIHNlbGYuYWN0aW9ucyA9IFsidHVybk9uIl0KICAgICAgICBlbGlmIGFwcGxpYW5jZVR5cGUgPT0gIlN3aXRjaE9mZiI6CiAgICAgICAgICBzZWxmLmFjdGlvbnMgPSBbInR1cm5PZmYiXQogICAgICAgIGVsaWYgYXBwbGlhbmNlVHlwZSA9PSAiTGlnaHRpbmciOgogICAgICAgICAgc2VsZi5hY3Rpb25zID0gWyJ0dXJuT24iLCAidHVybk9mZiIsICJpbmNyZW1lbnRQZXJjZW50YWdlIiwgImRlY3JlbWVudFBlcmNlbnRhZ2UiLCAic2V0UGVyY2VudGFnZSJdCiAgICAgICAgZWxpZiBhcHBsaWFuY2VUeXBlID09ICJUaGVybW9zdGF0IjoKICAgICAgICAgIHNlbGYuYWN0aW9ucyA9IFsiaW5jcmVtZW50VGFyZ2V0VGVtcGVyYXR1cmUiLCAiZGVjcmVtZW50VGFyZ2V0VGVtcGVyYXR1cmUiLCAic2V0VGFyZ2V0VGVtcGVyYXR1cmUiXQogICAgY2xhc3MgSFRUUFJlcXVlc3RIYW5kbGVyKEJhc2VIVFRQUmVxdWVzdEhhbmRsZXIpOgogICAgICBkZWYgYWRkcmVzc19zdHJpbmcoc2VsZik6CiAgICAgICAgICBob3N0LCBwb3J0ID0gc2VsZi5jbGllbnRfYWRkcmVzc1s6Ml0KICAgICAgICAgIHJldHVybiBob3N0CiAgICAgIGRlZiBsb2dfcmVxdWVzdChzZWxmLCBjb2RlPU5vbmUsIHNpemU9Tm9uZSk6CiAgICAgICAgcGFzcwogICAgICBkZWYgbG9nX21lc3NhZ2Uoc2VsZiwgZm9ybWF0LCAqYXJncyk6CiAgICAgICAgcGFzcwogICAgICBkZWYgZG9fUE9TVChzZWxmKToKICAgICAgICBzZWxmLnBvc3R2YXJzID0gc2VsZi5wYXJzZV9QT1NUKCkKICAgICAgICBzZWxmLmRvX1JFUSgpCiAgICAgIGRlZiBwYXJzZV9QT1NUKHNlbGYpOgogICAgICAgIGZyb20gY2dpIGltcG9ydCBwYXJzZV9oZWFkZXIsIHBhcnNlX211bHRpcGFydAogICAgICAgIGZyb20gdXJscGFyc2UgaW1wb3J0IHBhcnNlX3FzCiAgICAgICAgY3R5cGUsIHBkaWN0ID0gcGFyc2VfaGVhZGVyKHNlbGYuaGVhZGVyc1snY29udGVudC10eXBlJ10pCiAgICAgICAgaWYgY3R5cGUgPT0gJ211bHRpcGFydC9mb3JtLWRhdGEnOgogICAgICAgICAgICBwb3N0dmFycyA9IHBhcnNlX211bHRpcGFydChzZWxmLnJmaWxlLCBwZGljdCkKICAgICAgICBlbGlmIGN0eXBlID09ICdhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQnOgogICAgICAgICAgICBsZW5ndGggPSBpbnQoc2VsZi5oZWFkZXJzWydjb250ZW50LWxlbmd0aCddKQogICAgICAgICAgICBwb3N0dmFycyA9IHBhcnNlX3FzKAogICAgICAgICAgICAgICAgICAgIHNlbGYucmZpbGUucmVhZChsZW5ndGgpLCAKICAgICAgICAgICAgICAgICAgICBrZWVwX2JsYW5rX3ZhbHVlcz0xKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHBvc3R2YXJzID0ge30KICAgICAgICByZXR1cm4gcG9zdHZhcnMKICAgICAgZGVmIGRvX0dFVChzZWxmKToKICAgICAgICBzZWxmLnBvc3R2YXJzID0gTm9uZQogICAgICAgIHNlbGYuZG9fUkVRKCkKICAgICAgZGVmIGRvX1JFUShzZWxmKToKICAgICAgICBhY2Nlc3NUb2tlbiA9IE5vbmUKICAgICAgICBtZXNzYWdlSWQgPSBOb25lCiAgICAgICAgdHJ5OgogICAgICAgICAgaWR4ID0gc2VsZi5wYXRoLmluZGV4KCI/IikKICAgICAgICAgIHNlbGYuY29tbWFuZCA9IHNlbGYucGF0aFsxOmlkeF0KICAgICAgICAgIHJlcVBhcmFtcyA9IHNlbGYuX2J1aWxkUmVxUGFyYW1NYXAoc2VsZi5wYXRoW2lkeCsxOl0pCiAgICAgICAgICBhY2Nlc3NUb2tlbiA9IHJlcVBhcmFtcy5nZXQoJ2FjY2Vzc1Rva2VuJykKICAgICAgICAgIG1lc3NhZ2VJZCA9IHJlcVBhcmFtcy5nZXQoJ21lc3NhZ2VJZCcpCiAgICAgICAgZXhjZXB0IFZhbHVlRXJyb3I6CiAgICAgICAgICBzZWxmLmNvbW1hbmQgPSBzZWxmLnBhdGhbMTpdCiAgICAgICAgaWYgc2VsZi5jb21tYW5kLmxvd2VyKCkgPT0gJ2Zhdmljb24uaWNvJzoKICAgICAgICAgIHNlbGYuc2VuZF9lcnJvcig0MDQsICdOb3QgZm91bmQnKQogICAgICAgICAgcmV0dXJuCiAgICAgICAgaWYgYWNjZXNzVG9rZW4gaXMgTm9uZToKICAgICAgICAgIHNlbGYuc2VydmVyLnNlY3VyKCJBdHRlbXB0IHRvIGFjY2VzcyBzZXJ2aWNlIHdpdGggbm8gYWNjZXNzIHRva2VuLiIpCiAgICAgICAgICBzZWxmLnNlbmRfZXJyb3IoNDAxLCAnVW5hdXRob3JpemVkJykKICAgICAgICAgIHJldHVybgogICAgICAgIGlmIHNlbGYuY29tbWFuZCA9PSAnY29uZmlnJyBvciBzZWxmLmNvbW1hbmQgPT0gJ3Nsb3RUeXBlcyc6CiAgICAgICAgICBpZiBhY2Nlc3NUb2tlbiAhPSBzZWxmLnNlcnZlci5hY2Nlc3NUb2tlbjoKICAgICAgICAgICAgc2VsZi5zZXJ2ZXIuc2VjdXIodSJBdHRlbXB0IHRvIGFjY2VzcyBzZXJ2aWNlIHdpdGggd3JvbmcgYWNjZXNzIHRva2VuLiAnezB9JyE9J3sxfSciLCBzZWxmLnNlcnZlci5hY2Nlc3NUb2tlbiwgYWNjZXNzVG9rZW4pCiAgICAgICAgICAgIHNlbGYuc2VuZF9lcnJvcig0MDEsICdVbmF1dGhvcml6ZWQnKQogICAgICAgICAgICByZXR1cm4KICAgICAgICAgIHRyeToKICAgICAgICAgICAgaWYgc2VsZi5jb21tYW5kID09ICdjb25maWcnOgogICAgICAgICAgICAgIHNlbGYuX2NvbmZpZygpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgc2VsZi5fc2xvdFR5cGVzKCkKICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgc2VsZi5zZXJ2ZXIuTUMuRGVidWcuc2V0RXJyKHN5cy5leGNfaW5mbygpLCJJbnRlcm5hbCBFcnJvciIpCiAgICAgICAgICAgIHNlbGYuc2VuZF9lcnJvcig1MDAsICdJbnRlcm5hbCBFcnJvcicpCiAgICAgICAgICByZXR1cm4KICAgICAgICBpZiBhY2Nlc3NUb2tlbiAhPSBzZWxmLnNlcnZlci5hY2Nlc3NUb2tlbjoKICAgICAgICAgIHNlbGYuc2VydmVyLnNlY3VyKHUiQXR0ZW1wdCB0byBhY2Nlc3Mgc2VydmljZSB3aXRoIHdyb25nIGFjY2VzcyB0b2tlbi4gJ3swfSchPSd7MX0nIiwgc2VsZi5zZXJ2ZXIuYWNjZXNzVG9rZW4sIGFjY2Vzc1Rva2VuKQogICAgICAgICAgc2VsZi5fc2VuZEpzb25FcnJvclJlc3BvbnNlKG1lc3NhZ2VJZCwgIlVuZXhwZWN0ZWRJbmZvcm1hdGlvblJlY2VpdmVkRXJyb3IiKQogICAgICAgICAgcmV0dXJuCiAgICAgICAgaWYgbWVzc2FnZUlkIGlzIE5vbmU6CiAgICAgICAgICBzZWxmLl9zZW5kSnNvbkVycm9yUmVzcG9uc2UoIiIsICJVbmV4cGVjdGVkSW5mb3JtYXRpb25SZWNlaXZlZEVycm9yIikKICAgICAgICAgIHJldHVybgogICAgICAgIHRyeToKICAgICAgICAgIGlmIHNlbGYuY29tbWFuZCA9PSAnY29udHJvbCc6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICByZXF1ZXN0ID0gcmVxUGFyYW1zWydyZXF1ZXN0J10KICAgICAgICAgICAgICBhcHBsaWFuY2VJZCA9IHJlcVBhcmFtc1snYXBwbGlhbmNlSWQnXQogICAgICAgICAgICAgIHZhbHVlID0gcmVxUGFyYW1zLmdldCgndmFsdWUnLCBOb25lKQogICAgICAgICAgICBleGNlcHQgKEtleUVycm9yKToKICAgICAgICAgICAgICBzZWxmLl9zZW5kSnNvbkVycm9yUmVzcG9uc2UobWVzc2FnZUlkLCAiVW5leHBlY3RlZEluZm9ybWF0aW9uUmVjZWl2ZWRFcnJvciIpCiAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgIHJlc3BvbnNlT2JqZWN0ID0gc2VsZi5zZXJ2ZXIuY29udHJvbChtZXNzYWdlSWQsIGFwcGxpYW5jZUlkLCByZXF1ZXN0LCB2YWx1ZSkKICAgICAgICAgICAgc2VsZi5fc2VuZEpzb25SZXNwb25zZShyZXNwb25zZU9iamVjdCkKICAgICAgICAgIGVsaWYgc2VsZi5jb21tYW5kID09ICdkaXNjb3ZlcnknOgogICAgICAgICAgICBjdXN0b21Ta2lsbCA9IHJlcVBhcmFtcy5nZXQoJ2N1c3RvbVNraWxsJywgRmFsc2UpCiAgICAgICAgICAgIHJlc3BvbnNlT2JqZWN0ID0gc2VsZi5zZXJ2ZXIuZGlzY292ZXJ5KG1lc3NhZ2VJZCwgY3VzdG9tU2tpbGwpCiAgICAgICAgICAgIHNlbGYuX3NlbmRKc29uUmVzcG9uc2UocmVzcG9uc2VPYmplY3QpCiAgICAgICAgICBlbHNlOgogICAgICAgICAgICBzZWxmLl9zZW5kSnNvbkVycm9yUmVzcG9uc2UobWVzc2FnZUlkLCAiVW5leHBlY3RlZEluZm9ybWF0aW9uUmVjZWl2ZWRFcnJvciIpCiAgICAgICAgZXhjZXB0OgogICAgICAgICAgc2VsZi5zZXJ2ZXIuZXhjKCJVbmhhbmRsZWQgZXhjZXB0aW9uIG9jY3VyZWQ6IikKICAgICAgICAgIHNlbGYuX3NlbmRKc29uRXJyb3JSZXNwb25zZShtZXNzYWdlSWQsICJEcml2ZXJJbnRlcm5hbEVycm9yIikKICAgICAgZGVmIF9jb25maWcoc2VsZik6CiAgICAgICAgbXNnID0gIiIKICAgICAgICBzeW50YXhFcnJvciA9IEZhbHNlCiAgICAgICAgaWYgc2VsZi5wb3N0dmFycyBpcyBub3QgTm9uZToKICAgICAgICAgIGNvbmZMaXN0ID0gc2VsZi5wb3N0dmFycy5nZXQoJ2NvbmYnLCBOb25lKQogICAgICAgICAgaWYgY29uZkxpc3QgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIG1zZywgc3ludGF4RXJyb3IgPSBzZWxmLnNlcnZlci5zYXZlQXBwbGlhbmNlc0NvbmYoY29uZkxpc3RbMF0uc3RyaXAoKSkKICAgICAgICBzZWxmLnNlbmRfcmVzcG9uc2UoMjAwKQogICAgICAgIHNlbGYuc2VuZF9oZWFkZXIoJ0NvbnRlbnQtVHlwZScsICd0ZXh0L2h0bWw7IGNoYXJzZXQ9dXRmLTgnKQogICAgICAgIHNlbGYuZW5kX2hlYWRlcnMoKQogICAgICAgIHNlbGYud2ZpbGUud3JpdGUoJzxodG1sPjxoZWFkPjxtZXRhIGNoYXJzZXQ9InV0Zi04Ij48L2hlYWQ+PGJvZHk+JykKICAgICAgICBzZWxmLndmaWxlLndyaXRlKCc8Zm9ybSBtZXRob2Q9InBvc3QiIGVuY3R5cGU9ImFwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZCIgYWNjZXB0LWNoYXJzZXQ9InV0Zi04Ij4nKQogICAgICAgIHNlbGYud2ZpbGUud3JpdGUoJzx0YWJsZSBzdHlsZT0id2lkdGg6MTAwJTtoZWlnaHQ6MTAwJSI+JykKICAgICAgICBzZWxmLndmaWxlLndyaXRlKCc8dHI+PHRkPjxoMT5BbWF6b24gRWNobyAtIEFwcGxpYW5jZXM8L2gxPjwvdGQ+PC90cj4nKQogICAgICAgIHNlbGYud2ZpbGUud3JpdGUoJzx0ciBzdHlsZT0iaGVpZ2h0OjkwJSI+PHRkPjx0ZXh0YXJlYSBuYW1lPSJjb25mIiBzdHlsZT0id2lkdGg6MTAwJTtoZWlnaHQ6MTAwJSI+JykKICAgICAgICBpZiBtc2cgPT0gIiI6CiAgICAgICAgICBTTiA9IHNlbGYuc2VydmVyLmxvY2Fsc1snU04nXQogICAgICAgICAgcmVzcCA9ICIiCiAgICAgICAgICBmb3IgaWR4IGluIHJhbmdlKDAsIHNlbGYuc2VydmVyLk1BWF9QQVJUKToKICAgICAgICAgICAgcGFydCA9IFNOW2lkeCArIDJdCiAgICAgICAgICAgIGlmIHBhcnQgaXMgbm90IE5vbmUgYW5kIHR5cGUocGFydCkgaXMgc3RyOgogICAgICAgICAgICAgIHJlc3AgKz0gcGFydAogICAgICAgIGVsc2U6CiAgICAgICAgICByZXNwID0gY29uZkxpc3RbMF0uc3RyaXAoKQogICAgICAgIHRyeToKICAgICAgICAgIHNlbGYud2ZpbGUud3JpdGUocmVzcCkKICAgICAgICBleGNlcHQ6CiAgICAgICAgICBzZWxmLnNlcnZlci5leGMoIkVuY29kaW5nIGVycm9yOiIpCiAgICAgICAgICBtc2cgPSAiRW5jb2RpbmcgRXJyb3IiCiAgICAgICAgc2VsZi53ZmlsZS53cml0ZSgnPC90ZXh0YXJlYT48L3RkPjwvdHI+JykKICAgICAgICBzZWxmLndmaWxlLndyaXRlKCc8dHI+PHRkPjxpbnB1dCB0eXBlPSJzdWJtaXQiLz48L3RkPjwvdHI+JykKICAgICAgICBzZWxmLndmaWxlLndyaXRlKCc8dHI+PHRkPjxoci8+RXhhbXBsZTo8cHJlPjxjb2RlPicpCiAgICAgICAgc2VsZi53ZmlsZS53cml0ZSgnW1xuJykKICAgICAgICBzZWxmLndmaWxlLndyaXRlKCcgIHsicm9vbSI6Ikv8Y2hlIiwgImFwcGxpYW5jZXMiOlt7Im5hbWUiOiJEZWNrZW5sZXVjaHRlIiwgIm9uT2ZmIjoiMS8yLzMifV19LFxuJy5kZWNvZGUoJ2lzbzg4NTktMScpLmVuY29kZSgndXRmLTgnKSkKICAgICAgICBzZWxmLndmaWxlLndyaXRlKCcgIHsicm9vbSI6IldvaG56aW1tZXIiLCAidGFyZ2V0VGVtcGVyYXR1cmUiOiIyLzIvNCIsICJhcHBsaWFuY2VzIjpbXG4nKQogICAgICAgIHNlbGYud2ZpbGUud3JpdGUoJyAgICB7Im5hbWUiOiJEZWNrZW5sZXVjaHRlIiwgIm9uT2ZmIjoiMS8yLzQiLCAicGVyY2VudCI6IjEvMi81In0sXG4nKQogICAgICAgIHNlbGYud2ZpbGUud3JpdGUoJyAgICB7Im5hbWUiOiJTdGVobGV1Y2h0ZSIsICJvbk9mZiI6IjEvMi82IiwgInBlcmNlbnQiOiIxLzIvNyIsICJhbGlhc2VzIjpbIlN0ZWhsYW1wZSBXb2huemltbWVyIl19XG4nKQogICAgICAgIHNlbGYud2ZpbGUud3JpdGUoJyAgXX0sXG4nKQogICAgICAgIHNlbGYud2ZpbGUud3JpdGUoJyAgeyJhcHBsaWFuY2VzIjpbXG4nKQogICAgICAgIHNlbGYud2ZpbGUud3JpdGUoJyAgICB7Im5hbWUiOiJMaWNodHN6ZW5lIEVzc2VuIiwgIm9uT2ZmIjoiMS8zLzEiLCAidmFsdWUiOiIwIn0sXG4nKQogICAgICAgIHNlbGYud2ZpbGUud3JpdGUoJyAgICB7Im5hbWUiOiJMaWNodHN6ZW5lIERla28iLCAib25PZmYiOiIxLzMvMSIsICJ2YWx1ZSI6IjEifVxuJykKICAgICAgICBzZWxmLndmaWxlLndyaXRlKCcgIF19XG4nKQogICAgICAgIHNlbGYud2ZpbGUud3JpdGUoJ10nKQogICAgICAgIHNlbGYud2ZpbGUud3JpdGUoJzwvY29kZT48L3ByZT48L3RkPjwvdHI+JykKICAgICAgICBpZiBtc2cgIT0gIiI6CiAgICAgICAgICBzZWxmLndmaWxlLndyaXRlKCc8dHI+PHRkPicpCiAgICAgICAgICBzZWxmLndmaWxlLndyaXRlKCc8YiBzdHlsZT0iY29sb3I6cmVkIj4nKQogICAgICAgICAgc2VsZi53ZmlsZS53cml0ZShtc2cpCiAgICAgICAgICBzZWxmLndmaWxlLndyaXRlKCc8L2I+JykKICAgICAgICAgIGlmIHN5bnRheEVycm9yOgogICAgICAgICAgICBzZWxmLndmaWxlLndyaXRlKCcgKEFkdmljZTogQ29weSZwYXN0ZSB5b3VyIEpTT04gY29uZmlndXJhdGlvbiBvbiA8YSB0YXJnZXQ9Im5ldyIgaHJlZj0iaHR0cDovL2pzb25saW50LmNvbS8iPkpTT05MaW50PC9hPiB0byB2YWxpZGF0ZS4pJykKICAgICAgICAgIHNlbGYud2ZpbGUud3JpdGUoJzwvdGQ+PC90cj4nKQogICAgICAgIHNlbGYud2ZpbGUud3JpdGUoJzwvZm9ybT48L2JvZHk+PC9odG1sPicpCiAgICAgIGRlZiBfc2xvdFR5cGVzKHNlbGYpOgogICAgICAgIHNlbGYuc2VuZF9yZXNwb25zZSgyMDApCiAgICAgICAgc2VsZi5zZW5kX2hlYWRlcignQ29udGVudC1UeXBlJywgJ3RleHQvaHRtbDsgY2hhcnNldD11dGYtOCcpCiAgICAgICAgc2VsZi5lbmRfaGVhZGVycygpCiAgICAgICAgc2VsZi53ZmlsZS53cml0ZSgnPGh0bWw+PGhlYWQ+PG1ldGEgY2hhcnNldD0idXRmLTgiPjwvaGVhZD48Ym9keT4nKQogICAgICAgIHNlbGYud2ZpbGUud3JpdGUoJzxoMT5BbWF6b24gRWNobyAtIEN1c3RvbSBTa2lsbCBTbG90IFR5cGVzPC9oMT4nKQogICAgICAgIGlmIHNlbGYuc2VydmVyLmFwcGxpYW5jZXMgaXMgbm90IE5vbmU6CiAgICAgICAgICBzZWxmLndmaWxlLndyaXRlKCI8aDI+RU5VTV9ST09NPC9oMj4iKQogICAgICAgICAgcm9vbXMgPSBbXQogICAgICAgICAgZm9yIHJvb20gaW4gc2VsZi5zZXJ2ZXIuYXBwbGlhbmNlczoKICAgICAgICAgICAgcm9vbU5hbWUgPSByb29tLmdldCgncm9vbScpCiAgICAgICAgICAgIGlmIHJvb21OYW1lIGlzIG5vdCBOb25lOgogICAgICAgICAgICAgIHJvb21zLmFwcGVuZChyb29tTmFtZSkKICAgICAgICAgIHJvb21zLnNvcnQoKQogICAgICAgICAgZm9yIHJvb21OYW1lIGluIHJvb21zOgogICAgICAgICAgICBzZWxmLndmaWxlLndyaXRlKHJvb21OYW1lLmVuY29kZSgndXRmLTgnKSkKICAgICAgICAgICAgc2VsZi53ZmlsZS53cml0ZSgiPC9icj4iKQogICAgICAgICAgc2VsZi53ZmlsZS53cml0ZSgiPGgyPkVOVU1fQVBQTElBTkNFPC9oMj4iKQogICAgICAgICAgYXBwbGlhbmNlcyA9IFtdCiAgICAgICAgICBmb3Igcm9vbSBpbiBzZWxmLnNlcnZlci5hcHBsaWFuY2VzOgogICAgICAgICAgICBmb3IgYXBwbGlhbmNlIGluIHJvb20uZ2V0KCdhcHBsaWFuY2VzJyk6CiAgICAgICAgICAgICAgYXBwbGlhbmNlTmFtZSA9IGFwcGxpYW5jZS5nZXQoJ25hbWUnKQogICAgICAgICAgICAgIGlmIGFwcGxpYW5jZU5hbWUgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICBhcHBsaWFuY2VOYW1lID0gYXBwbGlhbmNlTmFtZS5zdHJpcCgpCiAgICAgICAgICAgICAgICBpZiBhcHBsaWFuY2VOYW1lIG5vdCBpbiBhcHBsaWFuY2VzOgogICAgICAgICAgICAgICAgICBhcHBsaWFuY2VzLmFwcGVuZChhcHBsaWFuY2VOYW1lKQogICAgICAgICAgICAgIGFsaWFzZXMgPSBhcHBsaWFuY2UuZ2V0KCdhbGlhc2VzJykKICAgICAgICAgICAgICBpZiBhbGlhc2VzIGlzIG5vdCBOb25lOgogICAgICAgICAgICAgICAgZm9yIGFsaWFzIGluIGFsaWFzZXM6CiAgICAgICAgICAgICAgICAgIGZvciByb29tTmFtZSBpbiByb29tczoKICAgICAgICAgICAgICAgICAgICBpZiBhbGlhcy5zdGFydHN3aXRoKHJvb21OYW1lKToKICAgICAgICAgICAgICAgICAgICAgIGFsaWFzID0gYWxpYXNbbGVuKHJvb21OYW1lKSArIDE6XQogICAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgICAgICBlbGlmIGFsaWFzLmVuZHN3aXRoKHJvb21OYW1lKToKICAgICAgICAgICAgICAgICAgICAgIGFsaWFzID0gYWxpYXNbOmxlbihhbGlhcykgLSBsZW4ocm9vbU5hbWUpXQogICAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgICAgYWxpYXMgPSBhbGlhcy5zdHJpcCgpCiAgICAgICAgICAgICAgICAgIGlmIGFsaWFzIG5vdCBpbiBhcHBsaWFuY2VzOiAKICAgICAgICAgICAgICAgICAgICBhcHBsaWFuY2VzLmFwcGVuZChhbGlhcyk7CiAgICAgICAgICBhcHBsaWFuY2VzLnNvcnQoKQogICAgICAgICAgZm9yIGFwcGxpYW5jZU5hbWUgaW4gYXBwbGlhbmNlczoKICAgICAgICAgICAgc2VsZi53ZmlsZS53cml0ZShhcHBsaWFuY2VOYW1lLmVuY29kZSgndXRmLTgnKSkKICAgICAgICAgICAgc2VsZi53ZmlsZS53cml0ZSgiPC9icj4iKQogICAgICAgIHNlbGYud2ZpbGUud3JpdGUoJzwvZm9ybT48L2JvZHk+PC9odG1sPicpCiAgICAgIGRlZiBfc2VuZEpzb25FcnJvclJlc3BvbnNlKHNlbGYsIG1lc3NhZ2VJZCwgZXJyb3JNZXNzYWdlKToKICAgICAgICByZXNwb25zZU9iamVjdCA9IE5vbmUKICAgICAgICBpZiBzZWxmLmNvbW1hbmQgPT0gJ2NvbnRyb2wnOgogICAgICAgICAgcmVzcG9uc2VPYmplY3QgPSBBbWF6b25FY2hvLkNvbnRyb2xSZXNwb25zZShtZXNzYWdlSWQpCiAgICAgICAgZWxpZiBzZWxmLmNvbW1hbmQgPT0gJ2Rpc2NvdmVyeSc6CiAgICAgICAgICByZXNwb25zZU9iamVjdCA9IEFtYXpvbkVjaG8uRGlzY292ZXJ5UmVzcG9uc2UobWVzc2FnZUlkKQogICAgICAgIGVsc2U6CiAgICAgICAgICBzZWxmLnNlbmRfZXJyb3IoNDA0LCAnTm90IEZvdW5kJykKICAgICAgICAgIHJldHVybgogICAgICAgIHJlc3BvbnNlT2JqZWN0LnNldE5hbWUoZXJyb3JNZXNzYWdlKQogICAgICAgIHNlbGYuX3NlbmRKc29uUmVzcG9uc2UocmVzcG9uc2VPYmplY3QpCiAgICAgIGRlZiBfc2VuZEpzb25SZXNwb25zZShzZWxmLCByZXNwb25zZU9iamVjdCk6CiAgICAgICAgcmVzcCA9IGpzb24uZHVtcHMocmVzcG9uc2VPYmplY3QsIGRlZmF1bHQ9YXNEaWN0LCBlbmNvZGluZz0idXRmLTgiKQogICAgICAgIHNlbGYuc2VuZF9yZXNwb25zZSgyMDApCiAgICAgICAgc2VsZi5zZW5kX2hlYWRlcignQ29udGVudC1UeXBlJywgJ2FwcGxpY2F0aW9uL2pzb247IGNoYXJzZXQ9dXRmLTgnKQogICAgICAgIHNlbGYuZW5kX2hlYWRlcnMoKQogICAgICAgIHNlbGYud2ZpbGUud3JpdGUocmVzcCkKICAgICAgZGVmIF9idWlsZFJlcVBhcmFtTWFwKHNlbGYsIHF1ZXJ5KToKICAgICAgICBpbXBvcnQgdXJsbGliCiAgICAgICAgcmVxX3BhcmFtcyA9IHt9CiAgICAgICAgcGFyYW1zID0gcXVlcnkuc3BsaXQoJyYnKQogICAgICAgIGZvciBwYXJhbSBpbiBwYXJhbXM6CiAgICAgICAgICBpZHggPSBwYXJhbS5maW5kKCc9JykKICAgICAgICAgIHJlcV9wYXJhbXNbcGFyYW1bMDppZHhdXSA9IHVybGxpYi51bnF1b3RlX3BsdXMocGFyYW1baWR4ICsgMTpdKS5kZWNvZGUoJ3V0Zi04JykKICAgICAgICByZXR1cm4gcmVxX3BhcmFtcwogICAgZGVmIGdldFNTTENlcnQoc2VsZiwgaXAsIHBvcnQsIGNlcnRGaWxlbmFtZSk6CiAgICAgIHNlbGYuZGVidWcoImdldFNTTENlcnQoezB9LCB7MX0sIHsyfSkiLCBpcCwgcG9ydCwgY2VydEZpbGVuYW1lKQogICAgICBpZiBzZWxmLkhTOgogICAgICAgIHRyeToKICAgICAgICAgIGltcG9ydCB1cmxsaWIyCiAgICAgICAgICB1cmwgPSAiaHR0cDovL3swfTp7MX0vb3B0L3syfSIuZm9ybWF0KGlwLCBwb3J0LCBjZXJ0RmlsZW5hbWUpCiAgICAgICAgICByZXEgPSB1cmxsaWIyLlJlcXVlc3QodXJsKQogICAgICAgICAgcmVzID0gdXJsbGliMi51cmxvcGVuKHJlcSkKICAgICAgICAgIGlmIHJlcy5nZXRjb2RlKCkgPT0gMjAwOgogICAgICAgICAgICByZXR1cm4gcmVzLmZwLnJlYWQoKQogICAgICAgIGV4Y2VwdDoKICAgICAgICAgIHNlbGYud2FybigiR0VUIFNTTC1DZXJ0aWZpY2F0ZSBmcm9tIFVSTD0nezB9JyBmYWlsZWQuIFdpbGwgdXNpbmcgaHR0cCBpbnN0ZWFkIG9mIGh0dHBzLiIsIHVybCkKICAgICAgZWxzZToKICAgICAgICB3aXRoIG9wZW4oJ2FtYXpvbkVjaG9TU0wuY2VydCcsICdyJykgYXMgbXlmaWxlOgogICAgICAgICAgY2VydFRleHQ9bXlmaWxlLnJlYWQoKQogICAgICAgIHJldHVybiBjZXJ0VGV4dAogICAgICByZXR1cm4gIiIKICAgIGRlZiB3ZWJDYWxsYmFja1NTTENlcnQoc2VsZiwgc3RyZWFtPUZhbHNlKToKICAgICAgaHRtbCA9ICI8aHRtbD48aGVhZD4iCiAgICAgIGh0bWwgKz0gIjxtZXRhIGNoYXJzZXQ9J0lTTy04ODU5LTEnLz4iCiAgICAgIGh0bWwgKz0gIjxtZXRhIGh0dHAtZXF1aXY9J2NhY2hlLWNvbnRyb2wnIGNvbnRlbnQ9J21heC1hZ2U9MCcvPiIKICAgICAgaHRtbCArPSAiPG1ldGEgaHR0cC1lcXVpdj0nY2FjaGUtY29udHJvbCcgY29udGVudD0nbm8tY2FjaGUnLz4iCiAgICAgIGh0bWwgKz0gIjxtZXRhIGh0dHAtZXF1aXY9J2V4cGlyZXMnIGNvbnRlbnQ9JzAnLz4iCiAgICAgIGh0bWwgKz0gIjxtZXRhIGh0dHAtZXF1aXY9J2V4cGlyZXMnIGNvbnRlbnQ9J1R1ZSwgMDEgSmFuIDE5ODAgMTowMDowMCBHTVQnLz4iCiAgICAgIGh0bWwgKz0gIjxtZXRhIGh0dHAtZXF1aXY9J3ByYWdtYScgY29udGVudD0nbm8tY2FjaGUnLz4iCiAgICAgIGh0bWwgKz0gIjwvaGVhZD48Ym9keT4iCiAgICAgIGh0bWwgKz0gIjxoMT5BbWF6b24gRWNobyAtIFNTTCBDZXJ0aWZpY2F0ZTwvaDE+IgogICAgICBodG1sICs9ICI8cHJlPjxjb2RlPiIKICAgICAgaHRtbCArPSBzZWxmLmNlcnRUZXh0CiAgICAgIGh0bWwgKz0gIjwvcHJlPjwvY29kZT4iCiAgICAgIGh0bWwgKz0gIjwvYm9keT48L2h0bWw+IgogICAgICBpZiBzdHJlYW06CiAgICAgICAgICBzdHJlYW0ud3JpdGUoaHRtbCkKICAgICAgc2VsZi5EYXRMZW4gPSBsZW4oaHRtbCkKICAgIGRlZiB3ZWJDYWxsYmFja0xvZyhzZWxmLCBzdHJlYW09RmFsc2UpOgogICAgICBodG1sID0gIjxodG1sPjxoZWFkPiIKICAgICAgaHRtbCArPSAiPG1ldGEgY2hhcnNldD0nSVNPLTg4NTktMScvPiIKICAgICAgaHRtbCArPSAiPG1ldGEgaHR0cC1lcXVpdj0nY2FjaGUtY29udHJvbCcgY29udGVudD0nbWF4LWFnZT0wJy8+IgogICAgICBodG1sICs9ICI8bWV0YSBodHRwLWVxdWl2PSdjYWNoZS1jb250cm9sJyBjb250ZW50PSduby1jYWNoZScvPiIKICAgICAgaHRtbCArPSAiPG1ldGEgaHR0cC1lcXVpdj0nZXhwaXJlcycgY29udGVudD0nMCcvPiIKICAgICAgaHRtbCArPSAiPG1ldGEgaHR0cC1lcXVpdj0nZXhwaXJlcycgY29udGVudD0nVHVlLCAwMSBKYW4gMTk4MCAxOjAwOjAwIEdNVCcvPiIKICAgICAgaHRtbCArPSAiPG1ldGEgaHR0cC1lcXVpdj0ncHJhZ21hJyBjb250ZW50PSduby1jYWNoZScvPiIKICAgICAgaHRtbCArPSAiPC9oZWFkPjxib2R5PiIKICAgICAgaHRtbCArPSAiPGgxPkFtYXpvbiBFY2hvIC0gTG9nPC9oMT4iCiAgICAgIGh0bWwgKz0gIjxiPkxvZ2xldmVsID0gIgogICAgICBpZiBzZWxmLmxvZ0xldmVsID09IDA6CiAgICAgICAgaHRtbCArPSAiMCAoT2ZmKSIKICAgICAgZWxpZiBzZWxmLmxvZ0xldmVsID09IDE6CiAgICAgICAgaHRtbCArPSAiMSAoRXJyb3IpIgogICAgICBlbGlmIHNlbGYubG9nTGV2ZWwgPT0gMjoKICAgICAgICBodG1sICs9ICIyIChXYXJuKSIKICAgICAgZWxpZiBzZWxmLmxvZ0xldmVsID09IDM6CiAgICAgICAgaHRtbCArPSAiMyAoSW5mbykiCiAgICAgIGVsaWYgc2VsZi5sb2dMZXZlbCA9PSA0OgogICAgICAgIGh0bWwgKz0gIjQgKERlYnVnKSIKICAgICAgaHRtbCArPSAiPC9iPiIKICAgICAgaHRtbCArPSAiPHByZT48Y29kZT4iCiAgICAgIHdpdGggb3BlbihzZWxmLkZJTEVQQVRIX0xPRywgJ3InKSBhcyBteWZpbGU6CiAgICAgICAgZGF0YSA9IG15ZmlsZS5yZWFkKCkKICAgICAgaHRtbCArPSBkYXRhCiAgICAgIGh0bWwgKz0gIjwvcHJlPjwvY29kZT4iCiAgICAgIGh0bWwgKz0gIjwvYm9keT48L2h0bWw+IgogICAgICBpZiBzdHJlYW06CiAgICAgICAgICBzdHJlYW0ud3JpdGUoaHRtbCkKICAgICAgc2VsZi5EYXRMZW4gPSBsZW4oaHRtbCkKICAgIGRlZiBpbml0X2RlYnVnX2VudHJ5KHNlbGYpOgogICAgICBwcm90byA9ICJodHRwIgogICAgICBpZiBzZWxmLmNlcnRUZXh0ICE9ICIiOgogICAgICAgIHByb3RvID0gImh0dHBzIgogICAgICBpZCA9ICdBbWF6b25fRWNob19TZXJ2ZXInCiAgICAgIGltcG9ydCB1cmxsaWIKICAgICAgc2VsZi5NQy5EZWJ1Zy5hZGRHcnVwcGUoCiAgICAgICAgW2lkLCBpZF0sCiAgICAgICAgICBbIAogICAgICAgICAgICBbIjBWRVJTSU9OSU5GTyIsIlZlcnNpb24iLDEsJ1YwLjMgLSAoMjAxNy0wMS0xNiAwNDoxNyknXSwKICAgICAgICAgICAgWyIxUE9SVCIsIlBvcnQiLDEsc3RyKHNlbGYucG9ydCldLAogICAgICAgICAgICBbIjJTU0wiLCJTU0wtQ2VydGlmaWNhdGUiLDEsIjxhIGhyZWY9Jy9vcHQvezB9Jz5zaG93PC9hPjxicj4iLmZvcm1hdChzZWxmLlVSTF9TSE9XX1NTTCldLAogICAgICAgICAgICBbIjNMT0ciLCJMb2dmaWxlIiwxLCI8YSBocmVmPScvb3B0L3swfSc+c2hvdzwvYT48YnI+Ii5mb3JtYXQoc2VsZi5VUkxfU0hPV19MT0cpXSwKICAgICAgICAgICAgWyI0Q09ORklHIiwiQXBwbGlhbmNlcyBjb25maWd1cmF0aW9uIiwxLHUiPGEgaHJlZj0nezB9Oi8vezF9OnsyfS9jb25maWc/YWNjZXNzVG9rZW49ezN9Jz5lZGl0PC9hPjxicj4iLmZvcm1hdChwcm90bywgc2VsZi5oc0lwLCBzZWxmLnBvcnQsIHVybGxpYi5xdW90ZV9wbHVzKHNlbGYuYWNjZXNzVG9rZW4uZW5jb2RlKCd1dGYtOCcpKSldLAogICAgICAgICAgICBbIjVTTE9UVFlQRVMiLCJDdXN0b20gU2tpbGwgU2xvdCBUeXBlcyIsMSx1IjxhIGhyZWY9J3swfTovL3sxfTp7Mn0vc2xvdFR5cGVzP2FjY2Vzc1Rva2VuPXszfSc+c2hvdzwvYT48YnI+Ii5mb3JtYXQocHJvdG8sIHNlbGYuaHNJcCwgc2VsZi5wb3J0LCB1cmxsaWIucXVvdGVfcGx1cyhzZWxmLmFjY2Vzc1Rva2VuLmVuY29kZSgndXRmLTgnKSkpXSwKICAgICAgICAgIF0gICAKICAgICAgKQogICAgZGVmIHNldExvZ0xldmVsKHNlbGYsIGxldmVsKToKICAgICAgc2VsZi5sb2dMZXZlbCA9IGxldmVsCiAgICBkZWYgY2xlYXJMb2coc2VsZik6CiAgICAgIHNlbGYubG9nRmlsZS5zZWVrKDApCiAgICAgIHNlbGYubG9nRmlsZS50cnVuY2F0ZSgpCiAgICAgIHNlbGYubG9nKHNlbGYudmVyc2lvbikKICAgIGRlZiBleGMoc2VsZiwgbXNnPSIiKToKICAgICAgaWYgbXNnICE9ICIiOgogICAgICAgIHNlbGYuZXJyb3IobXNnKQogICAgICBpbXBvcnQgdHJhY2ViYWNrCiAgICAgIGV4Y01zZyA9IHRyYWNlYmFjay5mb3JtYXRfZXhjKCkKICAgICAgc2VsZi5lcnJvcihleGNNc2cpCiAgICBkZWYgc2VjdXIoc2VsZiwgbXNnLCAqcGFyYW1zKToKICAgICAgc2VsZi51bmF1dGhvcml6ZWRDb3VudGVyICs9IDEKICAgICAgc2VsZi5zZW5kVG9PdXRwdXQoMSwgc2VsZi51bmF1dGhvcml6ZWRDb3VudGVyKQogICAgICBzZWxmLl9sb2coIlNFQ1VSIiwgbXNnLCAqcGFyYW1zKQogICAgZGVmIGVycm9yKHNlbGYsIG1zZywgKnBhcmFtcyk6CiAgICAgIGlmIHNlbGYubG9nTGV2ZWwgPj0gMToKICAgICAgICBzZWxmLl9sb2coIkVSUk9SIiwgbXNnLCAqcGFyYW1zKQogICAgZGVmIHdhcm4oc2VsZiwgbXNnLCAqcGFyYW1zKToKICAgICAgaWYgc2VsZi5sb2dMZXZlbCA+PSAyOgogICAgICAgIHNlbGYuX2xvZygiV0FSTiAiLCBtc2csICpwYXJhbXMpCiAgICBkZWYgaW5mbyhzZWxmLCBtc2csICpwYXJhbXMpOgogICAgICBpZiBzZWxmLmxvZ0xldmVsID49IDM6CiAgICAgICAgc2VsZi5fbG9nKCJJTkZPICIsIG1zZywgKnBhcmFtcykKICAgIGRlZiBkZWJ1ZyhzZWxmLCBtc2csICpwYXJhbXMpOgogICAgICBpZiBzZWxmLmxvZ0xldmVsID49IDQ6CiAgICAgICAgc2VsZi5fbG9nKCJERUJVRyIsIG1zZywgKnBhcmFtcykKICAgIGRlZiBsb2coc2VsZiwgbXNnLCAqcGFyYW1zKToKICAgICAgc2VsZi5fbG9nKCJTWVMgICIsIG1zZywgKnBhcmFtcykKICAgIGRlZiBfbG9nKHNlbGYsIHByZWZpeCwgbXNnLCAqcGFyYW1zKToKICAgICAgaW1wb3J0IHRpbWUKICAgICAgdGltZXN0YW1wID0gdGltZS5zdHJmdGltZSgiJVktJW0tJWQgJUg6JU06JVMiKQogICAgICBpZiBwYXJhbXMgaXMgbm90IE5vbmUgYW5kIGxlbihwYXJhbXMpID4gMDoKICAgICAgICBtc2cgPSBtc2cuZm9ybWF0KCpwYXJhbXMpCiAgICAgIG1zZyA9IHRpbWVzdGFtcCArICIgfCAiICsgcHJlZml4ICsgIiAiICsgbXNnICsgJ1xuJwogICAgICBzZWxmLmxvZ0ZpbGUud3JpdGUobXNnKQogICAgICBzZWxmLmxvZ0ZpbGUuZmx1c2goKQogICAgZGVmIHNlbmRUb091dHB1dChzZWxmLCBvdXQsIHZhbHVlKToKICAgICAgc2VsZi5kZWJ1Zygic2VuZFRvT3V0cHV0OiB7MH0gPSAnezF9JyIsIHN0cihvdXQpLCBzdHIodmFsdWUpKQogICAgICBpZiBzZWxmLkhTOgogICAgICAgIG91dCAtPSAxICMjIEludGVybiBzdGFydGVuIGRpZSBBdXNn5G5nZSBiZWkgMCB1bmQgbmljaHQgYmVpIDEKICAgICAgICBpZiBzZWxmLmxvZ2lrLlNlbmRJbnRlcnZhbGwgPT0gMCBvciB0aW1lLnRpbWUoKSA+PSBzZWxmLmxvZ2lrLkF1c2dhbmdbb3V0XVswXToKICAgICAgICAgIGZvciBpa28gaW4gc2VsZi5sb2dpay5BdXNnYW5nW291dF1bMV06CiAgICAgICAgICAgIHNlbGYubG9naWsuTUMuVGFnTGlzdC5zZXRXZXJ0KEZMQUdfRUlCX0xPR0lLLCBpa28sIHZhbHVlKQogICAgICAgICAgaWYgdmFsdWU6CiAgICAgICAgICAgIGZvciBjbWQgaW4gc2VsZi5sb2dpay5BdXNnYW5nW291dF1bMl06CiAgICAgICAgICAgICAgY21kLmV4ZWNCZWZlaGwoKQogICAgICAgICAgZm9yIGNvbiBpbiBzZWxmLmxvZ2lrLkF1c2dhbmdbb3V0XVszXToKICAgICAgICAgICAgc2VsZi5sb2dpay5NQy5Mb2dpa0xpc3QuQ29ubmVjdExpc3QuYXBwZW5kKGNvbiArIFsgdmFsdWUgXSkKICAgICAgICAgIGlmIHNlbGYubG9naWsuU2VuZEludGVydmFsbCA+IDA6CiAgICAgICAgICAgIHNlbGYubG9naWsuQXVzZ2FuZ1tvdXRdWzBdID0gdGltZS50aW1lKCkgKyBzZWxmLmxvZ2lrLlNlbmRJbnRlcnZhbGwKICAgICAgICAgIHNlbGYubG9naWsuT3V0V2VydFtvdXRdID0gdmFsdWUKICBnbG9iYWwgQW1hem9uRWNob1dlYkNhbGxiYWNrCiAgY2xhc3MgQW1hem9uRWNob1dlYkNhbGxiYWNrKG9iamVjdCk6CiAgICBkZWYgX19pbml0X18oc2VsZiwgcEl0ZW0sIGFtYXpvbkVjaG8sIGNhbGxiYWNrLCBuYW1lLCB0eXBlPSd0ZXh0L2h0bWwnKToKICAgICAgc2VsZi5sb2dpayA9IHBJdGVtCiAgICAgIHNlbGYuYW1hem9uRWNobyA9IGFtYXpvbkVjaG8KICAgICAgc2VsZi5jYWxsYmFjayA9IGNhbGxiYWNrCiAgICAgIHNlbGYuTUMgPSBwSXRlbS5NQwogICAgICBzZWxmLlVybFBmYWQgPSBuYW1lLnVwcGVyKCkKICAgICAgc2VsZi5EYXROYW1lID0gIk9QVC8lcyIgJSAoc2VsZi5VcmxQZmFkKQogICAgICBzZWxmLkRhdExlbiA9IDAKICAgICAgc2VsZi5UeXAgPSB0eXBlCiAgICAgIHNlbGYuaXNRdWFkID0gMAogICAgICBzZWxmLk1DLkdVSS5FeHREYXRVcmxbc2VsZi5VcmxQZmFkXSA9IHNlbGYKICAgIGRlZiBnZXREYXRlbihzZWxmKToKICAgICAgcmV0dXJuCiAgICBkZWYgZ2V0UXVhZERhdGVuKHNlbGYpOgogICAgICByZXR1cm4gCiAgICBkZWYgZ2V0RGF0ZW5TdHJlYW0oc2VsZiwgc3RyZWFtKToKICAgICAgaW1wb3J0IHRpbWUKICAgICAgc3RyZWFtLnNlZWsoMCkKICAgICAgX2hlYWRlciA9IFsKICAgICAgICAgICJIVFRQLzEuMCAyMDAgT0siLAogICAgICAgICAgIlByYWdtYTogbm8tY2FjaGUiLAogICAgICAgICAgIkNhY2hlLUNvbnRyb2w6ICBtYXgtYWdlPTAsIG5vLXN0b3JlLCBuby1jYWNoZSwgbXVzdC1yZXZhbGlkYXRlIiwKICAgICAgICAgICJMYXN0LU1vZGlmaWVkOiAiICsgdGltZS5zdHJmdGltZSgiJWEsICVkICVtICVZICVIOiVNOiVTIEdNVCIsdGltZS5nbXRpbWUoKSksCiAgICAgICAgICAiQ29ubmVjdGlvbjogY2xvc2UiLAogICAgICAgICAgIkNvbnRlbnQtVHlwZTogIiArIHNlbGYuVHlwICsgIjsgY2hhcnNldD1JU08tODg1OS0xIiwKICAgICAgXQogICAgICBzdHJlYW0ud3JpdGUoIlxuIi5qb2luKF9oZWFkZXIpICsgIlxuXG4iKQogICAgICBzZWxmLkRhdExlbiA9IHNlbGYuY2FsbGJhY2soc3RyZWFtKQogICAgZGVmIGdldFF1YWREYXRlblN0cmVhbShzZWxmLCBzdHJlYW0pOgogICAgICBzZWxmLmFtYXpvbkVjaG8ud2FybigiQW1hem9uRWNob1dlYkNhbGxiYWNrICh7MH0pOiB1bmV4cGVjdGVkIGNhbGwgb2YgZ2V0UXVhZERhdGVuU3RyZWFtKCkuIiwgbmFtZSkKICAgICAgcmV0dXJuCg=='),'<13626_Amazon Echo (13626)>','exec'))"|""|0|0|0|0
## MD5 der Formelzeile: 19fc0dddff5820f27e22e859400183dc
### Klasse AmazonEcho
################################
## Quelltext nicht Öffentlich ##
################################




#5012|abbruch bei bed. (0/1)|bedingung|formel|zeit|pin-ausgang|pin-offset|pin-speicher|pin-neg.ausgang
## Klasse auf SN1 
5012|0|"EI"|"AmazonEcho(locals())"|"AmazonEcho.DELAY"|0|1|1|0
5012|0|"OC[1]"|"SN[1].init()"|""|0|0|0|0
5012|0|"EC[1] and EN[1]"|"SN[1].start()"|""|0|0|0|0
5012|0|"EC[1] and not EN[1]"|"SN[1].stop()"|""|0|0|0|0
5012|0|"EC[4]"|"SN[1].setLogLevel(EN[4])"|""|0|0|0|0
5012|0|"EC[5] and EN[5]"|"SN[1].clearLog()"|""|0|0|0|0



